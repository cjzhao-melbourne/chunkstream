var MP4Box=(()=>{var pt=Object.defineProperty;var Ro=Object.getOwnPropertyDescriptor;var Oo=Object.getOwnPropertyNames,go=Object.getOwnPropertySymbols;var So=Object.prototype.hasOwnProperty,Ho=Object.prototype.propertyIsEnumerable;var Bo=n=>{throw TypeError(n)};var yo=(n,t,e)=>t in n?pt(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e,Je=(n,t)=>{for(var e in t||(t={}))So.call(t,e)&&yo(n,e,t[e]);if(go)for(var e of go(t))Ho.call(t,e)&&yo(n,e,t[e]);return n};var Xn=(n,t)=>{for(var e in t)pt(n,e,{get:t[e],enumerable:!0})},Vo=(n,t,e,i)=>{if(t&&typeof t=="object"||typeof t=="function")for(let r of Oo(t))!So.call(n,r)&&r!==e&&pt(n,r,{get:()=>t[r],enumerable:!(i=Ro(t,r))||i.enumerable});return n};var Go=n=>Vo(pt({},"__esModule",{value:!0}),n);var Zn=(n,t,e)=>t.has(n)||Bo("Cannot "+e);var Uo=(n,t,e)=>(Zn(n,t,"read from private field"),e?e.call(n):t.get(n)),ht=(n,t,e)=>t.has(n)?Bo("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(n):t.set(n,e),wo=(n,t,e,i)=>(Zn(n,t,"write to private field"),i?i.call(n,e):t.set(n,e),e),Qn=(n,t,e)=>(Zn(n,t,"access private method"),e);var ta={};Xn(ta,{AudioSampleEntry:()=>E,Box:()=>c,BoxParser:()=>ea,DIFF_BOXES_PROP_NAMES:()=>yt,DIFF_PRIMITIVE_ARRAY_PROP_NAMES:()=>Eo,DataStream:()=>A,Descriptor:()=>$,ES_Descriptor:()=>ut,Endianness:()=>zo,FullBox:()=>l,HintSampleEntry:()=>_e,ISOFile:()=>dt,Log:()=>u,MP4BoxBuffer:()=>L,MPEG4DescriptorParser:()=>dr,MetadataSampleEntry:()=>O,MultiBufferStream:()=>V,SampleEntry:()=>R,SampleGroupEntry:()=>x,SampleGroupInfo:()=>Qe,SingleItemTypeReferenceBox:()=>it,SingleItemTypeReferenceBoxLarge:()=>rt,SubtitleSampleEntry:()=>N,SystemSampleEntry:()=>Q,TX3GParser:()=>mo,TextSampleEntry:()=>at,Textin4Parser:()=>co,TrackGroupTypeBox:()=>tt,TrackReferenceTypeBox:()=>st,VTTin4Parser:()=>lo,VisualSampleEntry:()=>U,XMLSubtitlein4Parser:()=>uo,boxEqual:()=>St,boxEqualFields:()=>Do,createFile:()=>ro,loadMoovOnly:()=>Qo});var _t=Math.pow(2,32),w=Math.pow(2,32)-1,vo=1,Ao=2,Mo=4,de=1,ue=2,ce=8,me=16,pe=32;var Jn=131072,ie=1,he=4,re=256,se=512,ne=1024,oe=2048,bt=-1,K=0,v=1;var L=class n extends ArrayBuffer{constructor(t){super(t),this.fileStart=0,this.usedBytes=0}static fromArrayBuffer(t,e){let i=new n(t.byteLength);return new Uint8Array(i).set(new Uint8Array(t)),i.fileStart=e,i}};var zo=(e=>(e[e.BIG_ENDIAN=1]="BIG_ENDIAN",e[e.LITTLE_ENDIAN=2]="LITTLE_ENDIAN",e))(zo||{}),et,eo,B=class B{constructor(t,e,i){ht(this,et);this._byteLength=0;this.failurePosition=0;this._dynamicSize=1;this._byteOffset=e||0,t instanceof ArrayBuffer?this.buffer=L.fromArrayBuffer(t,0):t instanceof DataView?(this.dataView=t,e&&(this._byteOffset+=e)):this.buffer=new L(t||0),this.position=0,this.endianness=i||1}getPosition(){return this.position}_realloc(t){if(!this._dynamicSize)return;let e=this._byteOffset+this.position+t,i=this._buffer.byteLength;if(e<=i){e>this._byteLength&&(this._byteLength=e);return}for(i<1&&(i=1);e>i;)i*=2;let r=new L(i),s=new Uint8Array(this._buffer);new Uint8Array(r,0,s.length).set(s),this.buffer=r,this._byteLength=e}_trimAlloc(){if(this._byteLength===this._buffer.byteLength)return;let t=new L(this._byteLength),e=new Uint8Array(t),i=new Uint8Array(this._buffer,0,e.length);e.set(i),this.buffer=t}get byteLength(){return this._byteLength-this._byteOffset}get buffer(){return this._trimAlloc(),this._buffer}set buffer(t){this._buffer=t,this._dataView=new DataView(t,this._byteOffset),this._byteLength=t.byteLength}get byteOffset(){return this._byteOffset}set byteOffset(t){this._byteOffset=t,this._dataView=new DataView(this._buffer,this._byteOffset),this._byteLength=this._buffer.byteLength}get dataView(){return this._dataView}set dataView(t){this._byteOffset=t.byteOffset,this._buffer=L.fromArrayBuffer(t.buffer,0),this._dataView=new DataView(this._buffer,this._byteOffset),this._byteLength=this._byteOffset+t.byteLength}seek(t){let e=Math.max(0,Math.min(this.byteLength,t));this.position=isNaN(e)||!isFinite(e)?0:e}isEof(){return this.position>=this._byteLength}mapUint8Array(t){this._realloc(t*1);let e=new Uint8Array(this._buffer,this.byteOffset+this.position,t);return this.position+=t*1,e}readInt32Array(t,e){t=t===void 0?this.byteLength-this.position/4:t;let i=new Int32Array(t);return B.memcpy(i.buffer,0,this.buffer,this.byteOffset+this.position,t*i.BYTES_PER_ELEMENT),B.arrayToNative(i,e!=null?e:this.endianness),this.position+=i.byteLength,i}readInt16Array(t,e){t=t===void 0?this.byteLength-this.position/2:t;let i=new Int16Array(t);return B.memcpy(i.buffer,0,this.buffer,this.byteOffset+this.position,t*i.BYTES_PER_ELEMENT),B.arrayToNative(i,e!=null?e:this.endianness),this.position+=i.byteLength,i}readInt8Array(t){t=t===void 0?this.byteLength-this.position:t;let e=new Int8Array(t);return B.memcpy(e.buffer,0,this.buffer,this.byteOffset+this.position,t*e.BYTES_PER_ELEMENT),this.position+=e.byteLength,e}readUint32Array(t,e){t=t===void 0?this.byteLength-this.position/4:t;let i=new Uint32Array(t);return B.memcpy(i.buffer,0,this.buffer,this.byteOffset+this.position,t*i.BYTES_PER_ELEMENT),B.arrayToNative(i,e!=null?e:this.endianness),this.position+=i.byteLength,i}readUint16Array(t,e){t=t===void 0?this.byteLength-this.position/2:t;let i=new Uint16Array(t);return B.memcpy(i.buffer,0,this.buffer,this.byteOffset+this.position,t*i.BYTES_PER_ELEMENT),B.arrayToNative(i,e!=null?e:this.endianness),this.position+=i.byteLength,i}readUint8Array(t){t=t===void 0?this.byteLength-this.position:t;let e=new Uint8Array(t);return B.memcpy(e.buffer,0,this.buffer,this.byteOffset+this.position,t*e.BYTES_PER_ELEMENT),this.position+=e.byteLength,e}readFloat64Array(t,e){t=t===void 0?this.byteLength-this.position/8:t;let i=new Float64Array(t);return B.memcpy(i.buffer,0,this.buffer,this.byteOffset+this.position,t*i.BYTES_PER_ELEMENT),B.arrayToNative(i,e!=null?e:this.endianness),this.position+=i.byteLength,i}readFloat32Array(t,e){t=t===void 0?this.byteLength-this.position/4:t;let i=new Float32Array(t);return B.memcpy(i.buffer,0,this.buffer,this.byteOffset+this.position,t*i.BYTES_PER_ELEMENT),B.arrayToNative(i,e!=null?e:this.endianness),this.position+=i.byteLength,i}readInt32(t){let e=this._dataView.getInt32(this.position,(t!=null?t:this.endianness)===2);return this.position+=4,e}readInt16(t){let e=this._dataView.getInt16(this.position,(t!=null?t:this.endianness)===2);return this.position+=2,e}readInt8(){let t=this._dataView.getInt8(this.position);return this.position+=1,t}readUint32(t){let e=this._dataView.getUint32(this.position,(t!=null?t:this.endianness)===2);return this.position+=4,e}readUint16(t){let e=this._dataView.getUint16(this.position,(t!=null?t:this.endianness)===2);return this.position+=2,e}readUint8(){let t=this._dataView.getUint8(this.position);return this.position+=1,t}readFloat32(t){let e=this._dataView.getFloat32(this.position,(t!=null?t:this.endianness)===2);return this.position+=4,e}readFloat64(t){let e=this._dataView.getFloat64(this.position,(t!=null?t:this.endianness)===2);return this.position+=8,e}static memcpy(t,e,i,r,s){let o=new Uint8Array(t,e,s),a=new Uint8Array(i,r,s);o.set(a)}static arrayToNative(t,e){return e===B.ENDIANNESS?t:this.flipArrayEndianness(t)}static nativeToEndian(t,e){return e&&B.ENDIANNESS===2?t:this.flipArrayEndianness(t)}static flipArrayEndianness(t){let e=new Uint8Array(t.buffer,t.byteOffset,t.byteLength);for(let i=0;i<t.byteLength;i+=t.BYTES_PER_ELEMENT)for(let r=i+t.BYTES_PER_ELEMENT-1,s=i;r>s;r--,s++){let o=e[s];e[s]=e[r],e[r]=o}return t}readString(t,e){return e===void 0||e==="ASCII"?Io(this.mapUint8Array(t===void 0?this.byteLength-this.position:t)):new TextDecoder(e).decode(this.mapUint8Array(t))}readCString(t){let e=0,i=this.byteLength-this.position,r=new Uint8Array(this._buffer,this._byteOffset+this.position),s=t!==void 0?Math.min(t,i):i;for(;e<s&&r[e]!==0;e++);let o=Io(this.mapUint8Array(e));return t!==void 0?this.position+=s-e:e!==i&&(this.position+=1),o}readInt64(){return this.readInt32()*_t+this.readUint32()}readUint64(){return this.readUint32()*_t+this.readUint32()}readUint24(){return(this.readUint8()<<16)+(this.readUint8()<<8)+this.readUint8()}save(t){let e=new Blob([this.buffer]);if(typeof window!="undefined"&&typeof document!="undefined")if(window.URL&&URL.createObjectURL){let i=window.URL.createObjectURL(e),r=document.createElement("a");document.body.appendChild(r),r.setAttribute("href",i),r.setAttribute("download",t),r.setAttribute("target","_self"),r.click(),window.URL.revokeObjectURL(i),document.body.removeChild(r)}else throw new Error("DataStream.save: Can't create object URL.");return e}get dynamicSize(){return this._dynamicSize}set dynamicSize(t){t||this._trimAlloc(),this._dynamicSize=t}shift(t){let e=new L(this._byteLength-t),i=new Uint8Array(e),r=new Uint8Array(this._buffer,t,i.length);i.set(r),this.buffer=e,this.position-=t}writeInt32Array(t,e){if(this._realloc(t.length*4),t instanceof Int32Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)B.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapInt32Array(t.length,e);else for(let i=0;i<t.length;i++)this.writeInt32(t[i],e)}writeInt16Array(t,e){if(this._realloc(t.length*2),t instanceof Int16Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)B.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapInt16Array(t.length,e);else for(let i=0;i<t.length;i++)this.writeInt16(t[i],e)}writeInt8Array(t){if(this._realloc(t.length*1),t instanceof Int8Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)B.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapInt8Array(t.length);else for(let e=0;e<t.length;e++)this.writeInt8(t[e])}writeUint32Array(t,e){if(this._realloc(t.length*4),t instanceof Uint32Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)B.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapUint32Array(t.length,e);else for(let i=0;i<t.length;i++)this.writeUint32(t[i],e)}writeUint16Array(t,e){if(this._realloc(t.length*2),t instanceof Uint16Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)B.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapUint16Array(t.length,e);else for(let i=0;i<t.length;i++)this.writeUint16(t[i],e)}writeUint8Array(t){if(this._realloc(t.length*1),t instanceof Uint8Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)B.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapUint8Array(t.length);else for(let e=0;e<t.length;e++)this.writeUint8(t[e])}writeFloat64Array(t,e){if(this._realloc(t.length*8),t instanceof Float64Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)B.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapFloat64Array(t.length,e);else for(let i=0;i<t.length;i++)this.writeFloat64(t[i],e)}writeFloat32Array(t,e){if(this._realloc(t.length*4),t instanceof Float32Array&&this.byteOffset+this.position%t.BYTES_PER_ELEMENT===0)B.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,0,t.byteLength),this.mapFloat32Array(t.length,e);else for(let i=0;i<t.length;i++)this.writeFloat32(t[i],e)}writeInt64(t,e){this._realloc(8),this._dataView.setBigInt64(this.position,BigInt(t),(e!=null?e:this.endianness)===2),this.position+=8}writeInt32(t,e){this._realloc(4),this._dataView.setInt32(this.position,t,(e!=null?e:this.endianness)===2),this.position+=4}writeInt16(t,e){this._realloc(2),this._dataView.setInt16(this.position,t,(e!=null?e:this.endianness)===2),this.position+=2}writeInt8(t){this._realloc(1),this._dataView.setInt8(this.position,t),this.position+=1}writeUint32(t,e){this._realloc(4),this._dataView.setUint32(this.position,t,(e!=null?e:this.endianness)===2),this.position+=4}writeUint16(t,e){this._realloc(2),this._dataView.setUint16(this.position,t,(e!=null?e:this.endianness)===2),this.position+=2}writeUint8(t){this._realloc(1),this._dataView.setUint8(this.position,t),this.position+=1}writeFloat32(t,e){this._realloc(4),this._dataView.setFloat32(this.position,t,(e!=null?e:this.endianness)===2),this.position+=4}writeFloat64(t,e){this._realloc(8),this._dataView.setFloat64(this.position,t,(e!=null?e:this.endianness)===2),this.position+=8}writeUCS2String(t,e,i){i===void 0&&(i=t.length);let r;for(r=0;r<t.length&&r<i;r++)this.writeUint16(t.charCodeAt(r),e);for(;r<i;r++)this.writeUint16(0)}writeString(t,e,i){let r=0;if(e===void 0||e==="ASCII")if(i!==void 0){let s=Math.min(t.length,i);for(r=0;r<s;r++)this.writeUint8(t.charCodeAt(r));for(;r<i;r++)this.writeUint8(0)}else for(r=0;r<t.length;r++)this.writeUint8(t.charCodeAt(r));else this.writeUint8Array(new TextEncoder(e).encode(t.substring(0,i)))}writeCString(t,e){let i=0;if(e!==void 0){let r=Math.min(t.length,e);for(i=0;i<r;i++)this.writeUint8(t.charCodeAt(i));for(;i<e;i++)this.writeUint8(0)}else{for(i=0;i<t.length;i++)this.writeUint8(t.charCodeAt(i));this.writeUint8(0)}}writeStruct(t,e){for(let i=0;i<t.length;i++){let[r,s]=t[i],o=e[r];this.writeType(s,o,e)}}writeType(t,e,i){if(typeof t=="function")return t(this,e);if(typeof t=="object"&&!(t instanceof Array))return t.set(this,e,i);let r,s="ASCII",o=this.position,a=t;if(typeof t=="string"&&/:/.test(t)){let f=t.split(":");a=f[0],r=parseInt(f[1])}if(typeof a=="string"&&/,/.test(a)){let f=a.split(",");a=f[0],s=f[1]}switch(a){case"uint8":this.writeUint8(e);break;case"int8":this.writeInt8(e);break;case"uint16":this.writeUint16(e,this.endianness);break;case"int16":this.writeInt16(e,this.endianness);break;case"uint32":this.writeUint32(e,this.endianness);break;case"int32":this.writeInt32(e,this.endianness);break;case"float32":this.writeFloat32(e,this.endianness);break;case"float64":this.writeFloat64(e,this.endianness);break;case"uint16be":this.writeUint16(e,1);break;case"int16be":this.writeInt16(e,1);break;case"uint32be":this.writeUint32(e,1);break;case"int32be":this.writeInt32(e,1);break;case"float32be":this.writeFloat32(e,1);break;case"float64be":this.writeFloat64(e,1);break;case"uint16le":this.writeUint16(e,2);break;case"int16le":this.writeInt16(e,2);break;case"uint32le":this.writeUint32(e,2);break;case"int32le":this.writeInt32(e,2);break;case"float32le":this.writeFloat32(e,2);break;case"float64le":this.writeFloat64(e,2);break;case"cstring":this.writeCString(e,r);break;case"string":this.writeString(e,s,r);break;case"u16string":this.writeUCS2String(e,this.endianness,r);break;case"u16stringle":this.writeUCS2String(e,2,r);break;case"u16stringbe":this.writeUCS2String(e,1,r);break;default:if(Qn(this,et,eo).call(this,a)){let[,f]=a;for(let d=0;d<e.length;d++)this.writeType(f,e[d]);break}else{this.writeStruct(a,e);break}}r&&(this.position=o,this._realloc(r),this.position=o+r)}writeUint64(t){let e=Math.floor(t/_t);this.writeUint32(e),this.writeUint32(t&4294967295)}writeUint24(t){this.writeUint8((t&16711680)>>16),this.writeUint8((t&65280)>>8),this.writeUint8(t&255)}adjustUint32(t,e){let i=this.position;this.seek(t),this.writeUint32(e),this.seek(i)}readStruct(t){let e={},i=this.position;for(let r=0;r<t.length;r+=1){let s=t[r][1],o=this.readType(s,e);if(!o){this.failurePosition===0&&(this.failurePosition=this.position),this.position=i;return}e[t[r][0]]=o}return e}readUCS2String(t,e){return String.fromCharCode.apply(void 0,this.readUint16Array(t,e))}readType(t,e){if(typeof t=="function")return t(this,e);if(typeof t=="object"&&!(t instanceof Array))return t.get(this,e);if(t instanceof Array&&t.length!==3)return this.readStruct(t);let i,r,s="ASCII",o=this.position,a=t;if(typeof a=="string"&&/:/.test(a)){let f=a.split(":");a=f[0],r=parseInt(f[1])}if(typeof a=="string"&&/,/.test(a)){let f=a.split(",");a=f[0],s=f[1]}switch(a){case"uint8":i=this.readUint8();break;case"int8":i=this.readInt8();break;case"uint16":i=this.readUint16(this.endianness);break;case"int16":i=this.readInt16(this.endianness);break;case"uint32":i=this.readUint32(this.endianness);break;case"int32":i=this.readInt32(this.endianness);break;case"float32":i=this.readFloat32(this.endianness);break;case"float64":i=this.readFloat64(this.endianness);break;case"uint16be":i=this.readUint16(1);break;case"int16be":i=this.readInt16(1);break;case"uint32be":i=this.readUint32(1);break;case"int32be":i=this.readInt32(1);break;case"float32be":i=this.readFloat32(1);break;case"float64be":i=this.readFloat64(1);break;case"uint16le":i=this.readUint16(2);break;case"int16le":i=this.readInt16(2);break;case"uint32le":i=this.readUint32(2);break;case"int32le":i=this.readInt32(2);break;case"float32le":i=this.readFloat32(2);break;case"float64le":i=this.readFloat64(2);break;case"cstring":i=this.readCString(r);break;case"string":i=this.readString(r,s);break;case"u16string":i=this.readUCS2String(r,this.endianness);break;case"u16stringle":i=this.readUCS2String(r,2);break;case"u16stringbe":i=this.readUCS2String(r,1);break;default:if(Qn(this,et,eo).call(this,a)){let[,f,d]=a,m=typeof d=="function"?d(e,this,a):typeof d=="string"&&e[d]!==void 0?parseInt(e[d]):typeof d=="number"?d:d==="*"?void 0:parseInt(d);if(typeof f=="string"){let p=f.replace(/(le|be)$/,""),h;switch(/le$/.test(f)?h=2:/be$/.test(f)&&(h=1),p){case"uint8":i=this.readUint8Array(m);break;case"uint16":i=this.readUint16Array(m,h);break;case"uint32":i=this.readUint32Array(m,h);break;case"int8":i=this.readInt8Array(m);break;case"int16":i=this.readInt16Array(m,h);break;case"int32":i=this.readInt32Array(m,h);break;case"float32":i=this.readFloat32Array(m,h);break;case"float64":i=this.readFloat64Array(m,h);break;case"cstring":case"utf16string":case"string":if(m){i=new Array(m);for(let _=0;_<m;_++)i[_]=this.readType(f,e)}else for(i=[];!this.isEof();){let _=this.readType(f,e);if(!_)break;i.push(_)}break}}else if(m){i=new Array(m);for(let p=0;p<m;p++){let h=this.readType(f,e);if(!h)return;i[p]=h}}else for(i=[];;){let p=this.position;try{let h=this.readType(f,e);if(!h){this.position=p;break}i.push(h)}catch(h){this.position=p;break}}break}}return r&&(this.position=o+r),i}mapInt32Array(t,e){this._realloc(t*4);let i=new Int32Array(this._buffer,this.byteOffset+this.position,t);return B.arrayToNative(i,e!=null?e:this.endianness),this.position+=t*4,i}mapInt16Array(t,e){this._realloc(t*2);let i=new Int16Array(this._buffer,this.byteOffset+this.position,t);return B.arrayToNative(i,e!=null?e:this.endianness),this.position+=t*2,i}mapInt8Array(t,e){this._realloc(t*1);let i=new Int8Array(this._buffer,this.byteOffset+this.position,t);return this.position+=t*1,i}mapUint32Array(t,e){this._realloc(t*4);let i=new Uint32Array(this._buffer,this.byteOffset+this.position,t);return B.arrayToNative(i,e!=null?e:this.endianness),this.position+=t*4,i}mapUint16Array(t,e){this._realloc(t*2);let i=new Uint16Array(this._buffer,this.byteOffset+this.position,t);return B.arrayToNative(i,e!=null?e:this.endianness),this.position+=t*2,i}mapFloat64Array(t,e){this._realloc(t*8);let i=new Float64Array(this._buffer,this.byteOffset+this.position,t);return B.arrayToNative(i,e!=null?e:this.endianness),this.position+=t*8,i}mapFloat32Array(t,e){this._realloc(t*4);let i=new Float32Array(this._buffer,this.byteOffset+this.position,t);return B.arrayToNative(i,e!=null?e:this.endianness),this.position+=t*4,i}};et=new WeakSet,eo=function(t){return Array.isArray(t)&&t.length===3&&t[0]==="[]"},B.ENDIANNESS=new Int8Array(new Int16Array([1]).buffer)[0]>0?2:1;var A=B;function Io(n){let t=[];for(let e=0;e<n.length;e++)t[e]=n[e];return String.fromCharCode.apply(void 0,t)}var xt=new Date,gt=4,To=3,ko=2,Fo=1,Y=gt,u={setLogLevel(n){n===this.debug?Y=Fo:n===this.info?Y=ko:n===this.warn?Y=To:(this.error,Y=gt)},debug(n,t){console.debug===void 0&&(console.debug=console.log),Fo>=Y&&console.debug("["+u.getDurationString(new Date().getTime()-xt.getTime(),1e3)+"]","["+n+"]",t)},log(n,t){this.debug(n.msg)},info(n,t){ko>=Y&&console.info("["+u.getDurationString(new Date().getTime()-xt.getTime(),1e3)+"]","["+n+"]",t)},warn(n,t){To>=Y&&console.warn("["+u.getDurationString(new Date().getTime()-xt.getTime(),1e3)+"]","["+n+"]",t)},error(n,t,e){e!=null&&e.onError?e.onError(n,t):gt>=Y&&console.error("["+u.getDurationString(new Date().getTime()-xt.getTime(),1e3)+"]","["+n+"]",t)},getDurationString(n,t){let e;function i(d,m){let h=(""+d).split(".");for(;h[0].length<m;)h[0]="0"+h[0];return h.join(".")}n<0?(e=!0,n=-n):e=!1;let s=n/(t||1),o=Math.floor(s/3600);s-=o*3600;let a=Math.floor(s/60);s-=a*60;let f=s*1e3;return s=Math.floor(s),f-=s*1e3,f=Math.floor(f),(e?"-":"")+o+":"+i(a,2)+":"+i(s,2)+"."+i(f,3)},printRanges(n){let t=n.length;if(t>0){let e="";for(let i=0;i<t;i++)i>0&&(e+=","),e+="["+u.getDurationString(n.start(i))+","+u.getDurationString(n.end(i))+"]";return e}else return"(empty)"}};function jo(n,t){u.debug("ArrayBuffer","Trying to create a new buffer of size: "+(n.byteLength+t.byteLength));let e=new Uint8Array(n.byteLength+t.byteLength);return e.set(new Uint8Array(n),0),e.set(new Uint8Array(t),n.byteLength),e.buffer}var V=class extends A{constructor(t){super(new ArrayBuffer,0),this.buffers=[],this.bufferIndex=-1,t&&(this.insertBuffer(t),this.bufferIndex=0)}initialized(){if(this.bufferIndex>-1)return!0;if(this.buffers.length>0){let t=this.buffers[0];return t.fileStart===0?(this.buffer=t,this.bufferIndex=0,u.debug("MultiBufferStream","Stream ready for parsing"),!0):(u.warn("MultiBufferStream","The first buffer should have a fileStart of 0"),this.logBufferLevel(),!1)}else return u.warn("MultiBufferStream","No buffer to start parsing from"),this.logBufferLevel(),!1}reduceBuffer(t,e,i){let r=new Uint8Array(i);return r.set(new Uint8Array(t,e,i)),r.buffer.fileStart=t.fileStart+e,r.buffer.usedBytes=0,r.buffer}insertBuffer(t){let e=!0,i=0;for(;i<this.buffers.length;i++){let r=this.buffers[i];if(t.fileStart<=r.fileStart){if(t.fileStart===r.fileStart)if(t.byteLength>r.byteLength){this.buffers.splice(i,1),i--;continue}else u.warn("MultiBufferStream","Buffer (fileStart: "+t.fileStart+" - Length: "+t.byteLength+") already appended, ignoring");else t.fileStart+t.byteLength<=r.fileStart||(t=this.reduceBuffer(t,0,r.fileStart-t.fileStart)),u.debug("MultiBufferStream","Appending new buffer (fileStart: "+t.fileStart+" - Length: "+t.byteLength+")"),this.buffers.splice(i,0,t),i===0&&(this.buffer=t);e=!1;break}else if(t.fileStart<r.fileStart+r.byteLength){let s=r.fileStart+r.byteLength-t.fileStart,o=t.byteLength-s;if(o>0)t=this.reduceBuffer(t,s,o);else{e=!1;break}}}e&&(u.debug("MultiBufferStream","Appending new buffer (fileStart: "+t.fileStart+" - Length: "+t.byteLength+")"),this.buffers.push(t),i===0&&(this.buffer=t))}logBufferLevel(t){let e=[],i="",r,s=0,o=0;for(let f=0;f<this.buffers.length;f++){let d=this.buffers[f];f===0?(r={start:d.fileStart,end:d.fileStart+d.byteLength},e.push(r),i+="["+r.start+"-"):r.end===d.fileStart?r.end=d.fileStart+d.byteLength:(r={start:d.fileStart,end:d.fileStart+d.byteLength},i+=e[e.length-1].end-1+"], ["+r.start+"-",e.push(r)),s+=d.usedBytes,o+=d.byteLength}e.length>0&&(i+=r.end-1+"]");let a=t?u.info:u.debug;this.buffers.length===0?a("MultiBufferStream","No more buffer in memory"):a("MultiBufferStream",""+this.buffers.length+" stored buffer(s) ("+s+"/"+o+" bytes), continuous ranges: "+i)}cleanBuffers(){for(let t=0;t<this.buffers.length;t++){let e=this.buffers[t];e.usedBytes===e.byteLength&&(u.debug("MultiBufferStream","Removing buffer #"+t),this.buffers.splice(t,1),t--)}}mergeNextBuffer(){if(this.bufferIndex+1<this.buffers.length){let t=this.buffers[this.bufferIndex+1];if(t.fileStart===this.buffer.fileStart+this.buffer.byteLength){let e=this.buffer.byteLength,i=this.buffer.usedBytes,r=this.buffer.fileStart;return this.buffers[this.bufferIndex]=jo(this.buffer,t),this.buffer=this.buffers[this.bufferIndex],this.buffers.splice(this.bufferIndex+1,1),this.buffer.usedBytes=i,this.buffer.fileStart=r,u.debug("ISOFile","Concatenating buffer for box parsing (length: "+e+"->"+this.buffer.byteLength+")"),!0}else return!1}else return!1}findPosition(t,e,i){let r=-1,s=t===!0?0:this.bufferIndex;for(;s<this.buffers.length;){let a=this.buffers[s];if(a&&a.fileStart<=e)r=s,i&&(a.fileStart+a.byteLength<=e?a.usedBytes=a.byteLength:a.usedBytes=e-a.fileStart,this.logBufferLevel());else break;s++}if(r===-1)return-1;let o=this.buffers[r];return o.fileStart+o.byteLength>=e?(u.debug("MultiBufferStream","Found position in existing buffer #"+r),r):-1}findEndContiguousBuf(t){let e=t!==void 0?t:this.bufferIndex,i=this.buffers[e];if(this.buffers.length>e+1)for(let r=e+1;r<this.buffers.length;r++){let s=this.buffers[r];if(s.fileStart===i.fileStart+i.byteLength)i=s;else break}return i.fileStart+i.byteLength}getEndFilePositionAfter(t){let e=this.findPosition(!0,t,!1);return e!==-1?this.findEndContiguousBuf(e):t}addUsedBytes(t){this.buffer.usedBytes+=t,this.logBufferLevel()}setAllUsedBytes(){this.buffer.usedBytes=this.buffer.byteLength,this.logBufferLevel()}seek(t,e,i){let r=this.findPosition(e,t,i);return r!==-1?(this.buffer=this.buffers[r],this.bufferIndex=r,this.position=t-this.buffer.fileStart,u.debug("MultiBufferStream","Repositioning parser at buffer position: "+this.position),!0):(u.debug("MultiBufferStream","Position "+t+" not found in buffered data"),!1)}getPosition(){return this.bufferIndex===-1||this.buffers[this.bufferIndex]===void 0?0:this.buffers[this.bufferIndex].fileStart+this.position}getLength(){return this.byteLength}getEndPosition(){return this.bufferIndex===-1||this.buffers[this.bufferIndex]===void 0?0:this.buffers[this.bufferIndex].fileStart+this.byteLength}getAbsoluteEndPosition(){if(this.buffers.length===0)return 0;let t=this.buffers[this.buffers.length-1];return t.fileStart+t.byteLength}};var nt,c=class{constructor(t=0){this.size=t;ht(this,nt)}get type(){var t;return(t=this.constructor.fourcc)!=null?t:Uo(this,nt)}set type(t){wo(this,nt,t)}addBox(t){return this.boxes||(this.boxes=[]),this.boxes.push(t),this[t.type+"s"]?this[t.type+"s"].push(t):this[t.type]=t,t}set(t,e){return this[t]=e,this}addEntry(t,e){let i=e||"entries";return this[i]||(this[i]=[]),this[i].push(t),this}writeHeader(t,e){if(this.size+=8,(this.size>w||this.original_size===1)&&(this.size+=8),this.type==="uuid"&&(this.size+=16),u.debug("BoxWriter","Writing box "+this.type+" of size: "+this.size+" at position "+t.getPosition()+(e||"")),this.original_size===0?t.writeUint32(0):this.size>w||this.original_size===1?t.writeUint32(1):(this.sizePosition=t.getPosition(),t.writeUint32(this.size)),t.writeString(this.type,void 0,4),this.type==="uuid"){let i=new Uint8Array(16);for(let r=0;r<16;r++)i[r]=parseInt(this.uuid.substring(r*2,r*2+2),16);t.writeUint8Array(i)}(this.size>w||this.original_size===1)&&(this.sizePosition=t.getPosition(),t.writeUint64(this.size))}write(t){if(this.type==="mdat"){let e=this;if(e.stream){this.size=e.stream.getAbsoluteEndPosition(),this.writeHeader(t);for(let i of e.stream.buffers){let r=new Uint8Array(i);t.writeUint8Array(r)}}else e.data&&(this.size=e.data.length,this.writeHeader(t),t.writeUint8Array(e.data))}else this.size=this.data?this.data.length:0,this.writeHeader(t),this.data&&t.writeUint8Array(this.data)}printHeader(t){this.size+=8,this.size>w&&(this.size+=8),this.type==="uuid"&&(this.size+=16),t.log(t.indent+"size:"+this.size),t.log(t.indent+"type:"+this.type)}print(t){this.printHeader(t)}parse(t){this.type!=="mdat"?this.data=t.readUint8Array(this.size-this.hdr_size):this.size===0?t.seek(t.getEndPosition()):t.seek(this.start+this.size)}parseDataAndRewind(t){this.data=t.readUint8Array(this.size-this.hdr_size),t.seek(this.start+this.hdr_size)}parseLanguage(t){this.language=t.readUint16();let e=[];e[0]=this.language>>10&31,e[1]=this.language>>5&31,e[2]=this.language&31,this.languageString=String.fromCharCode(e[0]+96,e[1]+96,e[2]+96)}computeSize(t){let e=t||new V;this.write(e)}isEndOfBox(t){let e=t.getPosition(),i=this.start+this.size;return e===i}};nt=new WeakMap,c.registryId=Symbol.for("BoxIdentifier");var l=class extends c{constructor(){super(...arguments);this.flags=0;this.version=0}writeHeader(e){this.size+=4,super.writeHeader(e," v="+this.version+" f="+this.flags),e.writeUint8(this.version),e.writeUint24(this.flags)}printHeader(e){this.size+=4,super.printHeader(e),e.log(e.indent+"version:"+this.version),e.log(e.indent+"flags:"+this.flags)}parseDataAndRewind(e){this.parseFullHeader(e),this.data=e.readUint8Array(this.size-this.hdr_size),this.hdr_size-=4,e.seek(this.start+this.hdr_size)}parseFullHeader(e){this.version=e.readUint8(),this.flags=e.readUint24(),this.hdr_size+=4}parse(e){this.parseFullHeader(e),this.data=e.readUint8Array(this.size-this.hdr_size)}},x=class{constructor(t){this.grouping_type=t}write(t){t.writeUint8Array(this.data)}parse(t){u.warn("BoxParser",`Unknown sample group type: '${this.grouping_type}'`),this.data=t.readUint8Array(this.description_length)}};x.registryId=Symbol.for("SampleGroupEntryIdentifier");var tt=class extends l{parse(t){this.parseFullHeader(t),this.track_group_id=t.readUint32()}},it=class extends c{constructor(e,i,r,s,o){super(i);this.box_name=r;this.hdr_size=s;this.start=o;this.type=e}parse(e){this.from_item_ID=e.readUint16();let i=e.readUint16();this.references=[];for(let r=0;r<i;r++)this.references[r]={to_item_ID:e.readUint16()}}},rt=class extends c{constructor(e,i,r,s,o){super(i);this.box_name=r;this.hdr_size=s;this.start=o;this.type=e}parse(e){this.from_item_ID=e.readUint32();let i=e.readUint16();this.references=[];for(let r=0;r<i;r++)this.references[r]={to_item_ID:e.readUint32()}}},st=class extends c{constructor(e,i,r,s){super(i);this.hdr_size=r;this.start=s;this.type=e}parse(e){this.track_ids=e.readUint32Array((this.size-this.hdr_size)/4)}write(e){this.size=this.track_ids.length*4,this.writeHeader(e),e.writeUint32Array(this.track_ids)}};var yt=["boxes","entries","references","subsamples","items","item_infos","extents","associations","subsegments","ranges","seekLists","seekPoints","esd","levels"],Eo=["compatible_brands","matrix","opcolor","sample_counts","sample_deltas","first_chunk","samples_per_chunk","sample_sizes","chunk_offsets","sample_offsets","sample_description_index","sample_duration"];function Do(n,t){if(n&&!t)return!1;let e;for(e in n)if(!yt.find(i=>i===e)){if(n[e]instanceof c||t[e]instanceof c)continue;if(typeof n[e]=="undefined"||typeof t[e]=="undefined")continue;if(typeof n[e]=="function"||typeof t[e]=="function")continue;if("subBoxNames"in n&&n.subBoxNames.indexOf(e.slice(0,4))>-1||"subBoxNames"in t&&t.subBoxNames.indexOf(e.slice(0,4))>-1)continue;if(e==="data"||e==="start"||e==="size"||e==="creation_time"||e==="modification_time")continue;if(Eo.find(i=>i===e))continue;if(n[e]!==t[e])return!1}return!0}function St(n,t){if(!Do(n,t))return!1;for(let e=0;e<yt.length;e++){let i=yt[e];if(n[i]&&t[i]&&!St(n[i],t[i]))return!1}return!0}function to(n){let t=n;for(;t;){if("registryId"in t)return t.registryId;t=Object.getPrototypeOf(t)}}var Ko=n=>{let t=Symbol.for("SampleGroupEntryIdentifier");return to(n)===t},$o=n=>{let t=Symbol.for("SampleEntryIdentifier");return to(n)===t},qo=n=>{let t=Symbol.for("BoxIdentifier");return to(n)===t},P={uuid:{},sampleEntry:{},sampleGroupEntry:{},box:{}};function Po(n){let t={uuid:{},sampleEntry:{},sampleGroupEntry:{},box:{}};for(let[e,i]of Object.entries(n)){if(Ko(i)){let r="grouping_type"in i?i.grouping_type:void 0;if(!r)throw new Error(`SampleGroupEntry class ${e} does not have a valid static grouping_type. Please ensure it is defined correctly.`);if(r in t.sampleGroupEntry)throw new Error(`SampleGroupEntry class ${e} has a grouping_type that is already registered. Please ensure it is unique.`);t.sampleGroupEntry[r]=i;continue}if($o(i)){let r="fourcc"in i?i.fourcc:void 0;if(!r)throw new Error(`SampleEntry class ${e} does not have a valid static fourcc. Please ensure it is defined correctly.`);if(r in t.sampleEntry)throw new Error(`SampleEntry class ${e} has a fourcc that is already registered. Please ensure it is unique.`);t.sampleEntry[r]=i;continue}if(qo(i)){let r="fourcc"in i?i.fourcc:void 0,s="uuid"in i?i.uuid:void 0;if(r==="uuid"){if(!s)throw new Error(`Box class ${e} has a fourcc of 'uuid' but does not have a valid uuid. Please ensure it is defined correctly.`);if(s in t.uuid)throw new Error(`Box class ${e} has a uuid that is already registered. Please ensure it is unique.`);t.uuid[s]=i;continue}t.box[r]=i;continue}throw new Error(`Box class ${e} does not have a valid static fourcc, uuid, or grouping_type. Please ensure it is defined correctly.`)}return P.uuid=Je({},t.uuid),P.sampleEntry=Je({},t.sampleEntry),P.sampleGroupEntry=Je({},t.sampleGroupEntry),P.box=Je({},t.box),P}var ot={};function Lo(n){return Object.entries(n).forEach(([t,e])=>ot[t]=e),ot}function Yo(n){return G(n)}function G(n){let t="";for(let e=0;e<16;e++){let i=n.readUint8().toString(16);t+=i.length===1?"0"+i:i}return t}function z(n,t,e){let i,r,s=n.getPosition(),o=0,a;if(n.getEndPosition()-s<8)return u.debug("BoxParser","Not enough data in stream to parse the type and size of the box"),{code:K};if(e&&e<8)return u.debug("BoxParser","Not enough bytes left in the parent box to parse a new box"),{code:K};let f=n.readUint32(),d=n.readString(4);if(d.length!==4||!/^[\x20-\x7E]{4}$/.test(d))return u.error("BoxParser",`Invalid box type: '${d}'`),{code:bt,start:s,type:d};let m=d;if(u.debug("BoxParser","Found box of type '"+d+"' and size "+f+" at position "+s),o=8,d==="uuid"){if(n.getEndPosition()-n.getPosition()<16||e-o<16)return n.seek(s),u.debug("BoxParser","Not enough bytes left in the parent box to parse a UUID box"),{code:K};a=Yo(n),o+=16,m=a}if(f===1){if(n.getEndPosition()-n.getPosition()<8||e&&e-o<8)return n.seek(s),u.warn("BoxParser",'Not enough data in stream to parse the extended size of the "'+d+'" box'),{code:K};r=f,f=n.readUint64(),o+=8}else if(f===0){if(e)f=e;else if(d!=="mdat")return u.error("BoxParser","Unlimited box size not supported for type: '"+d+"'"),i=new c(f),i.type=d,{code:v,box:i,size:i.size}}if(f!==0&&f<o)return u.error("BoxParser","Box of type "+d+" has an invalid size "+f+" (too small to be a box)"),{code:K,type:d,size:f,hdr_size:o,start:s};if(f!==0&&e&&f>e)return u.error("BoxParser","Box of type '"+d+"' has a size "+f+" greater than its container size "+e),{code:K,type:d,size:f,hdr_size:o,start:s};if(f!==0&&s+f>n.getEndPosition())return n.seek(s),u.info("BoxParser","Not enough data in stream to parse the entire '"+d+"' box"),{code:K,type:d,size:f,hdr_size:o,start:s,original_size:r};if(t)return{code:v,type:d,size:f,hdr_size:o,start:s};d in P.box?i=new P.box[d](f):d!=="uuid"?(u.warn("BoxParser",`Unknown box type: '${d}'`),i=new c(f),i.type=d,i.has_unparsed_data=!0):a in P.uuid?i=new P.uuid[a](f):(u.warn("BoxParser",`Unknown UUID box type: '${a}'`),i=new c(f),i.type=d,i.uuid=a,i.has_unparsed_data=!0),i.original_size=r,i.hdr_size=o,i.start=s,i.write===c.prototype.write&&i.type!=="mdat"&&(u.info("BoxParser","'"+m+"' box writing not yet implemented, keeping unparsed data in memory for later write"),i.parseDataAndRewind(n)),i.parse(n);let p=n.getPosition()-(i.start+i.size);return p<0?(u.warn("BoxParser","Parsing of box '"+m+"' did not read the entire indicated box data size (missing "+-p+" bytes), seeking forward"),n.seek(i.start+i.size)):p>0&&i.size!==0&&(u.error("BoxParser","Parsing of box '"+m+"' read "+p+" more bytes than the indicated box data size, seeking backwards"),n.seek(i.start+i.size)),{code:v,box:i,size:i.size}}var g=class extends c{write(t){if(this.size=0,this.writeHeader(t),this.boxes)for(let e=0;e<this.boxes.length;e++)this.boxes[e]&&(this.boxes[e].write(t),this.size+=this.boxes[e].size);u.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),t.adjustUint32(this.sizePosition,this.size)}print(t){this.printHeader(t);for(let e=0;e<this.boxes.length;e++)if(this.boxes[e]){let i=t.indent;t.indent+=" ",this.boxes[e].print(t),t.indent=i}}parse(t){let e;for(;t.getPosition()<this.start+this.size;)if(e=z(t,!1,this.size-(t.getPosition()-this.start)),e.code===v){let i=e.box;if(this.boxes||(this.boxes=[]),this.boxes.push(i),this.subBoxNames&&this.subBoxNames.indexOf(i.type)!==-1){let r=this.subBoxNames[this.subBoxNames.indexOf(i.type)]+"s";this[r]||(this[r]=[]),this[r].push(i)}else{let r=i.type!=="uuid"?i.type:i.uuid;this[r]?u.warn("ContainerBox",`Box of type ${r} already exists in container box ${this.type}.`):this[r]=i}}else return}};var R=class extends g{constructor(e,i,r){super(e);this.hdr_size=i;this.start=r}isVideo(){return!1}isAudio(){return!1}isSubtitle(){return!1}isMetadata(){return!1}isHint(){return!1}getCodec(){return this.type.replace(".","")}getWidth(){return""}getHeight(){return""}getChannelCount(){return""}getSampleRate(){return""}getSampleSize(){return""}parseHeader(e){e.readUint8Array(6),this.data_reference_index=e.readUint16(),this.hdr_size+=8}parse(e){this.parseHeader(e),this.data=e.readUint8Array(this.size-this.hdr_size)}parseDataAndRewind(e){this.parseHeader(e),this.data=e.readUint8Array(this.size-this.hdr_size),this.hdr_size-=8,e.seek(this.start+this.hdr_size)}parseFooter(e){super.parse(e)}writeHeader(e){this.size=8,super.writeHeader(e),e.writeUint8(0),e.writeUint8(0),e.writeUint8(0),e.writeUint8(0),e.writeUint8(0),e.writeUint8(0),e.writeUint16(this.data_reference_index)}writeFooter(e){if(this.boxes)for(let i=0;i<this.boxes.length;i++)this.boxes[i].write(e),this.size+=this.boxes[i].size;u.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),e.adjustUint32(this.sizePosition,this.size)}write(e){this.writeHeader(e),e.writeUint8Array(this.data),this.size+=this.data.length,u.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),e.adjustUint32(this.sizePosition,this.size)}};R.registryId=Symbol.for("SampleEntryIdentifier");var _e=class extends R{},O=class extends R{isMetadata(){return!0}},N=class extends R{isSubtitle(){return!0}},at=class extends R{},U=class extends R{parse(t){this.parseHeader(t),t.readUint16(),t.readUint16(),t.readUint32Array(3),this.width=t.readUint16(),this.height=t.readUint16(),this.horizresolution=t.readUint32(),this.vertresolution=t.readUint32(),t.readUint32(),this.frame_count=t.readUint16();let e=Math.min(31,t.readUint8());this.compressorname=t.readString(e),e<31&&t.readString(31-e),this.depth=t.readUint16(),t.readUint16(),this.parseFooter(t)}isVideo(){return!0}getWidth(){return this.width}getHeight(){return this.height}write(t){this.writeHeader(t),this.size+=2*7+6*4+32,t.writeUint16(0),t.writeUint16(0),t.writeUint32(0),t.writeUint32(0),t.writeUint32(0),t.writeUint16(this.width),t.writeUint16(this.height),t.writeUint32(this.horizresolution),t.writeUint32(this.vertresolution),t.writeUint32(0),t.writeUint16(this.frame_count),t.writeUint8(Math.min(31,this.compressorname.length)),t.writeString(this.compressorname,void 0,31),t.writeUint16(this.depth),t.writeInt16(-1),this.writeFooter(t)}},E=class extends R{parse(t){var i,r;this.parseHeader(t),this.version=t.readUint16(),t.readUint16(),t.readUint32(),this.channel_count=t.readUint16(),this.samplesize=t.readUint16(),t.readUint16(),t.readUint16(),this.samplerate=t.readUint32()/65536,((r=(i=t.isofile)==null?void 0:i.ftyp)==null?void 0:r.major_brand.includes("qt"))&&(this.version===1?this.extensions=t.readUint8Array(16):this.version===2&&(this.extensions=t.readUint8Array(36))),this.parseFooter(t)}isAudio(){return!0}getChannelCount(){return this.channel_count}getSampleRate(){return this.samplerate}getSampleSize(){return this.samplesize}write(t){this.writeHeader(t),this.size+=2*4+3*4,t.writeUint32(0),t.writeUint32(0),t.writeUint16(this.channel_count),t.writeUint16(this.samplesize),t.writeUint16(0),t.writeUint16(0),t.writeUint32(this.samplerate<<16),this.writeFooter(t)}},Q=class extends R{parse(t){this.parseHeader(t),this.parseFooter(t)}write(t){this.writeHeader(t),this.writeFooter(t)}};var ft=class extends Array{toString(){let t="<table class='inner-table'>";t+="<thead><tr><th>length</th><th>nalu_data</th></tr></thead>",t+="<tbody>";for(let e=0;e<this.length;e++){let i=this[e];t+="<tr>",t+="<td>"+i.length+"</td>",t+="<td>",t+=i.data.reduce(function(r,s){return r+s.toString(16).padStart(2,"0")},"0x"),t+="</td></tr>"}return t+="</tbody></table>",t}};var be=class extends c{constructor(){super(...arguments);this.box_name="AVCConfigurationBox"}parse(e){this.configurationVersion=e.readUint8(),this.AVCProfileIndication=e.readUint8(),this.profile_compatibility=e.readUint8(),this.AVCLevelIndication=e.readUint8(),this.lengthSizeMinusOne=e.readUint8()&3,this.nb_SPS_nalus=e.readUint8()&31;let i=this.size-this.hdr_size-6;this.SPS=new ft;for(let r=0;r<this.nb_SPS_nalus;r++){let s=e.readUint16();this.SPS.push({length:s,data:e.readUint8Array(s)}),i-=2+s}this.nb_PPS_nalus=e.readUint8(),i--,this.PPS=new ft;for(let r=0;r<this.nb_PPS_nalus;r++){let s=e.readUint16();this.PPS.push({length:s,data:e.readUint8Array(s)}),i-=2+s}i>0&&(this.ext=e.readUint8Array(i))}write(e){this.size=7;for(let i=0;i<this.SPS.length;i++)this.size+=2+this.SPS[i].length;for(let i=0;i<this.PPS.length;i++)this.size+=2+this.PPS[i].length;this.ext&&(this.size+=this.ext.length),this.writeHeader(e),e.writeUint8(this.configurationVersion),e.writeUint8(this.AVCProfileIndication),e.writeUint8(this.profile_compatibility),e.writeUint8(this.AVCLevelIndication),e.writeUint8(this.lengthSizeMinusOne+252),e.writeUint8(this.SPS.length+224);for(let i=0;i<this.SPS.length;i++)e.writeUint16(this.SPS[i].length),e.writeUint8Array(this.SPS[i].data);e.writeUint8(this.PPS.length);for(let i=0;i<this.PPS.length;i++)e.writeUint16(this.PPS[i].length),e.writeUint8Array(this.PPS[i].data);this.ext&&e.writeUint8Array(this.ext)}};be.fourcc="avcC";var J=class extends c{constructor(){super(...arguments);this.box_name="MediaDataBox"}};J.fourcc="mdat";var Bt=class extends c{constructor(){super(...arguments);this.box_name="ItemDataBox"}};Bt.fourcc="idat";var Ut=class extends c{constructor(){super(...arguments);this.box_name="FreeSpaceBox"}};Ut.fourcc="free";var wt=class extends c{constructor(){super(...arguments);this.box_name="FreeSpaceBox"}};wt.fourcc="skip";var xe=class extends l{constructor(){super(...arguments);this.box_name="HintMediaHeaderBox"}};xe.fourcc="hmhd";var ee=class extends l{constructor(){super(...arguments);this.box_name="NullMediaHeaderBox"}};ee.fourcc="nmhd";var vt=class extends l{constructor(){super(...arguments);this.box_name="ObjectDescriptorBox"}};vt.fourcc="iods";var At=class extends l{constructor(){super(...arguments);this.box_name="XMLBox"}};At.fourcc="xml ";var Mt=class extends l{constructor(){super(...arguments);this.box_name="BinaryXMLBox"}};Mt.fourcc="bxml";var It=class extends l{constructor(){super(...arguments);this.box_name="ItemProtectionBox";this.sinfs=[]}get protections(){return this.sinfs}};It.fourcc="ipro";var te=class extends g{constructor(){super(...arguments);this.box_name="MovieBox";this.traks=[];this.psshs=[];this.subBoxNames=["trak","pssh"]}};te.fourcc="moov";var ge=class extends g{constructor(){super(...arguments);this.box_name="TrackBox";this.samples=[]}};ge.fourcc="trak";var zt=class extends g{constructor(){super(...arguments);this.box_name="EditBox"}};zt.fourcc="edts";var ye=class extends g{constructor(){super(...arguments);this.box_name="MediaBox"}};ye.fourcc="mdia";var Se=class extends g{constructor(){super(...arguments);this.box_name="MediaInformationBox"}};Se.fourcc="minf";var Be=class extends g{constructor(){super(...arguments);this.box_name="DataInformationBox"}};Be.fourcc="dinf";var Ue=class extends g{constructor(){super(...arguments);this.box_name="SampleTableBox";this.sgpds=[];this.sbgps=[];this.subBoxNames=["sgpd","sbgp"]}};Ue.fourcc="stbl";var ae=class extends g{constructor(){super(...arguments);this.box_name="MovieExtendsBox";this.trexs=[];this.subBoxNames=["trex"]}};ae.fourcc="mvex";var we=class extends g{constructor(){super(...arguments);this.box_name="MovieFragmentBox";this.trafs=[];this.subBoxNames=["traf"]}};we.fourcc="moof";var ve=class extends g{constructor(){super(...arguments);this.box_name="TrackFragmentBox";this.truns=[];this.sgpds=[];this.sbgps=[];this.subBoxNames=["trun","sgpd","sbgp"]}};ve.fourcc="traf";var Tt=class extends g{constructor(){super(...arguments);this.box_name="VTTCueBox"}};Tt.fourcc="vttc";var kt=class extends g{constructor(){super(...arguments);this.box_name="MovieFragmentRandomAccessBox";this.tfras=[];this.subBoxNames=["tfra"]}};kt.fourcc="mfra";var Ft=class extends g{constructor(){super(...arguments);this.box_name="AdditionalMetadataContainerBox"}};Ft.fourcc="meco";var Et=class extends g{constructor(){super(...arguments);this.box_name="trackhintinformation";this.subBoxNames=["sdp ","rtp "]}};Et.fourcc="hnti";var Dt=class extends g{constructor(){super(...arguments);this.box_name="hintstatisticsbox";this.maxrs=[];this.subBoxNames=["maxr"]}};Dt.fourcc="hinf";var Pt=class extends g{constructor(){super(...arguments);this.box_name="SubTrackBox"}};Pt.fourcc="strk";var Lt=class extends g{constructor(){super(...arguments);this.box_name="SubTrackDefinitionBox"}};Lt.fourcc="strd";var Ct=class extends g{constructor(){super(...arguments);this.box_name="ProtectionSchemeInfoBox"}};Ct.fourcc="sinf";var Nt=class extends g{constructor(){super(...arguments);this.box_name="RestrictedSchemeInfoBox"}};Nt.fourcc="rinf";var Rt=class extends g{constructor(){super(...arguments);this.box_name="SchemeInformationBox"}};Rt.fourcc="schi";var Ot=class extends g{constructor(){super(...arguments);this.box_name="TrackGroupBox"}};Ot.fourcc="trgr";var Ht=class extends g{constructor(){super(...arguments);this.box_name="UserDataBox";this.kinds=[];this.strks=[];this.subBoxNames=["kind","strk"]}};Ht.fourcc="udta";var Vt=class extends g{constructor(){super(...arguments);this.box_name="ItemPropertiesBox";this.ipmas=[];this.subBoxNames=["ipma"]}};Vt.fourcc="iprp";var Gt=class extends g{constructor(){super(...arguments);this.box_name="ItemPropertyContainerBox";this.hvcCs=[];this.ispes=[];this.claps=[];this.irots=[];this.subBoxNames=["hvcC","ispe","clap","irot"]}};Gt.fourcc="ipco";var jt=class extends g{constructor(){super(...arguments);this.box_name="GroupsListBox"}};jt.fourcc="grpl";var Kt=class extends g{constructor(){super(...arguments);this.box_name="J2KHeaderInfoBox"}};Kt.fourcc="j2kH";var $t=class extends g{constructor(){super(...arguments);this.box_name="ExtendedTypeBox";this.tycos=[];this.subBoxNames=["tyco"]}};$t.fourcc="etyp";var qt=class extends g{constructor(){super(...arguments);this.box_name="ProjectedOmniVideoBox";this.subBoxNames=["prfr"]}};qt.fourcc="povd";var Ae=class extends l{constructor(){super(...arguments);this.box_name="DataReferenceBox"}parse(e){this.parseFullHeader(e),this.entries=[];let i=e.readUint32();for(let r=0;r<i;r++){let s=z(e,!1,this.size-(e.getPosition()-this.start));if(s.code===v){let o=s.box;this.entries.push(o)}else return}}write(e){this.version=0,this.flags=0,this.size=4,this.writeHeader(e),e.writeUint32(this.entries.length);for(let i=0;i<this.entries.length;i++)this.entries[i].write(e),this.size+=this.entries[i].size;u.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),e.adjustUint32(this.sizePosition,this.size)}};Ae.fourcc="dref";var Me=class extends l{constructor(){super(...arguments);this.box_name="ExtendedLanguageBox"}parse(e){this.parseFullHeader(e),this.extended_language=e.readString(this.size-this.hdr_size)}write(e){this.version=0,this.flags=0,this.size=this.extended_language.length,this.writeHeader(e),e.writeString(this.extended_language)}};Me.fourcc="elng";var Ie=class extends c{constructor(){super(...arguments);this.box_name="FileTypeBox"}parse(e){let i=this.size-this.hdr_size;this.major_brand=e.readString(4),this.minor_version=e.readUint32(),i-=8,this.compatible_brands=[];let r=0;for(;i>=4;)this.compatible_brands[r]=e.readString(4),i-=4,r++}write(e){this.size=8+4*this.compatible_brands.length,this.writeHeader(e),e.writeString(this.major_brand,void 0,4),e.writeUint32(this.minor_version);for(let i=0;i<this.compatible_brands.length;i++)e.writeString(this.compatible_brands[i],void 0,4)}};Ie.fourcc="ftyp";var ze=class extends l{constructor(){super(...arguments);this.box_name="HandlerBox"}parse(e){if(this.parseFullHeader(e),this.version===0&&(e.readUint32(),this.handler=e.readString(4),e.readUint32Array(3),!this.isEndOfBox(e))){let i=this.start+this.size-e.getPosition();this.name=e.readCString();let r=this.start+this.size-1;e.seek(r),e.readUint8()!==0&&i>1&&(u.info("BoxParser","Warning: hdlr name is not null-terminated, possibly length-prefixed string. Trimming first byte."),this.name=this.name.slice(1))}}write(e){this.size=5*4+this.name.length+1,this.version=0,this.flags=0,this.writeHeader(e),e.writeUint32(0),e.writeString(this.handler,void 0,4),e.writeUint32Array([0,0,0]),e.writeCString(this.name)}};ze.fourcc="hdlr";var Te=class extends c{constructor(){super(...arguments);this.box_name="HEVCConfigurationBox"}parse(e){this.configurationVersion=e.readUint8();let i=e.readUint8();this.general_profile_space=i>>6,this.general_tier_flag=(i&32)>>5,this.general_profile_idc=i&31,this.general_profile_compatibility=e.readUint32(),this.general_constraint_indicator=e.readUint8Array(6),this.general_level_idc=e.readUint8(),this.min_spatial_segmentation_idc=e.readUint16()&4095,this.parallelismType=e.readUint8()&3,this.chroma_format_idc=e.readUint8()&3,this.bit_depth_luma_minus8=e.readUint8()&7,this.bit_depth_chroma_minus8=e.readUint8()&7,this.avgFrameRate=e.readUint16(),i=e.readUint8(),this.constantFrameRate=i>>6,this.numTemporalLayers=(i&13)>>3,this.temporalIdNested=(i&4)>>2,this.lengthSizeMinusOne=i&3,this.nalu_arrays=[];let r=e.readUint8();for(let s=0;s<r;s++){let o=[];this.nalu_arrays.push(o),i=e.readUint8(),o.completeness=(i&128)>>7,o.nalu_type=i&63;let a=e.readUint16();for(let f=0;f<a;f++){let d=e.readUint16();o.push({data:e.readUint8Array(d)})}}}write(e){this.size=23;for(let i=0;i<this.nalu_arrays.length;i++){this.size+=3;for(let r=0;r<this.nalu_arrays[i].length;r++)this.size+=2+this.nalu_arrays[i][r].data.length}this.writeHeader(e),e.writeUint8(this.configurationVersion),e.writeUint8((this.general_profile_space<<6)+(this.general_tier_flag<<5)+this.general_profile_idc),e.writeUint32(this.general_profile_compatibility),e.writeUint8Array(this.general_constraint_indicator),e.writeUint8(this.general_level_idc),e.writeUint16(this.min_spatial_segmentation_idc+(15<<24)),e.writeUint8(this.parallelismType+252),e.writeUint8(this.chroma_format_idc+252),e.writeUint8(this.bit_depth_luma_minus8+248),e.writeUint8(this.bit_depth_chroma_minus8+248),e.writeUint16(this.avgFrameRate),e.writeUint8((this.constantFrameRate<<6)+(this.numTemporalLayers<<3)+(this.temporalIdNested<<2)+this.lengthSizeMinusOne),e.writeUint8(this.nalu_arrays.length);for(let i=0;i<this.nalu_arrays.length;i++){e.writeUint8((this.nalu_arrays[i].completeness<<7)+this.nalu_arrays[i].nalu_type),e.writeUint16(this.nalu_arrays[i].length);for(let r=0;r<this.nalu_arrays[i].length;r++)e.writeUint16(this.nalu_arrays[i][r].data.length),e.writeUint8Array(this.nalu_arrays[i][r].data)}}};Te.fourcc="hvcC";var ke=class extends l{constructor(){super(...arguments);this.box_name="MediaHeaderBox"}parse(e){this.parseFullHeader(e),this.version===1?(this.creation_time=e.readUint64(),this.modification_time=e.readUint64(),this.timescale=e.readUint32(),this.duration=e.readUint64()):(this.creation_time=e.readUint32(),this.modification_time=e.readUint32(),this.timescale=e.readUint32(),this.duration=e.readUint32()),this.parseLanguage(e),e.readUint16()}write(e){let i=this.modification_time>w||this.creation_time>w||this.duration>w||this.version===1;this.version=i?1:0,this.size=4*4+2*2,this.size+=i?3*4:0,this.flags=0,this.writeHeader(e),i?(e.writeUint64(this.creation_time),e.writeUint64(this.modification_time),e.writeUint32(this.timescale),e.writeUint64(this.duration)):(e.writeUint32(this.creation_time),e.writeUint32(this.modification_time),e.writeUint32(this.timescale),e.writeUint32(this.duration)),e.writeUint16(this.language),e.writeUint16(0)}};ke.fourcc="mdhd";var Fe=class extends l{constructor(){super(...arguments);this.box_name="MovieExtendsHeaderBox"}parse(e){this.parseFullHeader(e),this.flags&1&&(u.warn("BoxParser","mehd box incorrectly uses flags set to 1, converting version to 1"),this.version=1),this.version===1?this.fragment_duration=e.readUint64():this.fragment_duration=e.readUint32()}write(e){let i=this.fragment_duration>w||this.version===1;this.version=i?1:0,this.size=4,this.size+=i?4:0,this.flags=0,this.writeHeader(e),i?e.writeUint64(this.fragment_duration):e.writeUint32(this.fragment_duration)}};Fe.fourcc="mehd";var Yt=class extends l{constructor(){super(...arguments);this.box_name="ItemInfoEntry"}parse(e){if(this.parseFullHeader(e),(this.version===0||this.version===1)&&(this.item_ID=e.readUint16(),this.item_protection_index=e.readUint16(),this.item_name=e.readCString(),this.content_type=e.readCString(),this.isEndOfBox(e)||(this.content_encoding=e.readCString())),this.version===1){this.extension_type=e.readString(4),u.warn("BoxParser","Cannot parse extension type"),e.seek(this.start+this.size);return}this.version>=2&&(this.version===2?this.item_ID=e.readUint16():this.version===3&&(this.item_ID=e.readUint32()),this.item_protection_index=e.readUint16(),this.item_type=e.readString(4),this.item_name=e.readCString(),this.item_type==="mime"?(this.content_type=e.readCString(),this.content_encoding=e.readCString()):this.item_type==="uri "&&(this.item_uri_type=e.readCString()))}};Yt.fourcc="infe";var Wt=class extends l{constructor(){super(...arguments);this.box_name="ItemInfoBox"}parse(e){this.parseFullHeader(e),this.version===0?this.entry_count=e.readUint16():this.entry_count=e.readUint32(),this.item_infos=[];for(let i=0;i<this.entry_count;i++){let r=z(e,!1,this.size-(e.getPosition()-this.start));if(r.code===v){let s=r.box;s.type==="infe"?this.item_infos[i]=s:u.error("BoxParser","Expected 'infe' box, got "+r.box.type,e.isofile)}else return}}};Wt.fourcc="iinf";var Xt=class extends l{constructor(){super(...arguments);this.box_name="ItemLocationBox"}parse(e){this.parseFullHeader(e);let i;i=e.readUint8(),this.offset_size=i>>4&15,this.length_size=i&15,i=e.readUint8(),this.base_offset_size=i>>4&15,this.version===1||this.version===2?this.index_size=i&15:this.index_size=0,this.items=[];let r=0;if(this.version<2)r=e.readUint16();else if(this.version===2)r=e.readUint32();else throw new Error("version of iloc box not supported");for(let s=0;s<r;s++){let o=0,a=0,f=0;if(this.version<2)o=e.readUint16();else if(this.version===2)o=e.readUint32();else throw new Error("version of iloc box not supported");this.version===1||this.version===2?a=e.readUint16()&15:a=0;let d=e.readUint16();switch(this.base_offset_size){case 0:f=0;break;case 4:f=e.readUint32();break;case 8:f=e.readUint64();break;default:throw new Error("Error reading base offset size")}let m=[],p=e.readUint16();for(let h=0;h<p;h++){let _=0,y=0,b=0;if(this.version===1||this.version===2)switch(this.index_size){case 0:_=0;break;case 4:_=e.readUint32();break;case 8:_=e.readUint64();break;default:throw new Error("Error reading extent index")}switch(this.offset_size){case 0:y=0;break;case 4:y=e.readUint32();break;case 8:y=e.readUint64();break;default:throw new Error("Error reading extent index")}switch(this.length_size){case 0:b=0;break;case 4:b=e.readUint32();break;case 8:b=e.readUint64();break;default:throw new Error("Error reading extent index")}m.push({extent_index:_,extent_length:b,extent_offset:y})}this.items.push({base_offset:f,construction_method:a,item_ID:o,data_reference_index:d,extents:m})}}};Xt.fourcc="iloc";var Wo={auxl:"Auxiliary image item",base:"Pre-derived image item base",cdsc:"Item describes referenced item",dimg:"Derived image item",dpnd:"Item coding dependency",eroi:"Region",evir:"EVC slice",exbl:"Scalable image item","fdl ":"File delivery",font:"Font item",iloc:"Item data location",mask:"Region mask",mint:"Data integrity",pred:"Predictively coded item",prem:"Pre-multiplied item",tbas:"HEVC tile track base item",text:"Text item",thmb:"Thumbnail image item"},lt=class lt extends l{constructor(){super(...arguments);this.box_name="ItemReferenceBox";this.references=[]}parse(e){for(this.parseFullHeader(e),this.references=[];e.getPosition()<this.start+this.size;){let i=z(e,!0,this.size-(e.getPosition()-this.start));if(i.code===v){let r="Unknown item reference";lt.allowed_types.includes(i.type)?r=Wo[i.type]:u.warn("BoxParser",`Unknown item reference type: '${i.type}'`);let s=this.version===0?new it(i.type,i.size,r,i.hdr_size,i.start):new rt(i.type,i.size,r,i.hdr_size,i.start);s.write===c.prototype.write&&s.type!=="mdat"&&(u.warn("BoxParser",s.type+" box writing not yet implemented, keeping unparsed data in memory for later write"),s.parseDataAndRewind(e)),s.parse(e),this.references.push(s)}else return}}};lt.fourcc="iref",lt.allowed_types=["auxl","base","cdsc","dimg","dpnd","eroi","evir","exbl","fdl ","font","iloc","mask","mint","pred","prem","tbas","text","thmb"];var io=lt;var Zt=class extends l{constructor(){super(...arguments);this.box_name="PrimaryItemBox"}parse(e){this.parseFullHeader(e),this.version===0?this.item_id=e.readUint16():this.item_id=e.readUint32()}};Zt.fourcc="pitm";var Qt=class extends l{constructor(){super(...arguments);this.box_name="MetaBox";this.isQT=!1}parse(e){let i=e.getPosition();if(this.size>8){switch(e.readUint32(),e.readString(4)){case"hdlr":case"mhdr":case"keys":case"ilst":case"ctry":case"lang":this.isQT=!0;break;default:break}e.seek(i)}this.isQT||this.parseFullHeader(e),g.prototype.parse.call(this,e)}};Qt.fourcc="meta";var Ee=class extends l{constructor(){super(...arguments);this.box_name="MovieFragmentHeaderBox"}parse(e){this.parseFullHeader(e),this.sequence_number=e.readUint32()}write(e){this.version=0,this.flags=0,this.size=4,this.writeHeader(e),e.writeUint32(this.sequence_number)}};Ee.fourcc="mfhd";var De=class extends l{constructor(){super(...arguments);this.box_name="MovieHeaderBox"}parse(e){this.parseFullHeader(e),this.version===1?(this.creation_time=e.readUint64(),this.modification_time=e.readUint64(),this.timescale=e.readUint32(),this.duration=e.readUint64()):(this.creation_time=e.readUint32(),this.modification_time=e.readUint32(),this.timescale=e.readUint32(),this.duration=e.readUint32()),this.rate=e.readUint32(),this.volume=e.readUint16()>>8,e.readUint16(),e.readUint32Array(2),this.matrix=e.readInt32Array(9),e.readUint32Array(6),this.next_track_id=e.readUint32()}write(e){let i=this.modification_time>w||this.creation_time>w||this.duration>w||this.version===1;this.version=i?1:0,this.size=4*4+20*4,this.size+=i?3*4:0,this.flags=0,this.writeHeader(e),i?(e.writeUint64(this.creation_time),e.writeUint64(this.modification_time),e.writeUint32(this.timescale),e.writeUint64(this.duration)):(e.writeUint32(this.creation_time),e.writeUint32(this.modification_time),e.writeUint32(this.timescale),e.writeUint32(this.duration)),e.writeUint32(this.rate),e.writeUint16(this.volume<<8),e.writeUint16(0),e.writeUint32(0),e.writeUint32(0),e.writeInt32Array(this.matrix),e.writeUint32(0),e.writeUint32(0),e.writeUint32(0),e.writeUint32(0),e.writeUint32(0),e.writeUint32(0),e.writeUint32(this.next_track_id)}print(e){super.printHeader(e),e.log(e.indent+"creation_time: "+this.creation_time),e.log(e.indent+"modification_time: "+this.modification_time),e.log(e.indent+"timescale: "+this.timescale),e.log(e.indent+"duration: "+this.duration),e.log(e.indent+"rate: "+this.rate),e.log(e.indent+"volume: "+(this.volume>>8)),e.log(e.indent+"matrix: "+this.matrix.join(", ")),e.log(e.indent+"next_track_id: "+this.next_track_id)}};De.fourcc="mvhd";var Jt=class extends O{parse(t){this.parseHeader(t),this.content_encoding=t.readCString(),this.mime_format=t.readCString(),this.parseFooter(t)}};Jt.fourcc="mett";var ei=class extends O{parse(t){this.parseHeader(t),this.content_encoding=t.readCString(),this.namespace=t.readCString(),this.schema_location=t.readCString(),this.parseFooter(t)}};ei.fourcc="metx";var ti=class extends c{constructor(){super(...arguments);this.box_name="AV1CodecConfigurationBox"}parse(e){let i=e.readUint8();if((i>>7&1)!==1){u.error("BoxParser","av1C marker problem",e.isofile);return}if(this.version=i&127,this.version!==1){u.error("BoxParser","av1C version "+this.version+" not supported",e.isofile);return}if(i=e.readUint8(),this.seq_profile=i>>5&7,this.seq_level_idx_0=i&31,i=e.readUint8(),this.seq_tier_0=i>>7&1,this.high_bitdepth=i>>6&1,this.twelve_bit=i>>5&1,this.monochrome=i>>4&1,this.chroma_subsampling_x=i>>3&1,this.chroma_subsampling_y=i>>2&1,this.chroma_sample_position=i&3,i=e.readUint8(),this.reserved_1=i>>5&7,this.reserved_1!==0){u.error("BoxParser","av1C reserved_1 parsing problem",e.isofile);return}if(this.initial_presentation_delay_present=i>>4&1,this.initial_presentation_delay_present===1)this.initial_presentation_delay_minus_one=i&15;else if(this.reserved_2=i&15,this.reserved_2!==0){u.error("BoxParser","av1C reserved_2 parsing problem",e.isofile);return}let r=this.size-this.hdr_size-4;this.configOBUs=e.readUint8Array(r)}};ti.fourcc="av1C";var ii=class extends l{constructor(){super(...arguments);this.box_name="ElementaryStreamDescriptorBox"}parse(e){this.parseFullHeader(e);let i=e.readUint8Array(this.size-this.hdr_size);if("MPEG4DescriptorParser"in ot){let r=new ot.MPEG4DescriptorParser;this.esd=r.parseOneDescriptor(new A(i.buffer,0))}}};ii.fourcc="esds";var ri=class extends l{constructor(){super(...arguments);this.box_name="VPCodecConfigurationRecord"}parse(e){if(this.parseFullHeader(e),this.version===1){this.profile=e.readUint8(),this.level=e.readUint8();let i=e.readUint8();this.bitDepth=i>>4,this.chromaSubsampling=i>>1&7,this.videoFullRangeFlag=i&1,this.colourPrimaries=e.readUint8(),this.transferCharacteristics=e.readUint8(),this.matrixCoefficients=e.readUint8(),this.codecIntializationDataSize=e.readUint16(),this.codecIntializationData=e.readUint8Array(this.codecIntializationDataSize)}else{this.profile=e.readUint8(),this.level=e.readUint8();let i=e.readUint8();this.bitDepth=i>>4&15,this.colorSpace=i&15,i=e.readUint8(),this.chromaSubsampling=i>>4&15,this.transferFunction=i>>1&7,this.videoFullRangeFlag=i&1,this.codecIntializationDataSize=e.readUint16(),this.codecIntializationData=e.readUint8Array(this.codecIntializationDataSize)}}};ri.fourcc="vpcC";var si=class extends l{constructor(){super(...arguments);this.box_name="VvcConfigurationBox"}parse(e){this.parseFullHeader(e);let i={held_bits:void 0,num_held_bits:0,stream_read_1_bytes:function(a){this.held_bits=a.readUint8(),this.num_held_bits=1*8},stream_read_2_bytes:function(a){this.held_bits=a.readUint16(),this.num_held_bits=2*8},extract_bits:function(a){let f=this.held_bits>>this.num_held_bits-a&(1<<a)-1;return this.num_held_bits-=a,f}};if(i.stream_read_1_bytes(e),i.extract_bits(5),this.lengthSizeMinusOne=i.extract_bits(2),this.ptl_present_flag=i.extract_bits(1),this.ptl_present_flag){i.stream_read_2_bytes(e),this.ols_idx=i.extract_bits(9),this.num_sublayers=i.extract_bits(3),this.constant_frame_rate=i.extract_bits(2),this.chroma_format_idc=i.extract_bits(2),i.stream_read_1_bytes(e),this.bit_depth_minus8=i.extract_bits(3),i.extract_bits(5);{if(i.stream_read_2_bytes(e),i.extract_bits(2),this.num_bytes_constraint_info=i.extract_bits(6),this.general_profile_idc=i.extract_bits(7),this.general_tier_flag=i.extract_bits(1),this.general_level_idc=e.readUint8(),i.stream_read_1_bytes(e),this.ptl_frame_only_constraint_flag=i.extract_bits(1),this.ptl_multilayer_enabled_flag=i.extract_bits(1),this.general_constraint_info=new Uint8Array(this.num_bytes_constraint_info),this.num_bytes_constraint_info){for(let a=0;a<this.num_bytes_constraint_info-1;a++){let f=i.extract_bits(6);i.stream_read_1_bytes(e);let d=i.extract_bits(2);this.general_constraint_info[a]=f<<2|d}this.general_constraint_info[this.num_bytes_constraint_info-1]=i.extract_bits(6)}else i.extract_bits(6);if(this.num_sublayers>1){i.stream_read_1_bytes(e),this.ptl_sublayer_present_mask=0;for(let a=this.num_sublayers-2;a>=0;--a){let f=i.extract_bits(1);this.ptl_sublayer_present_mask|=f<<a}for(let a=this.num_sublayers;a<=8&&this.num_sublayers>1;++a)i.extract_bits(1);this.sublayer_level_idc=[];for(let a=this.num_sublayers-2;a>=0;--a)this.ptl_sublayer_present_mask&1<<a&&(this.sublayer_level_idc[a]=e.readUint8())}if(this.ptl_num_sub_profiles=e.readUint8(),this.general_sub_profile_idc=[],this.ptl_num_sub_profiles)for(let a=0;a<this.ptl_num_sub_profiles;a++)this.general_sub_profile_idc.push(e.readUint32())}this.max_picture_width=e.readUint16(),this.max_picture_height=e.readUint16(),this.avg_frame_rate=e.readUint16()}let r=12,s=13;this.nalu_arrays=[];let o=e.readUint8();for(let a=0;a<o;a++){let f=[];this.nalu_arrays.push(f),i.stream_read_1_bytes(e),f.completeness=i.extract_bits(1),i.extract_bits(2),f.nalu_type=i.extract_bits(5);let d=1;f.nalu_type!==s&&f.nalu_type!==r&&(d=e.readUint16());for(let m=0;m<d;m++){let p=e.readUint16();f.push({data:e.readUint8Array(p),length:p})}}}};si.fourcc="vvcC";var ni=class extends c{constructor(){super(...arguments);this.box_name="ColourInformationBox"}parse(e){if(this.colour_type=e.readString(4),this.colour_type==="nclx"){this.colour_primaries=e.readUint16(),this.transfer_characteristics=e.readUint16(),this.matrix_coefficients=e.readUint16();let i=e.readUint8();this.full_range_flag=i>>7}else this.colour_type==="rICC"?this.ICC_profile=e.readUint8Array(this.size-4):this.colour_type==="prof"&&(this.ICC_profile=e.readUint8Array(this.size-4))}};ni.fourcc="colr";function Pe(n,t){let e=Number(n).toString(16);for(t=typeof t=="undefined"?2:t;e.length<t;)e="0"+e;return e}var Le=class extends U{getCodec(){let t=super.getCodec();return this.avcC?`${t}.${Pe(this.avcC.AVCProfileIndication)}${Pe(this.avcC.profile_compatibility)}${Pe(this.avcC.AVCLevelIndication)}`:t}},oi=class extends Le{constructor(){super(...arguments);this.box_name="AVCSampleEntry"}};oi.fourcc="avc1";var ai=class extends Le{constructor(){super(...arguments);this.box_name="AVC2SampleEntry"}};ai.fourcc="avc2";var fi=class extends Le{constructor(){super(...arguments);this.box_name="AVCSampleEntry"}};fi.fourcc="avc3";var li=class extends Le{constructor(){super(...arguments);this.box_name="AVC2SampleEntry"}};li.fourcc="avc4";var di=class extends U{constructor(){super(...arguments);this.box_name="AV1SampleEntry"}getCodec(){let e=super.getCodec(),i=this.av1C.seq_level_idx_0,r=i<10?"0"+i:i,s;return this.av1C.seq_profile===2&&this.av1C.high_bitdepth===1?s=this.av1C.twelve_bit===1?"12":"10":this.av1C.seq_profile<=2&&(s=this.av1C.high_bitdepth===1?"10":"08"),e+"."+this.av1C.seq_profile+"."+r+(this.av1C.seq_tier_0?"H":"M")+"."+s}};di.fourcc="av01";var ui=class extends U{};ui.fourcc="dav1";var Ce=class extends U{getCodec(){let t=super.getCodec();if(this.hvcC){switch(t+=".",this.hvcC.general_profile_space){case 0:t+="";break;case 1:t+="A";break;case 2:t+="B";break;case 3:t+="C";break}t+=this.hvcC.general_profile_idc,t+=".";let e=this.hvcC.general_profile_compatibility,i=0;for(let o=0;o<32&&(i|=e&1,o!==31);o++)i<<=1,e>>=1;t+=Pe(i,0),t+=".",this.hvcC.general_tier_flag===0?t+="L":t+="H",t+=this.hvcC.general_level_idc;let r=!1,s="";for(let o=5;o>=0;o--)(this.hvcC.general_constraint_indicator[o]||r)&&(s="."+Pe(this.hvcC.general_constraint_indicator[o],0)+s,r=!0);t+=s}return t}},ci=class extends Ce{constructor(){super(...arguments);this.box_name="HEVCSampleEntry"}};ci.fourcc="hvc1";var mi=class extends Ce{};mi.fourcc="hvc2";var pi=class extends Ce{constructor(){super(...arguments);this.box_name="HEVCSampleEntry";this.colrs=[];this.subBoxNames=["colr"]}};pi.fourcc="hev1";var hi=class extends Ce{};hi.fourcc="hev2";var _i=class extends U{constructor(){super(...arguments);this.box_name="HEVCTileSampleSampleEntry"}};_i.fourcc="hvt1";var bi=class extends U{constructor(){super(...arguments);this.box_name="LHEVCSampleEntry"}};bi.fourcc="lhe1";var xi=class extends U{constructor(){super(...arguments);this.box_name="LHEVCSampleEntry"}};xi.fourcc="lhv1";var gi=class extends U{};gi.fourcc="dvh1";var yi=class extends U{};yi.fourcc="dvhe";var Qi=class extends U{getCodec(){let t=super.getCodec();if(this.vvcC){t+="."+this.vvcC.general_profile_idc,this.vvcC.general_tier_flag?t+=".H":t+=".L",t+=this.vvcC.general_level_idc;let e="";if(this.vvcC.general_constraint_info){let i=[],r=0;r|=this.vvcC.ptl_frame_only_constraint_flag<<7,r|=this.vvcC.ptl_multilayer_enabled_flag<<6;let s;for(let o=0;o<this.vvcC.general_constraint_info.length;++o)r|=this.vvcC.general_constraint_info[o]>>2&63,i.push(r),r&&(s=o),r=this.vvcC.general_constraint_info[o]>>2&3;if(s===void 0)e=".CA";else{e=".C";let o="ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",a=0,f=0;for(let d=0;d<=s;++d)for(a=a<<8|i[d],f+=8;f>=5;){let m=a>>f-5&31;e+=o[m],f-=5,a&=(1<<f)-1}f&&(a<<=5-f,e+=o[a&31])}}t+=e}return t}},Si=class extends Qi{constructor(){super(...arguments);this.box_name="VvcSampleEntry"}};Si.fourcc="vvc1";var Bi=class extends Qi{constructor(){super(...arguments);this.box_name="VvcSampleEntry"}};Bi.fourcc="vvi1";var Ui=class extends U{constructor(){super(...arguments);this.box_name="VvcSampleEntry"}};Ui.fourcc="vvs1";var wi=class extends U{constructor(){super(...arguments);this.box_name="VvcNonVCLSampleEntry"}};wi.fourcc="vvcN";var Ji=class extends U{getCodec(){let t=super.getCodec(),e=this.vpcC.level;e===0&&(e="00");let i=this.vpcC.bitDepth;return i===8&&(i="08"),`${t}.0${this.vpcC.profile}.${e}.${i}`}},vi=class extends Ji{};vi.fourcc="vp08";var Ai=class extends Ji{};Ai.fourcc="vp09";var Mi=class extends U{};Mi.fourcc="avs3";var Ii=class extends U{constructor(){super(...arguments);this.box_name="J2KSampleEntry"}};Ii.fourcc="j2ki";var zi=class extends U{};zi.fourcc="mjp2";var Ti=class extends U{};Ti.fourcc="mjpg";var ki=class extends U{constructor(){super(...arguments);this.box_name="UncompressedVideoSampleEntry"}};ki.fourcc="uncv";var Fi=class extends U{constructor(){super(...arguments);this.box_name="MP4VisualSampleEntry"}};Fi.fourcc="mp4v";var Ei=class extends E{constructor(){super(...arguments);this.box_name="MP4AudioSampleEntry"}getCodec(){let e=super.getCodec();if(this.esds&&this.esds.esd){let i=this.esds.esd.getOTI(),r=this.esds.esd.getAudioConfig();return e+"."+Pe(i)+(r?"."+r:"")}else return e}};Ei.fourcc="mp4a";var Di=class extends E{};Di.fourcc="m4ae";var Pi=class extends E{};Pi.fourcc="ac-3";var Li=class extends E{};Li.fourcc="ac-4";var Ci=class extends E{};Ci.fourcc="ec-3";var Ni=class extends E{};Ni.fourcc="Opus";var Ri=class extends E{};Ri.fourcc="mha1";var Oi=class extends E{};Oi.fourcc="mha2";var Hi=class extends E{};Hi.fourcc="mhm1";var Vi=class extends E{};Vi.fourcc="mhm2";var Gi=class extends E{};Gi.fourcc="fLaC";var ji=class extends U{};ji.fourcc="encv";var Ki=class extends E{};Ki.fourcc="enca";var $i=class extends N{constructor(){super(...arguments);this.subBoxNames=["sinf"];this.sinfs=[]}};$i.fourcc="encu";var qi=class extends Q{constructor(){super(...arguments);this.subBoxNames=["sinf"];this.sinfs=[]}};qi.fourcc="encs";var Yi=class extends Q{};Yi.fourcc="mp4s";var Wi=class extends at{constructor(){super(...arguments);this.subBoxNames=["sinf"];this.sinfs=[]}};Wi.fourcc="enct";var Xi=class extends O{constructor(){super(...arguments);this.subBoxNames=["sinf"];this.sinfs=[]}};Xi.fourcc="encm";var Zi=class extends U{constructor(){super(...arguments);this.box_name="RestrictedVideoSampleEntry"}};Zi.fourcc="resv";var er=class extends N{parse(t){this.parseHeader(t),this.content_encoding=t.readCString(),this.mime_format=t.readCString(),this.parseFooter(t)}};er.fourcc="sbtt";var Ne=class extends N{parse(t){this.parseHeader(t),this.namespace=t.readCString(),this.schema_location=t.readCString(),this.auxiliary_mime_types=t.readCString(),this.parseFooter(t)}write(t){this.writeHeader(t),this.size+=this.namespace.length+1+this.schema_location.length+1+this.auxiliary_mime_types.length+1,t.writeCString(this.namespace),t.writeCString(this.schema_location),t.writeCString(this.auxiliary_mime_types),this.writeFooter(t)}};Ne.fourcc="stpp";var tr=class extends N{parse(t){this.parseHeader(t),this.content_encoding=t.readCString(),this.mime_format=t.readCString(),this.parseFooter(t)}getCodec(){let t=super.getCodec();return this.mime_format?t+"."+this.mime_format:t}};tr.fourcc="stxt";var ir=class extends N{parse(t){this.parseHeader(t),this.displayFlags=t.readUint32(),this.horizontal_justification=t.readInt8(),this.vertical_justification=t.readInt8(),this.bg_color_rgba=t.readUint8Array(4),this.box_record=t.readInt16Array(4),this.style_record=t.readUint8Array(12),this.parseFooter(t)}};ir.fourcc="tx3g";var rr=class extends O{parse(t){this.parseHeader(t),this.parseFooter(t)}};rr.fourcc="wvtt";var sr=class extends l{constructor(){super(...arguments);this.box_name="SampleToGroupBox"}parse(e){this.parseFullHeader(e),this.grouping_type=e.readString(4),this.version===1?this.grouping_type_parameter=e.readUint32():this.grouping_type_parameter=0,this.entries=[];let i=e.readUint32();for(let r=0;r<i;r++)this.entries.push({sample_count:e.readInt32(),group_description_index:e.readInt32()})}write(e){this.grouping_type_parameter?this.version=1:this.version=0,this.flags=0,this.size=8+8*this.entries.length+(this.version===1?4:0),this.writeHeader(e),e.writeString(this.grouping_type,void 0,4),this.version===1&&e.writeUint32(this.grouping_type_parameter),e.writeUint32(this.entries.length);for(let i=0;i<this.entries.length;i++){let r=this.entries[i];e.writeInt32(r.sample_count),e.writeInt32(r.group_description_index)}}};sr.fourcc="sbgp";var nr=class extends l{constructor(){super(...arguments);this.box_name="SampleDependencyTypeBox"}parse(e){this.parseFullHeader(e);let i=this.size-this.hdr_size;this.is_leading=[],this.sample_depends_on=[],this.sample_is_depended_on=[],this.sample_has_redundancy=[];for(let r=0;r<i;r++){let s=e.readUint8();this.is_leading[r]=s>>6,this.sample_depends_on[r]=s>>4&3,this.sample_is_depended_on[r]=s>>2&3,this.sample_has_redundancy[r]=s&3}}};nr.fourcc="sdtp";var or=class extends l{constructor(){super(...arguments);this.box_name="SampleGroupDescriptionBox"}parse(e){this.parseFullHeader(e),this.grouping_type=e.readString(4),u.debug("BoxParser","Found Sample Groups of type "+this.grouping_type),this.version===1?this.default_length=e.readUint32():this.default_length=0,this.version>=2&&(this.default_group_description_index=e.readUint32()),this.entries=[];let i=e.readUint32();for(let r=0;r<i;r++){let s;this.grouping_type in P.sampleGroupEntry?s=new P.sampleGroupEntry[this.grouping_type](this.grouping_type):s=new x(this.grouping_type),this.entries.push(s),this.version===1?this.default_length===0?s.description_length=e.readUint32():s.description_length=this.default_length:s.description_length=this.default_length,s.write===x.prototype.write&&(u.info("BoxParser","SampleGroup for type "+this.grouping_type+" writing not yet implemented, keeping unparsed data in memory for later write"),s.data=e.readUint8Array(s.description_length),e.seek(e.getPosition()-s.description_length)),s.parse(e)}}write(e){this.flags=0,this.size=12;for(let i=0;i<this.entries.length;i++){let r=this.entries[i];this.version===1&&(this.default_length===0&&(this.size+=4),this.size+=r.data.length)}this.writeHeader(e),e.writeString(this.grouping_type,void 0,4),this.version===1&&e.writeUint32(this.default_length),this.version>=2&&e.writeUint32(this.default_sample_description_index),e.writeUint32(this.entries.length);for(let i=0;i<this.entries.length;i++){let r=this.entries[i];this.version===1&&this.default_length===0&&e.writeUint32(r.description_length),r.write(e)}}};or.fourcc="sgpd";var ar=class extends l{constructor(){super(...arguments);this.box_name="CompressedSegmentIndexBox"}parse(e){this.parseFullHeader(e),this.reference_ID=e.readUint32(),this.timescale=e.readUint32(),this.version===0?(this.earliest_presentation_time=e.readUint32(),this.first_offset=e.readUint32()):(this.earliest_presentation_time=e.readUint64(),this.first_offset=e.readUint64()),e.readUint16(),this.references=[];let i=e.readUint16();for(let r=0;r<i;r++){let s=e.readUint32(),o=e.readUint32(),a=e.readUint32();this.references.push({reference_type:s>>31&1,referenced_size:s&2147483647,subsegment_duration:o,starts_with_SAP:a>>31&1,SAP_type:a>>28&7,SAP_delta_time:a&268435455})}}write(e){let i=this.earliest_presentation_time>w||this.first_offset>w||this.version===1;this.version=i?1:0,this.size=4*2+2+2+12*this.references.length,this.size+=i?16:8,this.flags=0,this.writeHeader(e),e.writeUint32(this.reference_ID),e.writeUint32(this.timescale),i?(e.writeUint64(this.earliest_presentation_time),e.writeUint64(this.first_offset)):(e.writeUint32(this.earliest_presentation_time),e.writeUint32(this.first_offset)),e.writeUint16(0),e.writeUint16(this.references.length);for(let r=0;r<this.references.length;r++){let s=this.references[r];e.writeUint32(s.reference_type<<31|s.referenced_size),e.writeUint32(s.subsegment_duration),e.writeUint32(s.starts_with_SAP<<31|s.SAP_type<<28|s.SAP_delta_time)}}};ar.fourcc="sidx";var Re=class extends l{constructor(){super(...arguments);this.box_name="SoundMediaHeaderBox"}parse(e){this.parseFullHeader(e),this.balance=e.readUint16(),e.readUint16()}write(e){this.version=0,this.size=4,this.writeHeader(e),e.writeUint16(this.balance),e.writeUint16(0)}};Re.fourcc="smhd";var Oe=class extends l{constructor(){super(...arguments);this.box_name="ChunkOffsetBox"}parse(e){this.parseFullHeader(e);let i=e.readUint32();if(this.chunk_offsets=[],this.version===0)for(let r=0;r<i;r++)this.chunk_offsets.push(e.readUint32())}write(e){this.version=0,this.flags=0,this.size=4+4*this.chunk_offsets.length,this.writeHeader(e),e.writeUint32(this.chunk_offsets.length),e.writeUint32Array(this.chunk_offsets)}unpack(e){for(let i=0;i<this.chunk_offsets.length;i++)e[i].offset=this.chunk_offsets[i]}};Oe.fourcc="stco";var He=class extends l{constructor(){super(...arguments);this.box_name="SubtitleMediaHeaderBox"}};He.fourcc="sthd";var Ve=class extends l{constructor(){super(...arguments);this.box_name="SampleToChunkBox"}parse(e){this.parseFullHeader(e);let i=e.readUint32();if(this.first_chunk=[],this.samples_per_chunk=[],this.sample_description_index=[],this.version===0)for(let r=0;r<i;r++)this.first_chunk.push(e.readUint32()),this.samples_per_chunk.push(e.readUint32()),this.sample_description_index.push(e.readUint32())}write(e){this.version=0,this.flags=0,this.size=4+12*this.first_chunk.length,this.writeHeader(e),e.writeUint32(this.first_chunk.length);for(let i=0;i<this.first_chunk.length;i++)e.writeUint32(this.first_chunk[i]),e.writeUint32(this.samples_per_chunk[i]),e.writeUint32(this.sample_description_index[i])}unpack(e){let i=0,r=0;for(let s=0;s<this.first_chunk.length;s++)for(let o=0;o<(s+1<this.first_chunk.length?this.first_chunk[s+1]:1/0);o++){r++;for(let a=0;a<this.samples_per_chunk[s];a++){if(e[i])e[i].description_index=this.sample_description_index[s],e[i].chunk_index=r;else return;i++}}}};Ve.fourcc="stsc";var Ge=class extends l{constructor(){super(...arguments);this.box_name="SampleDescriptionBox"}parse(e){this.parseFullHeader(e),this.entries=[];let i=e.readUint32();for(let r=1;r<=i;r++){let s=z(e,!0,this.size-(e.getPosition()-this.start));if(s.code===v){let o;s.type in P.sampleEntry?(o=new P.sampleEntry[s.type](s.size),o.hdr_size=s.hdr_size,o.start=s.start):(u.warn("BoxParser",`Unknown sample entry type: '${s.type}'`),o=new R(s.size,s.hdr_size,s.start),o.type=s.type),o.write===R.prototype.write&&(u.info("BoxParser","SampleEntry "+o.type+" box writing not yet implemented, keeping unparsed data in memory for later write"),o.parseDataAndRewind(e)),o.parse(e),this.entries.push(o)}else return}}write(e){this.version=0,this.flags=0,this.size=0,this.writeHeader(e),e.writeUint32(this.entries.length),this.size+=4;for(let i=0;i<this.entries.length;i++)this.entries[i].write(e),this.size+=this.entries[i].size;u.debug("BoxWriter","Adjusting box "+this.type+" with new size "+this.size),e.adjustUint32(this.sizePosition,this.size)}};Ge.fourcc="stsd";var je=class extends l{constructor(){super(...arguments);this.box_name="SampleSizeBox"}parse(e){if(this.parseFullHeader(e),this.sample_sizes=[],this.version===0){this.sample_size=e.readUint32(),this.sample_count=e.readUint32();for(let i=0;i<this.sample_count;i++)this.sample_size===0?this.sample_sizes.push(e.readUint32()):this.sample_sizes[i]=this.sample_size}}write(e){let i=!0;if(this.version=0,this.flags=0,this.sample_sizes.length>0){let r=0;for(;r+1<this.sample_sizes.length;)if(this.sample_sizes[r+1]!==this.sample_sizes[0]){i=!1;break}else r++}else i=!1;this.size=8,i||(this.size+=4*this.sample_sizes.length),this.writeHeader(e),i?e.writeUint32(this.sample_sizes[0]):e.writeUint32(0),e.writeUint32(this.sample_sizes.length),i||e.writeUint32Array(this.sample_sizes)}unpack(e){for(let i=0;i<this.sample_sizes.length;i++)e[i].size=this.sample_sizes[i]}};je.fourcc="stsz";var Ke=class extends l{constructor(){super(...arguments);this.box_name="TimeToSampleBox";this.sample_counts=[];this.sample_deltas=[]}parse(e){this.parseFullHeader(e);let i=e.readUint32();if(this.sample_counts.length=0,this.sample_deltas.length=0,this.version===0)for(let r=0;r<i;r++){this.sample_counts.push(e.readUint32());let s=e.readInt32();s<0&&(u.warn("BoxParser","File uses negative stts sample delta, using value 1 instead, sync may be lost!"),s=1),this.sample_deltas.push(s)}}write(e){this.version=0,this.flags=0,this.size=4+8*this.sample_counts.length,this.writeHeader(e),e.writeUint32(this.sample_counts.length);for(let i=0;i<this.sample_counts.length;i++)e.writeUint32(this.sample_counts[i]),e.writeUint32(this.sample_deltas[i])}unpack(e){let i=0;for(let r=0;r<this.sample_counts.length;r++)for(let s=0;s<this.sample_counts[r];s++)i===0?e[i].dts=0:e[i].dts=e[i-1].dts+this.sample_deltas[r],i++}};Ke.fourcc="stts";var $e=class extends l{constructor(){super(...arguments);this.box_name="TrackFragmentBaseMediaDecodeTimeBox"}parse(e){this.parseFullHeader(e),this.version===1?this.baseMediaDecodeTime=e.readUint64():this.baseMediaDecodeTime=e.readUint32()}write(e){let i=this.baseMediaDecodeTime>w||this.version===1;this.version=i?1:0,this.size=4,this.size+=i?4:0,this.flags=0,this.writeHeader(e),i?e.writeUint64(this.baseMediaDecodeTime):e.writeUint32(this.baseMediaDecodeTime)}};$e.fourcc="tfdt";var qe=class extends l{constructor(){super(...arguments);this.box_name="TrackFragmentHeaderBox"}parse(e){this.parseFullHeader(e);let i=0;this.track_id=e.readUint32(),this.size-this.hdr_size>i&&this.flags&de?(this.base_data_offset=e.readUint64(),i+=8):this.base_data_offset=0,this.size-this.hdr_size>i&&this.flags&ue?(this.default_sample_description_index=e.readUint32(),i+=4):this.default_sample_description_index=0,this.size-this.hdr_size>i&&this.flags&ce?(this.default_sample_duration=e.readUint32(),i+=4):this.default_sample_duration=0,this.size-this.hdr_size>i&&this.flags&me?(this.default_sample_size=e.readUint32(),i+=4):this.default_sample_size=0,this.size-this.hdr_size>i&&this.flags&pe?(this.default_sample_flags=e.readUint32(),i+=4):this.default_sample_flags=0}write(e){this.version=0,this.size=4,this.flags&de&&(this.size+=8),this.flags&ue&&(this.size+=4),this.flags&ce&&(this.size+=4),this.flags&me&&(this.size+=4),this.flags&pe&&(this.size+=4),this.writeHeader(e),e.writeUint32(this.track_id),this.flags&de&&e.writeUint64(this.base_data_offset),this.flags&ue&&e.writeUint32(this.default_sample_description_index),this.flags&ce&&e.writeUint32(this.default_sample_duration),this.flags&me&&e.writeUint32(this.default_sample_size),this.flags&pe&&e.writeUint32(this.default_sample_flags)}};qe.fourcc="tfhd";var Ye=class extends l{constructor(){super(...arguments);this.box_name="TrackHeaderBox";this.layer=0;this.alternate_group=0}parse(e){this.parseFullHeader(e),this.version===1?(this.creation_time=e.readUint64(),this.modification_time=e.readUint64(),this.track_id=e.readUint32(),e.readUint32(),this.duration=e.readUint64()):(this.creation_time=e.readUint32(),this.modification_time=e.readUint32(),this.track_id=e.readUint32(),e.readUint32(),this.duration=e.readUint32()),e.readUint32Array(2),this.layer=e.readInt16(),this.alternate_group=e.readInt16(),this.volume=e.readInt16()>>8,e.readUint16(),this.matrix=e.readInt32Array(9),this.width=e.readUint32(),this.height=e.readUint32()}write(e){var r;let i=this.modification_time>w||this.creation_time>w||this.duration>w||this.version===1;this.version=i?1:0,this.size=5*4+15*4,this.size+=i?3*4:0,this.flags=(r=this.flags)!=null?r:3,this.writeHeader(e),i?(e.writeUint64(this.creation_time),e.writeUint64(this.modification_time),e.writeUint32(this.track_id),e.writeUint32(0),e.writeUint64(this.duration)):(e.writeUint32(this.creation_time),e.writeUint32(this.modification_time),e.writeUint32(this.track_id),e.writeUint32(0),e.writeUint32(this.duration)),e.writeUint32Array([0,0]),e.writeInt16(this.layer),e.writeInt16(this.alternate_group),e.writeInt16(this.volume<<8),e.writeInt16(0),e.writeInt32Array(this.matrix),e.writeUint32(this.width),e.writeUint32(this.height)}print(e){super.printHeader(e),e.log(e.indent+"creation_time: "+this.creation_time),e.log(e.indent+"modification_time: "+this.modification_time),e.log(e.indent+"track_id: "+this.track_id),e.log(e.indent+"duration: "+this.duration),e.log(e.indent+"volume: "+(this.volume>>8)),e.log(e.indent+"matrix: "+this.matrix.join(", ")),e.log(e.indent+"layer: "+this.layer),e.log(e.indent+"alternate_group: "+this.alternate_group),e.log(e.indent+"width: "+this.width),e.log(e.indent+"height: "+this.height)}};Ye.fourcc="tkhd";var fe=class extends l{constructor(){super(...arguments);this.box_name="TrackExtendsBox"}parse(e){this.parseFullHeader(e),this.track_id=e.readUint32(),this.default_sample_description_index=e.readUint32(),this.default_sample_duration=e.readUint32(),this.default_sample_size=e.readUint32(),this.default_sample_flags=e.readUint32()}write(e){this.version=0,this.flags=0,this.size=4*5,this.writeHeader(e),e.writeUint32(this.track_id),e.writeUint32(this.default_sample_description_index),e.writeUint32(this.default_sample_duration),e.writeUint32(this.default_sample_size),e.writeUint32(this.default_sample_flags)}};fe.fourcc="trex";var We=class extends l{constructor(){super(...arguments);this.box_name="TrackRunBox";this.sample_duration=[];this.sample_size=[];this.sample_flags=[];this.sample_composition_time_offset=[]}parse(e){this.parseFullHeader(e);let i=0;if(this.sample_count=e.readUint32(),i+=4,this.size-this.hdr_size>i&&this.flags&ie?(this.data_offset=e.readInt32(),i+=4):this.data_offset=0,this.size-this.hdr_size>i&&this.flags&he?(this.first_sample_flags=e.readUint32(),i+=4):this.first_sample_flags=0,this.sample_duration=[],this.sample_size=[],this.sample_flags=[],this.sample_composition_time_offset=[],this.size-this.hdr_size>i)for(let r=0;r<this.sample_count;r++)this.flags&re&&(this.sample_duration[r]=e.readUint32()),this.flags&se&&(this.sample_size[r]=e.readUint32()),this.flags&ne&&(this.sample_flags[r]=e.readUint32()),this.flags&oe&&(this.version===0?this.sample_composition_time_offset[r]=e.readUint32():this.sample_composition_time_offset[r]=e.readInt32())}write(e){this.size=4,this.flags&ie&&(this.size+=4),this.flags&he&&(this.size+=4),this.flags&re&&(this.size+=4*this.sample_duration.length),this.flags&se&&(this.size+=4*this.sample_size.length),this.flags&ne&&(this.size+=4*this.sample_flags.length),this.flags&oe&&(this.size+=4*this.sample_composition_time_offset.length),this.writeHeader(e),e.writeUint32(this.sample_count),this.flags&ie&&(this.data_offset_position=e.getPosition(),e.writeInt32(this.data_offset)),this.flags&he&&e.writeUint32(this.first_sample_flags);for(let i=0;i<this.sample_count;i++)this.flags&re&&e.writeUint32(this.sample_duration[i]),this.flags&se&&e.writeUint32(this.sample_size[i]),this.flags&ne&&e.writeUint32(this.sample_flags[i]),this.flags&oe&&(this.version===0?e.writeUint32(this.sample_composition_time_offset[i]):e.writeInt32(this.sample_composition_time_offset[i]))}};We.fourcc="trun";var Xe=class extends l{constructor(){super(...arguments);this.box_name="DataEntryUrlBox"}parse(e){this.parseFullHeader(e),this.flags!==1&&(this.location=e.readCString())}write(e){this.version=0,this.location?(this.flags=0,this.size=this.location.length+1):(this.flags=1,this.size=0),this.writeHeader(e),this.location&&e.writeCString(this.location)}};Xe.fourcc="url ";var Ze=class extends l{constructor(){super(...arguments);this.box_name="VideoMediaHeaderBox"}parse(e){this.parseFullHeader(e),this.graphicsmode=e.readUint16(),this.opcolor=e.readUint16Array(3)}write(e){this.version=0,this.size=8,this.writeHeader(e),e.writeUint16(this.graphicsmode),e.writeUint16Array(this.opcolor)}};Ze.fourcc="vmhd";var Qe=class{constructor(t,e,i){this.grouping_type=t;this.grouping_type_parameter=e;this.sbgp=i;this.last_sample_in_run=-1;this.entry_index=-1}},dt=class n{constructor(t,e=!0){this.boxes=[];this.mdats=[];this.moofs=[];this.isProgressive=!1;this.moovStartFound=!1;this.moovStartSent=!1;this.readySent=!1;this.sampleListBuilt=!1;this.fragmentedTracks=[];this.extractedTracks=[];this.isFragmentationInitialized=!1;this.sampleProcessingStarted=!1;this.nextMoofNumber=0;this.itemListBuilt=!1;this.sidxSent=!1;this.items=[];this.entity_groups=[];this.itemsDataSize=0;this.lastMoofIndex=0;this.samplesDataSize=0;this.lastBoxStartPosition=0;this.nextParsePosition=0;this.discardMdatData=!0;this.discardMdatData=e,t?(this.stream=t,this.parse()):this.stream=new V,this.stream.isofile=this}setSegmentOptions(t,e,i){var d,m,p;let{sizePerSegment:r=Number.MAX_SAFE_INTEGER,rapAlignement:s=!0}=i,o=(m=(d=i.nbSamples)!=null?d:i.nbSamplesPerFragment)!=null?m:1e3,a=(p=i.nbSamplesPerFragment)!=null?p:o;if(o<=0||a<=0||r<=0){u.error("ISOFile",`Invalid segment options: nbSamples=${o}, nbSamplesPerFragment=${a}, sizePerSegment=${r}`);return}if(o<a&&(u.warn("ISOFile",`nbSamples (${o}) is less than nbSamplesPerFragment (${a}), setting nbSamples to nbSamplesPerFragment`),o=a),this.fragmentedTracks.some(h=>h.nb_samples!==o)){u.error("ISOFile",`Cannot set segment options for track ${t}: nbSamples (${o}) does not match existing tracks`);return}let f=this.getTrackById(t);if(f){let h={id:t,user:e,trak:f,segmentStream:void 0,nb_samples:o,nb_samples_per_fragment:a,size_per_segment:r,rapAlignement:s,state:{lastFragmentSampleNumber:0,lastSegmentSampleNumber:0,accumulatedSize:0}};this.fragmentedTracks.push(h),f.nextSample=0}this.discardMdatData&&u.warn("ISOFile","Segmentation options set but discardMdatData is true, samples will not be segmented")}unsetSegmentOptions(t){let e=-1;for(let i=0;i<this.fragmentedTracks.length;i++)this.fragmentedTracks[i].id===t&&(e=i);e>-1&&this.fragmentedTracks.splice(e,1)}setExternalSegmentBoundaries(t,e,i,{rapAlignement:r=!0}={}){if(!Array.isArray(i)||i.length===0){u.error("ISOFile",`Cannot set external segment boundaries for track ${t}: empty list`);return}let s=i.filter(a=>Number.isFinite(a)&&a>0).map(a=>Math.floor(a)).sort((a,f)=>a-f);if(s.length===0){u.error("ISOFile",`Cannot set external segment boundaries for track ${t}: no valid positive numbers`);return}this.unsetSegmentOptions(t);let o=this.getTrackById(t);if(o){let a={id:t,user:e,trak:o,segmentStream:void 0,nb_samples:Number.MAX_SAFE_INTEGER,nb_samples_per_fragment:Number.MAX_SAFE_INTEGER,size_per_segment:Number.MAX_SAFE_INTEGER,rapAlignement:r,external_segment_boundaries:s,state:{lastFragmentSampleNumber:0,lastSegmentSampleNumber:0,accumulatedSize:0,nextBoundaryIndex:0}};this.fragmentedTracks.push(a),o.nextSample=0}this.discardMdatData&&u.warn("ISOFile","Segmentation options set but discardMdatData is true, samples will not be segmented")}setExtractionOptions(t,e,{nbSamples:i=1e3}={}){let r=this.getTrackById(t);r&&(this.extractedTracks.push({id:t,user:e,trak:r,nb_samples:i,samples:[]}),r.nextSample=0),this.discardMdatData&&u.warn("ISOFile","Extraction options set but discardMdatData is true, samples will not be extracted")}unsetExtractionOptions(t){let e=-1;for(let i=0;i<this.extractedTracks.length;i++)this.extractedTracks[i].id===t&&(e=i);e>-1&&this.extractedTracks.splice(e,1)}parse(){if(!(this.restoreParsePosition&&!this.restoreParsePosition()))for(;;)if(this.hasIncompleteMdat&&this.hasIncompleteMdat()){if(this.processIncompleteMdat())continue;return}else{this.saveParsePosition&&this.saveParsePosition();let e=z(this.stream,!1);if(e.code===K)if(this.processIncompleteBox){if(this.processIncompleteBox(e))continue;return}else return;else if(e.code===v){let i=e.box;if(this.boxes.push(i),i.type==="uuid")this[i.uuid]!==void 0&&u.warn("ISOFile","Duplicate Box of uuid: "+i.uuid+", overriding previous occurrence"),this[i.uuid]=i;else switch(i.type){case"mdat":this.mdats.push(i),this.transferMdatData(i);break;case"moof":this.moofs.push(i);break;case"free":case"skip":break;case"moov":this.moovStartFound=!0,this.mdats.length===0&&(this.isProgressive=!0);default:this[i.type]!==void 0?Array.isArray(this[i.type+"s"])?(u.info("ISOFile",`Found multiple boxes of type ${i.type} in ISOFile, adding to array`),this[i.type+"s"].push(i)):(u.warn("ISOFile",`Found multiple boxes of type ${i.type} but no array exists. Creating array dynamically.`),this[i.type+"s"]=[this[i.type],i]):(this[i.type]=i,Array.isArray(this[i.type+"s"])&&this[i.type+"s"].push(i));break}this.updateUsedBytes&&this.updateUsedBytes(i,e)}else if(e.code===bt){u.error("ISOFile",`Invalid data found while parsing box of type '${e.type}' at position ${e.start}. Aborting parsing.`,this);break}}}checkBuffer(t){if(!t)throw new Error("Buffer must be defined and non empty");return t.byteLength===0?(u.warn("ISOFile","Ignoring empty buffer (fileStart: "+t.fileStart+")"),this.stream.logBufferLevel(),!1):(u.info("ISOFile","Processing buffer (fileStart: "+t.fileStart+")"),t.usedBytes=0,this.stream.insertBuffer(t),this.stream.logBufferLevel(),this.stream.initialized()?!0:(u.warn("ISOFile","Not ready to start parsing"),!1))}appendBuffer(t,e){let i;if(this.checkBuffer(t))return this.parse(),this.moovStartFound&&!this.moovStartSent&&(this.moovStartSent=!0,this.onMoovStart&&this.onMoovStart()),this.moov?(this.sampleListBuilt||(this.buildSampleLists(),this.sampleListBuilt=!0),this.updateSampleLists(),this.onReady&&!this.readySent&&(this.readySent=!0,this.onReady(this.getInfo())),this.processSamples(e),this.nextSeekPosition?(i=this.nextSeekPosition,this.nextSeekPosition=void 0):i=this.nextParsePosition,this.stream.getEndFilePositionAfter&&(i=this.stream.getEndFilePositionAfter(i))):this.nextParsePosition?i=this.nextParsePosition:i=0,this.sidx&&this.onSidx&&!this.sidxSent&&(this.onSidx(this.sidx),this.sidxSent=!0),this.meta&&(this.flattenItemInfo&&!this.itemListBuilt&&(this.flattenItemInfo(),this.itemListBuilt=!0),this.processItems&&this.processItems(this.onItem)),this.stream.cleanBuffers&&(u.info("ISOFile","Done processing buffer (fileStart: "+t.fileStart+") - next buffer to fetch should have a fileStart position of "+i),this.stream.logBufferLevel(),this.stream.cleanBuffers(),this.stream.logBufferLevel(!0),u.info("ISOFile","Sample data size in memory: "+this.getAllocatedSampleDataSize())),i}getFragmentDuration(){let t=this.getBox("mvex");if(!t)return;if(t.mehd)return{num:t.mehd.fragment_duration,den:this.moov.mvhd.timescale};let e=this.getBoxes("trak",!1),i={num:0,den:1};for(let r of e){let s=r.samples_duration,o=r.mdia.mdhd.timescale;s&&o&&s/o>i.num/i.den&&(i={num:s,den:o})}return i}getInfo(){if(!this.moov)return{hasMoov:!1,mime:""};let t=new Date("1904-01-01T00:00:00Z").getTime(),e=this.getBox("mvex")!==void 0,i={hasMoov:!0,duration:this.moov.mvhd.duration,timescale:this.moov.mvhd.timescale,isFragmented:e,fragment_duration:this.getFragmentDuration(),isProgressive:this.isProgressive,hasIOD:this.moov.iods!==void 0,brands:[this.ftyp.major_brand].concat(this.ftyp.compatible_brands),created:new Date(t+this.moov.mvhd.creation_time*1e3),modified:new Date(t+this.moov.mvhd.modification_time*1e3),tracks:[],audioTracks:[],videoTracks:[],subtitleTracks:[],metadataTracks:[],hintTracks:[],otherTracks:[],mime:""};for(let r=0;r<this.moov.traks.length;r++){let s=this.moov.traks[r],o=s.mdia.minf.stbl.stsd.entries[0],a=s.samples_size,f=s.mdia.mdhd.timescale,d=s.samples_duration,m=a*8*f/d,p={samples_duration:d,bitrate:m,size:a,timescale:f,alternate_group:s.tkhd.alternate_group,codec:o.getCodec(),created:new Date(t+s.tkhd.creation_time*1e3),cts_shift:s.mdia.minf.stbl.cslg,duration:s.mdia.mdhd.duration,id:s.tkhd.track_id,kind:s.udta&&s.udta.kinds.length?s.udta.kinds[0]:{schemeURI:"",value:""},language:s.mdia.elng?s.mdia.elng.extended_language:s.mdia.mdhd.languageString,layer:s.tkhd.layer,matrix:s.tkhd.matrix,modified:new Date(t+s.tkhd.modification_time*1e3),movie_duration:s.tkhd.duration,movie_timescale:i.timescale,name:s.mdia.hdlr.name,nb_samples:s.samples.length,references:[],track_height:s.tkhd.height/65536,track_width:s.tkhd.width/65536,volume:s.tkhd.volume};if(i.tracks.push(p),s.tref)for(let h=0;h<s.tref.references.length;h++)p.references.push({type:s.tref.references[h].type,track_ids:s.tref.references[h].track_ids});s.edts!==void 0&&s.edts.elst!==void 0&&(p.edits=s.edts.elst.entries),o instanceof E?(p.type="audio",i.audioTracks.push(p),p.audio={sample_rate:o.getSampleRate(),channel_count:o.getChannelCount(),sample_size:o.getSampleSize()}):o instanceof U?(p.type="video",i.videoTracks.push(p),p.video={width:o.getWidth(),height:o.getHeight()}):o instanceof N?(p.type="subtitles",i.subtitleTracks.push(p)):o instanceof _e?(p.type="metadata",i.hintTracks.push(p)):o instanceof O?(p.type="metadata",i.metadataTracks.push(p)):(p.type="metadata",i.otherTracks.push(p))}i.videoTracks&&i.videoTracks.length>0?i.mime+='video/mp4; codecs="':i.audioTracks&&i.audioTracks.length>0?i.mime+='audio/mp4; codecs="':i.mime+='application/mp4; codecs="';for(let r=0;r<i.tracks.length;r++)r!==0&&(i.mime+=","),i.mime+=i.tracks[r].codec;return i.mime+='"; profiles="',i.mime+=this.ftyp.compatible_brands.join(),i.mime+='"',i}setNextSeekPositionFromSample(t){t&&(this.nextSeekPosition?this.nextSeekPosition=Math.min(t.offset+t.alreadyRead,this.nextSeekPosition):this.nextSeekPosition=t.offset+t.alreadyRead)}processSamples(t){var e;if(this.sampleProcessingStarted){if(this.isFragmentationInitialized&&this.onSegment!==void 0){let i=new Set;for(;i.size<this.fragmentedTracks.length&&this.fragmentedTracks.some(r=>r.trak.nextSample<r.trak.samples.length)&&this.sampleProcessingStarted;)for(let r of this.fragmentedTracks){let s=r.trak;if(!i.has(r.id)){let o=s.nextSample<s.samples.length?this.getSample(s,s.nextSample):void 0;if(!o){this.setNextSeekPositionFromSample(s.samples[s.nextSample]),i.add(r.id);continue}r.state.accumulatedSize+=o.size;let a=s.nextSample+1,f=r.external_segment_boundaries!==void 0&&r.external_segment_boundaries.length>0,d=(e=r.state.nextBoundaryIndex)!=null?e:0,m=f?r.external_segment_boundaries[d]:void 0,p=m!==void 0&&a>=m,h=a-r.state.lastFragmentSampleNumber>r.nb_samples_per_fragment,_=a-r.state.lastSegmentSampleNumber>r.nb_samples,y=h||a%r.nb_samples_per_fragment===0,b=_||a%r.nb_samples===0,I=r.state.accumulatedSize>=r.size_per_segment,M=!r.rapAlignement||o.is_sync,T=t||s.nextSample+1>=s.samples.length;if(T&&!M&&u.warn("ISOFile","Flushing track #"+r.id+" at sample #"+s.nextSample+" which is not a RAP, this may lead to playback issues"),y=y&&M,b=(f?p:b)&&M,I=!f&&I&&M,f&&(y=p&&M),y||I||T){h?u.warn("ISOFile","Fragment on track #"+r.id+" is overdue, creating it with samples ["+r.state.lastFragmentSampleNumber+", "+s.nextSample+"]"):u.debug("ISOFile","Creating media fragment on track #"+r.id+" for samples ["+r.state.lastFragmentSampleNumber+", "+s.nextSample+"]");let D=this.createFragment(r.id,r.state.lastFragmentSampleNumber,s.nextSample,r.segmentStream);if(D)r.segmentStream=D,r.state.lastFragmentSampleNumber=s.nextSample+1;else{i.add(r.id);continue}}(b||I||T)&&(_?u.warn("ISOFile","Segment on track #"+r.id+" is overdue, sending it with samples ["+Math.max(0,s.nextSample-r.nb_samples)+", "+(s.nextSample-1)+"]"):u.info("ISOFile","Sending fragmented data on track #"+r.id+" for samples ["+Math.max(0,s.nextSample-r.nb_samples)+", "+(s.nextSample-1)+"]"),u.info("ISOFile","Sample data size in memory: "+this.getAllocatedSampleDataSize()),this.onSegment&&this.onSegment(r.id,r.user,r.segmentStream.buffer,s.nextSample+1,t||s.nextSample+1>=s.samples.length),f&&b&&(r.state.nextBoundaryIndex=d+1),r.segmentStream=void 0,r.state.accumulatedSize=0,r.state.lastSegmentSampleNumber=s.nextSample+1),s.nextSample++}}}if(this.onSamples!==void 0)for(let i=0;i<this.extractedTracks.length;i++){let r=this.extractedTracks[i],s=r.trak;for(;s.nextSample<s.samples.length&&this.sampleProcessingStarted;){u.debug("ISOFile","Exporting on track #"+r.id+" sample #"+s.nextSample);let o=this.getSample(s,s.nextSample);if(o)s.nextSample++,r.samples.push(o);else{this.setNextSeekPositionFromSample(s.samples[s.nextSample]);break}if((s.nextSample%r.nb_samples===0||s.nextSample>=s.samples.length)&&(u.debug("ISOFile","Sending samples on track #"+r.id+" for sample "+s.nextSample),this.onSamples&&this.onSamples(r.id,r.user,r.samples),r.samples=[],r!==this.extractedTracks[i]))break}}}}getBox(t){let e=this.getBoxes(t,!0);return e.length?e[0]:void 0}getBoxes(t,e){let i=[],r=s=>{s instanceof c&&s.type&&s.type===t&&i.push(s);let o=[];s.boxes&&o.push(...s.boxes),s.entries&&o.push(...s.entries),s.item_infos&&o.push(...s.item_infos),s.references&&o.push(...s.references);for(let a of o){if(i.length&&e)return;r(a)}};return r(this),i}getTrackSamplesInfo(t){let e=this.getTrackById(t);if(e)return e.samples}getTrackSample(t,e){let i=this.getTrackById(t);return this.getSample(i,e)}releaseUsedSamples(t,e){let i=0,r=this.getTrackById(t);r.lastValidSample||(r.lastValidSample=0);for(let s=r.lastValidSample;s<e;s++)i+=this.releaseSample(r,s);u.info("ISOFile","Track #"+t+" released samples up to "+e+" (released size: "+i+", remaining: "+this.samplesDataSize+")"),r.lastValidSample=e}start(){this.sampleProcessingStarted=!0,this.processSamples(!1)}stop(){this.sampleProcessingStarted=!1}flush(){u.info("ISOFile","Flushing remaining samples"),this.updateSampleLists(),this.processSamples(!0),this.stream.cleanBuffers(),this.stream.logBufferLevel(!0)}seekTrack(t,e,i){let r=0,s=0,o;if(i.samples.length===0)return u.info("ISOFile","No sample in track, cannot seek! Using time "+u.getDurationString(0,1)+" and offset: 0"),{offset:0,time:0};for(let f=0;f<i.samples.length;f++){let d=i.samples[f];if(f===0)s=0,o=d.timescale;else if(d.cts>t*d.timescale){s=f-1;break}e&&d.is_sync&&(r=f)}for(e&&(s=r),t=i.samples[s].cts,i.nextSample=s;i.samples[s].alreadyRead===i.samples[s].size&&i.samples[s+1];)s++;let a=i.samples[s].offset+i.samples[s].alreadyRead;return u.info("ISOFile","Seeking to "+(e?"RAP":"")+" sample #"+i.nextSample+" on track "+i.tkhd.track_id+", time "+u.getDurationString(t,o)+" and offset: "+a),{offset:a,time:t/o}}getTrackDuration(t){if(!t.samples)return 1/0;let e=t.samples[t.samples.length-1];return(e.cts+e.duration)/e.timescale}seek(t,e){let i=this.moov,r={offset:1/0,time:1/0};if(this.moov){for(let s=0;s<i.traks.length;s++){let o=i.traks[s];if(t>this.getTrackDuration(o))continue;let a=this.seekTrack(t,e,o);a.offset<r.offset&&(r.offset=a.offset),a.time<r.time&&(r.time=a.time)}return u.info("ISOFile","Seeking at time "+u.getDurationString(r.time,1)+" needs a buffer with a fileStart position of "+r.offset),r.offset===1/0?r={offset:this.nextParsePosition,time:0}:r.offset=this.stream.getEndFilePositionAfter(r.offset),u.info("ISOFile","Adjusted seek position (after checking data already in buffer): "+r.offset),r}else throw new Error("Cannot seek: moov not received!")}equal(t){let e=0;for(;e<this.boxes.length&&e<t.boxes.length;){let i=this.boxes[e],r=t.boxes[e];if(!St(i,r))return!1;e++}return!0}write(t){for(let e=0;e<this.boxes.length;e++)this.boxes[e].write(t)}createFragment(t,e,i,r){let s=[];for(let m=e;m<=i;m++){let p=this.getTrackById(t),h=this.getSample(p,m);if(!h){this.setNextSeekPositionFromSample(p.samples[m]);return}s.push(h)}let o=r||new A,a=this.createMoof(s);a.write(o),a.trafs[0].truns[0].data_offset=a.size+8,u.debug("MP4Box","Adjusting data_offset with new value "+a.trafs[0].truns[0].data_offset),o.adjustUint32(a.trafs[0].truns[0].data_offset_position,a.trafs[0].truns[0].data_offset);let f=new J;f.stream=new V;let d=0;for(let m of s)if(m.data){let p=L.fromArrayBuffer(m.data.buffer,d);f.stream.insertBuffer(p),d+=m.data.byteLength}return f.write(o),o}static writeInitializationSegment(t,e,i){var o,a;u.debug("ISOFile","Generating initialization segment");let r=new A;t.write(r);let s=e.addBox(new ae);if(i){let f=s.addBox(new Fe);f.fragment_duration=i}for(let f=0;f<e.traks.length;f++){let d=s.addBox(new fe);d.track_id=e.traks[f].tkhd.track_id,d.default_sample_description_index=1,d.default_sample_duration=(a=(o=e.traks[f].samples[0])==null?void 0:o.duration)!=null?a:0,d.default_sample_size=0,d.default_sample_flags=65536}return e.write(r),r.buffer}save(t){let e=new A;return e.isofile=this,this.write(e),e.save(t)}getBuffer(){let t=new A;return t.isofile=this,this.write(t),t}initializeSegmentation(){var e,i;this.onSegment||u.warn("MP4Box","No segmentation callback set!"),this.isFragmentationInitialized||(this.isFragmentationInitialized=!0,this.resetTables());let t=new te;t.addBox(this.moov.mvhd);for(let r=0;r<this.fragmentedTracks.length;r++){let s=this.getTrackById(this.fragmentedTracks[r].id);if(!s){u.warn("ISOFile",`Track with id ${this.fragmentedTracks[r].id} not found, skipping fragmentation initialization`);continue}t.addBox(s)}return{tracks:t.traks.map((r,s)=>({id:r.tkhd.track_id,user:this.fragmentedTracks[s].user})),buffer:n.writeInitializationSegment(this.ftyp,t,(i=(e=this.moov)==null?void 0:e.mvex)==null?void 0:i.mehd.fragment_duration)}}initializeTrackSegmentation(t){var s,o;this.onSegment||u.warn("MP4Box","No segmentation callback set!"),this.isFragmentationInitialized||(this.isFragmentationInitialized=!0,this.resetTables());let e=this.fragmentedTracks.find(a=>a.id===t);if(!e){u.warn("ISOFile",`Track with id ${t} not configured for fragmentation, skipping initialization`);return}let i=this.getTrackById(t);if(!i){u.warn("ISOFile",`Track with id ${t} not found, skipping fragmentation`);return}let r=new te;return r.addBox(this.moov.mvhd),r.addBox(i),{track:{id:i.tkhd.track_id,user:e.user},buffer:n.writeInitializationSegment(this.ftyp,r,(o=(s=this.moov)==null?void 0:s.mvex)==null?void 0:o.mehd.fragment_duration)}}resetTables(){this.initial_duration=this.moov.mvhd.duration,this.moov.mvhd.duration=0;for(let t=0;t<this.moov.traks.length;t++){let e=this.moov.traks[t];e.tkhd.duration=0,e.mdia.mdhd.duration=0;let i=e.mdia.minf.stbl.stco||e.mdia.minf.stbl.co64;i.chunk_offsets=[];let r=e.mdia.minf.stbl.stsc;r.first_chunk=[],r.samples_per_chunk=[],r.sample_description_index=[];let s=e.mdia.minf.stbl.stsz||e.mdia.minf.stbl.stz2;s.sample_sizes=[];let o=e.mdia.minf.stbl.stts;o.sample_counts=[],o.sample_deltas=[];let a=e.mdia.minf.stbl.ctts;a&&(a.sample_counts=[],a.sample_offsets=[]);let f=e.mdia.minf.stbl.stss,d=e.mdia.minf.stbl.boxes.indexOf(f);d!==-1&&(e.mdia.minf.stbl.boxes[d]=void 0)}}static initSampleGroups(t,e,i,r,s){e&&(e.sample_groups_info=[]),t.sample_groups_info||(t.sample_groups_info=[]);for(let o=0;o<i.length;o++){let a=i[o].grouping_type+"/"+i[o].grouping_type_parameter,f=new Qe(i[o].grouping_type,i[o].grouping_type_parameter,i[o]);e&&(e.sample_groups_info[a]=f),t.sample_groups_info[a]||(t.sample_groups_info[a]=f);for(let d=0;d<r.length;d++)r[d].grouping_type===i[o].grouping_type&&(f.description=r[d],f.description.used=!0);if(s)for(let d=0;d<s.length;d++)s[d].grouping_type===i[o].grouping_type&&(f.fragment_description=s[d],f.fragment_description.used=!0,f.is_fragment=!0)}if(e){if(s){for(let o=0;o<s.length;o++)if(!s[o].used&&s[o].version>=2){let a=s[o].grouping_type+"/0",f=new Qe(s[o].grouping_type,0);f.is_fragment=!0,e.sample_groups_info[a]||(e.sample_groups_info[a]=f)}}}else for(let o=0;o<r.length;o++)if(!r[o].used&&r[o].version>=2){let a=r[o].grouping_type+"/0",f=new Qe(r[o].grouping_type,0);t.sample_groups_info[a]||(t.sample_groups_info[a]=f)}}static setSampleGroupProperties(t,e,i,r){e.sample_groups=[];for(let s in r)if(e.sample_groups[s]={grouping_type:r[s].grouping_type,grouping_type_parameter:r[s].grouping_type_parameter},i>=r[s].last_sample_in_run&&(r[s].last_sample_in_run<0&&(r[s].last_sample_in_run=0),r[s].entry_index++,r[s].entry_index<=r[s].sbgp.entries.length-1&&(r[s].last_sample_in_run+=r[s].sbgp.entries[r[s].entry_index].sample_count)),r[s].entry_index<=r[s].sbgp.entries.length-1?e.sample_groups[s].group_description_index=r[s].sbgp.entries[r[s].entry_index].group_description_index:e.sample_groups[s].group_description_index=-1,e.sample_groups[s].group_description_index!==0){let o;if(r[s].fragment_description?o=r[s].fragment_description:o=r[s].description,e.sample_groups[s].group_description_index>0){let a;e.sample_groups[s].group_description_index>65535?a=(e.sample_groups[s].group_description_index>>16)-1:a=e.sample_groups[s].group_description_index-1,o&&a>=0&&(e.sample_groups[s].description=o.entries[a])}else o&&o.version>=2&&o.default_group_description_index>0&&(e.sample_groups[s].description=o.entries[o.default_group_description_index-1])}}static process_sdtp(t,e,i){e&&(t?(e.is_leading=t.is_leading[i],e.depends_on=t.sample_depends_on[i],e.is_depended_on=t.sample_is_depended_on[i],e.has_redundancy=t.sample_has_redundancy[i]):(e.is_leading=0,e.depends_on=0,e.is_depended_on=0,e.has_redundancy=0))}buildSampleLists(){for(let t=0;t<this.moov.traks.length;t++)this.buildTrakSampleLists(this.moov.traks[t])}buildTrakSampleLists(t){let e,i,r,s,o,a;t.samples=[],t.samples_duration=0,t.samples_size=0;let f=t.mdia.minf.stbl.stco||t.mdia.minf.stbl.co64,d=t.mdia.minf.stbl.stsc,m=t.mdia.minf.stbl.stsz||t.mdia.minf.stbl.stz2,p=t.mdia.minf.stbl.stts,h=t.mdia.minf.stbl.ctts,_=t.mdia.minf.stbl.stss,y=t.mdia.minf.stbl.stsd,b=t.mdia.minf.stbl.subs,I=t.mdia.minf.stbl.stdp,M=t.mdia.minf.stbl.sbgps,T=t.mdia.minf.stbl.sgpds,D=-1,Z=-1,H=-1,k=-1,q=0,C=0,j=0;if(n.initSampleGroups(t,void 0,M,T),typeof m!="undefined"){for(e=0;e<m.sample_sizes.length;e++){let S={number:e,track_id:t.tkhd.track_id,timescale:t.mdia.mdhd.timescale,alreadyRead:0,size:m.sample_sizes[e]};t.samples[e]=S,t.samples_size+=S.size,e===0?(r=1,i=0,S.chunk_index=r,S.chunk_run_index=i,a=d.samples_per_chunk[i],o=0,i+1<d.first_chunk.length?s=d.first_chunk[i+1]-1:s=1/0):e<a?(S.chunk_index=r,S.chunk_run_index=i):(r++,S.chunk_index=r,o=0,r<=s||(i++,i+1<d.first_chunk.length?s=d.first_chunk[i+1]-1:s=1/0),S.chunk_run_index=i,a+=d.samples_per_chunk[i]),S.description_index=d.sample_description_index[S.chunk_run_index]-1,S.description=y.entries[S.description_index],S.offset=f.chunk_offsets[S.chunk_index-1]+o,o+=S.size,e>D&&(Z++,D<0&&(D=0),D+=p.sample_counts[Z]),e>0?(t.samples[e-1].duration=p.sample_deltas[Z],t.samples_duration+=t.samples[e-1].duration,S.dts=t.samples[e-1].dts+t.samples[e-1].duration):S.dts=0,h?(e>=H&&(k++,H<0&&(H=0),H+=h.sample_counts[k]),S.cts=t.samples[e].dts+h.sample_offsets[k]):S.cts=S.dts,_?(e===_.sample_numbers[q]-1?(S.is_sync=!0,q++):(S.is_sync=!1,S.degradation_priority=0),b&&b.entries[C].sample_delta+j===e+1&&(S.subsamples=b.entries[C].subsamples,j+=b.entries[C].sample_delta,C++)):S.is_sync=!0,n.process_sdtp(t.mdia.minf.stbl.sdtp,S,S.number),I?S.degradation_priority=I.priority[e]:S.degradation_priority=0,b&&b.entries[C].sample_delta+j===e&&(S.subsamples=b.entries[C].subsamples,j+=b.entries[C].sample_delta),(M.length>0||T.length>0)&&n.setSampleGroupProperties(t,S,e,t.sample_groups_info)}e>0&&(t.samples[e-1].duration=Math.max(t.mdia.mdhd.duration-t.samples[e-1].dts,0),t.samples_duration+=t.samples[e-1].duration)}}updateSampleLists(){let t,e,i,r,s;if(this.moov!==void 0)for(;this.lastMoofIndex<this.moofs.length;){let o=this.moofs[this.lastMoofIndex];if(this.lastMoofIndex++,o.type==="moof"){let a=o;for(let f=0;f<a.trafs.length;f++){let d=a.trafs[f],m=this.getTrackById(d.tfhd.track_id),p=this.getTrexById(d.tfhd.track_id);d.tfhd.flags&ue?t=d.tfhd.default_sample_description_index:t=p?p.default_sample_description_index:1,d.tfhd.flags&ce?e=d.tfhd.default_sample_duration:e=p?p.default_sample_duration:0,d.tfhd.flags&me?i=d.tfhd.default_sample_size:i=p?p.default_sample_size:0,d.tfhd.flags&pe?r=d.tfhd.default_sample_flags:r=p?p.default_sample_flags:0,d.sample_number=0,d.sbgps.length>0&&n.initSampleGroups(m,d,d.sbgps,m.mdia.minf.stbl.sgpds,d.sgpds);for(let h=0;h<d.truns.length;h++){let _=d.truns[h];for(let y=0;y<_.sample_count;y++){let b=t-1,I=r;_.flags&ne?I=_.sample_flags[y]:y===0&&_.flags&he&&(I=_.first_sample_flags);let M=i;_.flags&se&&(M=_.sample_size[y]),m.samples_size+=M;let T=e;_.flags&re&&(T=_.sample_duration[y]),m.samples_duration+=T;let D;m.first_traf_merged||y>0?D=m.samples[m.samples.length-1].dts+m.samples[m.samples.length-1].duration:(d.tfdt?D=d.tfdt.baseMediaDecodeTime:D=0,m.first_traf_merged=!0);let Z=D;_.flags&oe&&(Z=D+_.sample_composition_time_offset[y]);let H=!!(d.tfhd.flags&de),k=!!(d.tfhd.flags&Jn),q=!!(_.flags&ie),C=0;H?C=d.tfhd.base_data_offset:k||h===0?C=a.start:C=s;let j;h===0&&y===0?q?j=C+_.data_offset:j=C:j=s,s=j+M;let S=d.sample_number;d.sample_number++;let Wn={cts:Z,description_index:b,description:m.mdia.minf.stbl.stsd.entries[b],dts:D,duration:T,moof_number:this.lastMoofIndex,number_in_traf:S,number:m.samples.length,offset:j,size:M,timescale:m.mdia.mdhd.timescale,track_id:m.tkhd.track_id,is_sync:!(I>>16&1),is_leading:I>>26&3,depends_on:I>>24&3,is_depended_on:I>>22&3,has_redundancy:I>>20&3,degradation_priority:I&65535};d.first_sample_index=m.samples.length,m.samples.push(Wn),(d.sbgps.length>0||d.sgpds.length>0||m.mdia.minf.stbl.sbgps.length>0||m.mdia.minf.stbl.sgpds.length>0)&&n.setSampleGroupProperties(m,Wn,Wn.number_in_traf,d.sample_groups_info)}}if(d.subs){m.has_fragment_subsamples=!0;let h=d.first_sample_index;for(let _=0;_<d.subs.entries.length;_++){h+=d.subs.entries[_].sample_delta;let y=m.samples[h-1];y.subsamples=d.subs.entries[_].subsamples}}}}}}getSample(t,e){let i=t.samples[e];if(this.moov){if(!i.data)i.data=new Uint8Array(i.size),i.alreadyRead=0,this.samplesDataSize+=i.size,u.debug("ISOFile","Allocating sample #"+e+" on track #"+t.tkhd.track_id+" of size "+i.size+" (total: "+this.samplesDataSize+")");else if(i.alreadyRead===i.size)return i;for(;;){let r=this.stream,s=r.findPosition(!0,i.offset+i.alreadyRead,!1),o,a;if(s>-1)o=r.buffers[s],a=o.fileStart;else for(let f of this.mdats){if(!f.stream){u.debug("ISOFile","mdat stream not yet fully read for #"+this.mdats.indexOf(f)+" mdat");continue}if(s=f.stream.findPosition(!0,i.offset+i.alreadyRead-f.start-f.hdr_size,!1),s>-1){r=f.stream,o=f.stream.buffers[s],a=f.start+f.hdr_size+o.fileStart;break}}if(o){let f=o.byteLength-(i.offset+i.alreadyRead-a);if(i.size-i.alreadyRead<=f)return u.debug("ISOFile","Getting sample #"+e+" data (alreadyRead: "+i.alreadyRead+" offset: "+(i.offset+i.alreadyRead-a)+" read size: "+(i.size-i.alreadyRead)+" full size: "+i.size+")"),A.memcpy(i.data.buffer,i.alreadyRead,o,i.offset+i.alreadyRead-a,i.size-i.alreadyRead),o.usedBytes+=i.size-i.alreadyRead,r.logBufferLevel(),i.alreadyRead=i.size,i;if(f===0)return;u.debug("ISOFile","Getting sample #"+e+" partial data (alreadyRead: "+i.alreadyRead+" offset: "+(i.offset+i.alreadyRead-a)+" read size: "+f+" full size: "+i.size+")"),A.memcpy(i.data.buffer,i.alreadyRead,o,i.offset+i.alreadyRead-a,f),i.alreadyRead+=f,o.usedBytes+=f,r.logBufferLevel()}else return}}}releaseSample(t,e){let i=t.samples[e];return i.data?(this.samplesDataSize-=i.size,i.data=void 0,i.alreadyRead=0,i.size):0}getAllocatedSampleDataSize(){return this.samplesDataSize}getCodecs(){let t="";for(let e=0;e<this.moov.traks.length;e++){let i=this.moov.traks[e];e>0&&(t+=","),t+=i.mdia.minf.stbl.stsd.entries[0].getCodec()}return t}getTrexById(t){if(!(!this.moov||!this.moov.mvex))for(let e=0;e<this.moov.mvex.trexs.length;e++){let i=this.moov.mvex.trexs[e];if(i.track_id===t)return i}}getTrackById(t){if(this.moov)for(let e=0;e<this.moov.traks.length;e++){let i=this.moov.traks[e];if(i.tkhd.track_id===t)return i}}flattenItemInfo(){var r;let t=this.items,e=this.entity_groups,i=this.meta;if(!(!i||!i.hdlr||!i.iinf)){for(let s=0;s<i.iinf.item_infos.length;s++){let o=i.iinf.item_infos[s].item_ID;t[o]={id:o,name:i.iinf.item_infos[s].item_name,ref_to:[],content_type:i.iinf.item_infos[s].content_type,content_encoding:i.iinf.item_infos[s].content_encoding,item_uri_type:i.iinf.item_infos[s].item_uri_type,type:i.iinf.item_infos[s].item_type?i.iinf.item_infos[s].item_type:"mime",protection:i.iinf.item_infos[s].item_protection_index>0?i.ipro.protections[i.iinf.item_infos[s].item_protection_index-1]:void 0}}if(i.grpl)for(let s=0;s<i.grpl.boxes.length;s++){let o=i.grpl.boxes[s];e[o.group_id]={id:o.group_id,entity_ids:o.entity_ids,type:o.type}}if(i.iloc)for(let s=0;s<i.iloc.items.length;s++){let o=i.iloc.items[s],a=t[o.item_ID];o.data_reference_index!==0&&(u.warn("Item storage with reference to other files: not supported"),a.source=i.dinf.boxes[o.data_reference_index-1]),a.extents=[],a.size=0;for(let f=0;f<o.extents.length;f++)a.extents[f]={offset:o.extents[f].extent_offset+o.base_offset,length:o.extents[f].extent_length,alreadyRead:0},o.construction_method===1&&(a.extents[f].offset+=i.idat.start+i.idat.hdr_size),a.size+=a.extents[f].length}if(i.pitm&&(t[i.pitm.item_id].primary=!0),i.iref)for(let s=0;s<i.iref.references.length;s++){let o=i.iref.references[s];for(let a=0;a<o.references.length;a++)t[o.from_item_ID].ref_to.push({type:o.type,id:o.references[a]})}if(i.iprp)for(let s=0;s<i.iprp.ipmas.length;s++){let o=i.iprp.ipmas[s];for(let a=0;a<o.associations.length;a++){let f=o.associations[a],d=(r=t[f.id])!=null?r:e[f.id];if(d){d.properties===void 0&&(d.properties={boxes:[]});for(let m=0;m<f.props.length;m++){let p=f.props[m];if(p.property_index>0&&p.property_index-1<i.iprp.ipco.boxes.length){let h=i.iprp.ipco.boxes[p.property_index-1];d.properties[h.type]=h,d.properties.boxes.push(h)}}}}}}}getItem(t){if(!this.meta)return;let e=this.items[t];if(!e.data&&e.size)e.data=new Uint8Array(e.size),e.alreadyRead=0,this.itemsDataSize+=e.size,u.debug("ISOFile","Allocating item #"+t+" of size "+e.size+" (total: "+this.itemsDataSize+")");else if(e.alreadyRead===e.size)return e;for(let i=0;i<e.extents.length;i++){let r=e.extents[i];if(r.alreadyRead!==r.length){let s=this.stream.findPosition(!0,r.offset+r.alreadyRead,!1);if(s>-1){let o=this.stream.buffers[s],a=o.byteLength-(r.offset+r.alreadyRead-o.fileStart);if(r.length-r.alreadyRead<=a)u.debug("ISOFile","Getting item #"+t+" extent #"+i+" data (alreadyRead: "+r.alreadyRead+" offset: "+(r.offset+r.alreadyRead-o.fileStart)+" read size: "+(r.length-r.alreadyRead)+" full extent size: "+r.length+" full item size: "+e.size+")"),A.memcpy(e.data.buffer,e.alreadyRead,o,r.offset+r.alreadyRead-o.fileStart,r.length-r.alreadyRead),(!this.parsingMdat||this.discardMdatData)&&(o.usedBytes+=r.length-r.alreadyRead),this.stream.logBufferLevel(),e.alreadyRead+=r.length-r.alreadyRead,r.alreadyRead=r.length;else{u.debug("ISOFile","Getting item #"+t+" extent #"+i+" partial data (alreadyRead: "+r.alreadyRead+" offset: "+(r.offset+r.alreadyRead-o.fileStart)+" read size: "+a+" full extent size: "+r.length+" full item size: "+e.size+")"),A.memcpy(e.data.buffer,e.alreadyRead,o,r.offset+r.alreadyRead-o.fileStart,a),r.alreadyRead+=a,e.alreadyRead+=a,(!this.parsingMdat||this.discardMdatData)&&(o.usedBytes+=a),this.stream.logBufferLevel();return}}else return}}if(e.alreadyRead===e.size)return e}releaseItem(t){let e=this.items[t];if(e.data){this.itemsDataSize-=e.size,e.data=void 0,e.alreadyRead=0;for(let i=0;i<e.extents.length;i++){let r=e.extents[i];r.alreadyRead=0}return e.size}else return 0}processItems(t){for(let e in this.items){let i=this.items[e];this.getItem(i.id),t&&!i.sent&&(t(i),i.sent=!0,i.data=void 0)}}hasItem(t){for(let e in this.items){let i=this.items[e];if(i.name===t)return i.id}return-1}getMetaHandler(){if(this.meta)return this.meta.hdlr.handler}getPrimaryItem(){if(this.meta&&this.meta.pitm)return this.getItem(this.meta.pitm.item_id)}itemToFragmentedTrackFile({itemId:t}={}){let e;if(t?e=this.getItem(t):e=this.getPrimaryItem(),!e)return;let i=new n;i.discardMdatData=!1;let r={type:e.type,description_boxes:e.properties.boxes};e.properties.ispe&&(r.width=e.properties.ispe.image_width,r.height=e.properties.ispe.image_height);let s=i.addTrack(r);if(s)return i.addSample(s,e.data),i}processIncompleteBox(t){if(t.type==="mdat"){let e=new J(t.size);return this.parsingMdat=e,this.boxes.push(e),this.mdats.push(e),e.start=t.start,e.hdr_size=t.hdr_size,e.original_size=t.original_size,this.stream.addUsedBytes(e.hdr_size),this.lastBoxStartPosition=e.start+e.size,this.stream.seek(e.start+e.size,!1,this.discardMdatData)?(this.transferMdatData(),this.parsingMdat=void 0,!0):(this.moovStartFound?this.nextParsePosition=this.stream.findEndContiguousBuf():this.nextParsePosition=e.start+e.size,!1)}else return t.type==="moov"&&(this.moovStartFound=!0,this.mdats.length===0&&(this.isProgressive=!0)),(this.stream.mergeNextBuffer?this.stream.mergeNextBuffer():!1)?(this.nextParsePosition=this.stream.getEndPosition(),!0):(t.type?this.moovStartFound?this.nextParsePosition=this.stream.getEndPosition():this.nextParsePosition=this.stream.getPosition()+t.size:this.nextParsePosition=this.stream.getEndPosition(),!1)}hasIncompleteMdat(){return this.parsingMdat!==void 0}transferMdatData(t){let e=t!=null?t:this.parsingMdat;if(this.discardMdatData){u.debug("ISOFile","Discarding 'mdat' data, not transferring it to the mdat box stream");return}if(!e){u.warn("ISOFile","Cannot transfer 'mdat' data, no mdat box is being parsed");return}let i=this.stream.findPosition(!0,e.start+e.hdr_size,!1),r=this.stream.findPosition(!0,e.start+e.size,!1);if(i===-1||r===-1){u.warn("ISOFile","Cannot transfer 'mdat' data, start or end buffer not found");return}e.stream=new V;for(let s=i;s<=r;s++){let o=this.stream.buffers[s],a=s===i?e.start+e.hdr_size-o.fileStart:0,f=s===r?e.start+e.size-o.fileStart:o.byteLength;if(f>a){u.debug("ISOFile","Transferring 'mdat' data from buffer #"+s+" ("+a+" to "+f+")");let d=f-a,m=new L(d),p=e.stream.getAbsoluteEndPosition();A.memcpy(m,0,o,a,d),m.fileStart=p,e.stream.insertBuffer(m),o.usedBytes+=d}}}processIncompleteMdat(){let t=this.parsingMdat;return this.stream.seek(t.start+t.size,!1,this.discardMdatData)?(u.debug("ISOFile","Found 'mdat' end in buffered data"),this.transferMdatData(),this.parsingMdat=void 0,!0):(this.nextParsePosition=this.stream.findEndContiguousBuf(),!1)}restoreParsePosition(){return this.stream.seek(this.lastBoxStartPosition,!0,this.discardMdatData)}saveParsePosition(){this.lastBoxStartPosition=this.stream.getPosition()}updateUsedBytes(t,e){this.stream.addUsedBytes&&(t.type==="mdat"?(this.stream.addUsedBytes(t.hdr_size),this.discardMdatData&&this.stream.addUsedBytes(t.size-t.hdr_size)):this.stream.addUsedBytes(t.size))}addBox(t){return c.prototype.addBox.call(this,t)}init(t={}){let e=this.addBox(new Ie);e.major_brand=t.brands&&t.brands[0]||"iso4",e.minor_version=0,e.compatible_brands=t.brands||["iso4"];let i=this.addBox(new te);i.addBox(new ae);let r=i.addBox(new De);return r.timescale=t.timescale||600,r.rate=t.rate||65536,r.creation_time=0,r.modification_time=0,r.duration=t.duration||0,r.volume=t.width?0:256,r.matrix=[65536,0,0,0,65536,0,0,0,1073741824],r.next_track_id=1,this}addTrack(t={}){this.moov||this.init(t);let e=t||{};e.width=e.width||320,e.height=e.height||320,e.id=e.id||this.moov.mvhd.next_track_id,e.type=e.type||"avc1";let i=this.moov.addBox(new ge);this.moov.mvhd.next_track_id=e.id+1;let r=i.addBox(new Ye);r.flags=vo|Ao|Mo,r.creation_time=0,r.modification_time=0,r.track_id=e.id,r.duration=e.duration||0,r.layer=e.layer||0,r.alternate_group=0,r.volume=1,r.matrix=[65536,0,0,0,65536,0,0,0,1073741824],r.width=e.width<<16,r.height=e.height<<16;let s=i.addBox(new ye),o=s.addBox(new ke);o.creation_time=0,o.modification_time=0,o.timescale=e.timescale||1,o.duration=e.media_duration||0,o.language=e.language||"und";let a=s.addBox(new ze);a.handler=e.hdlr||"vide",a.name=e.name||"Track created with MP4Box.js";let f=s.addBox(new Me);f.extended_language=e.language||"fr-FR";let d=s.addBox(new Se),m=P.sampleEntry[e.type];if(!m)return;let p=new m;if(p.data_reference_index=1,p instanceof U){let k=p,q=d.addBox(new Ze);q.graphicsmode=0,q.opcolor=[0,0,0],k.width=e.width,k.height=e.height,k.horizresolution=72<<16,k.vertresolution=72<<16,k.frame_count=1,k.compressorname=e.type+" Compressor",k.depth=24,e.avcDecoderConfigRecord?k.addBox(new be(e.avcDecoderConfigRecord.byteLength)).parse(new A(e.avcDecoderConfigRecord)):e.hevcDecoderConfigRecord&&k.addBox(new Te(e.hevcDecoderConfigRecord.byteLength)).parse(new A(e.hevcDecoderConfigRecord))}else if(p instanceof E){let k=p,q=d.addBox(new Re);q.balance=e.balance||0,k.channel_count=e.channel_count||2,k.samplesize=e.samplesize||16,k.samplerate=e.samplerate||65536}else p instanceof _e?d.addBox(new xe):p instanceof N?(d.addBox(new He),p instanceof Ne&&(p.namespace=e.namespace||"nonamespace",p.schema_location=e.schema_location||"",p.auxiliary_mime_types=e.auxiliary_mime_types||"")):p instanceof O?d.addBox(new ee):p instanceof Q?d.addBox(new ee):d.addBox(new ee);e.description&&p.addBox.call(p,e.description),e.description_boxes&&e.description_boxes.forEach(function(k){p.addBox.call(p,k)});let _=d.addBox(new Be).addBox(new Ae),y=new Xe;y.flags=1,_.addEntry(y);let b=d.addBox(new Ue);b.addBox(new Ge).addEntry(p);let M=b.addBox(new Ke);M.sample_counts=[],M.sample_deltas=[];let T=b.addBox(new Ve);T.first_chunk=[],T.samples_per_chunk=[],T.sample_description_index=[];let D=b.addBox(new Oe);D.chunk_offsets=[];let Z=b.addBox(new je);Z.sample_sizes=[];let H=this.moov.mvex.addBox(new fe);return H.track_id=e.id,H.default_sample_description_index=e.default_sample_description_index||1,H.default_sample_duration=e.default_sample_duration||0,H.default_sample_size=e.default_sample_size||0,H.default_sample_flags=e.default_sample_flags||0,this.buildTrakSampleLists(i),e.id}addSample(t,e,{sample_description_index:i,duration:r=1,cts:s=0,dts:o=0,is_sync:a=!1,is_leading:f=0,depends_on:d=0,is_depended_on:m=0,has_redundancy:p=0,degradation_priority:h=0,subsamples:_,offset:y=0}={}){let b=this.getTrackById(t);if(b===void 0)return;let I=i?i-1:0,M={number:b.samples.length,track_id:b.tkhd.track_id,timescale:b.mdia.mdhd.timescale,description_index:I,description:b.mdia.minf.stbl.stsd.entries[I],data:e,size:e.byteLength,alreadyRead:e.byteLength,duration:r,cts:s,dts:o,is_sync:a,is_leading:f,depends_on:d,is_depended_on:m,has_redundancy:p,degradation_priority:h,offset:y,subsamples:_};b.samples.push(M),b.samples_size+=M.size,b.samples_duration+=M.duration,b.first_dts===void 0&&(b.first_dts=o),this.processSamples();let T=this.addBox(this.createMoof([M]));T.computeSize(),T.trafs[0].truns[0].data_offset=T.size+8;let D=this.addBox(new J);return D.data=new Uint8Array(e),M}createMoof(t){if(t.length===0)return;if(t.some(m=>m.track_id!==t[0].track_id))throw new Error("Cannot create moof for samples from different tracks: "+t.map(m=>m.track_id).join(", "));let e=t[0].track_id,i=this.getTrackById(e);if(!i)throw new Error("Cannot create moof for non-existing track: "+e);let r=new we,s=r.addBox(new Ee);s.sequence_number=++this.nextMoofNumber;let o=r.addBox(new ve),a=o.addBox(new qe);a.track_id=e,a.flags=Jn;let f=o.addBox(new $e);f.baseMediaDecodeTime=t[0].dts-(i.first_dts||0);let d=o.addBox(new We);d.flags=ie|re|se|ne|oe,d.data_offset=0,d.first_sample_flags=0,d.sample_count=t.length;for(let m of t){let p=0;m.is_sync?p=1<<25:p=65536,d.sample_duration.push(m.duration),d.sample_size.push(m.size),d.sample_flags.push(p),d.sample_composition_time_offset.push(m.cts-m.dts)}return r}print(t){t.indent="";for(let e=0;e<this.boxes.length;e++)this.boxes[e]&&this.boxes[e].print(t)}};function ro(n=!1,t){return new dt(t,!n)}var fo={};Xn(fo,{Descriptor:()=>$,ES_Descriptor:()=>ut,MPEG4DescriptorParser:()=>dr});var Co=3,lr=4,ao=5,No=6,$=class n{constructor(t,e){this.tag=t;this.size=e;this.descs=[]}parse(t){this.data=t.readUint8Array(this.size)}findDescriptor(t){for(let e=0;e<this.descs.length;e++)if(this.descs[e].tag===t)return this.descs[e]}parseOneDescriptor(t){let e=0,i=t.readUint8(),r=t.readUint8();for(;r&128;)e=(e<<7)+(r&127),r=t.readUint8();e=(e<<7)+(r&127),u.debug("Descriptor","Found "+(fr[i]||"Descriptor "+i)+", size "+e+" at position "+t.getPosition());let s=fr[i]?new Xo[fr[i]](e):new n(e);return s.parse(t),s}parseRemainingDescriptors(t){var i;let e=t.getPosition();for(;t.getPosition()<e+this.size;){let r=(i=this.parseOneDescriptor)==null?void 0:i.call(this,t);this.descs.push(r)}}},ut=class extends ${constructor(t){super(Co,t)}parse(t){if(this.ES_ID=t.readUint16(),this.flags=t.readUint8(),this.size-=3,this.flags&128?(this.dependsOn_ES_ID=t.readUint16(),this.size-=2):this.dependsOn_ES_ID=0,this.flags&64){let e=t.readUint8();this.URL=t.readString(e),this.size-=e+1}else this.URL="";this.flags&32?(this.OCR_ES_ID=t.readUint16(),this.size-=2):this.OCR_ES_ID=0,this.parseRemainingDescriptors(t)}getOTI(){let t=this.findDescriptor(lr);return t?t.oti:0}getAudioConfig(){let t=this.findDescriptor(lr);if(!t)return;let e=t.findDescriptor(ao);if(e&&e.data){let i=(e.data[0]&248)>>3;return i===31&&e.data.length>=2&&(i=32+((e.data[0]&7)<<3)+((e.data[1]&224)>>5)),i}}},so=class extends ${constructor(t){super(lr,t)}parse(t){this.oti=t.readUint8(),this.streamType=t.readUint8(),this.upStream=(this.streamType>>1&1)!==0,this.streamType=this.streamType>>>2,this.bufferSize=t.readUint24(),this.maxBitrate=t.readUint32(),this.avgBitrate=t.readUint32(),this.size-=13,this.parseRemainingDescriptors(t)}},no=class extends ${constructor(t){super(ao,t)}},oo=class extends ${constructor(t){super(No,t)}},Xo={Descriptor:$,ES_Descriptor:ut,DecoderConfigDescriptor:so,DecoderSpecificInfo:no,SLConfigDescriptor:oo},fr={[Co]:"ES_Descriptor",[lr]:"DecoderConfigDescriptor",[ao]:"DecoderSpecificInfo",[No]:"SLConfigDescriptor"},dr=class{constructor(){this.parseOneDescriptor=$.prototype.parseOneDescriptor}getDescriptorName(t){return fr[t]}};var lo=class{parseSample(t){var r;let e=[],i=new V(L.fromArrayBuffer(t.buffer,0));for(;!i.isEof();){let s=z(i,!1);s.code===v&&((r=s.box)==null?void 0:r.type)==="vttc"&&e.push(s.box)}return e}getText(t,e,i){function r(f,d){let m=f.toString();return m.length>=d?m:new Array(d-m.length+1).join("0")+m}function s(f){let d=Math.floor(f/3600),m=Math.floor((f-d*3600)/60),p=Math.floor(f-d*3600-m*60),h=Math.floor((f-d*3600-m*60-p)*1e3);return""+r(d,2)+":"+r(m,2)+":"+r(p,2)+"."+r(h,3)}let o=this.parseSample(i),a="";for(let f=0;f<o.length;f++){let d=o[f];a+=s(t)+" --> "+s(e)+`\r
`,a+=d.payl.text}return a}},uo=class{parseSample(t){let e={resources:[],documentString:"",document:void 0},i=new A(t.data.buffer);if(!t.subsamples||t.subsamples.length===0)e.documentString=i.readString(t.data.length);else if(e.documentString=i.readString(t.subsamples[0].size),t.subsamples.length>1)for(let r=1;r<t.subsamples.length;r++)e.resources[r]=i.readUint8Array(t.subsamples[r].size);return typeof DOMParser!="undefined"&&(e.document=new DOMParser().parseFromString(e.documentString,"application/xml")),e}},co=class{parseSample(t){return new A(t.data.buffer).readString(t.data.length)}parseConfig(t){let e=new A(t.buffer);return e.readUint32(),e.readCString()}},mo=class{parseSample(t){let e=new A(t.data.buffer),i=e.readUint16();if(i!==0)return e.readString(i)}};function Zo(n){if(!n.ftyp||!n.moov)return;let t=new A;t.isofile=n,n.ftyp.write(t),n.moov.write(t);let e=t.buffer;return e.fileStart=0,e}async function Qo(n){var h;let{blob:t,fetchRange:e,chunkSize:i=1024*1024,probeSize:r=64*1024}=n;if(!t&&!e)throw new Error("loadMoovOnly requires either a Blob/File or a custom fetchRange");let s=(h=n.size)!=null?h:t==null?void 0:t.size;if(s===void 0)throw new Error("loadMoovOnly could not determine the resource size");let o=e||(async(_,y)=>{if(!t)throw new Error("Blob is required when fetchRange is not provided");return t.slice(_,y+1).arrayBuffer()}),a=ro(!1),f;a.onReady=_=>{f=_};let d=()=>{let _=a.moov;if(!_||_.start===void 0||_.size===void 0)return!1;let y=_.start+_.size;return a.stream.getEndFilePositionAfter(_.start)>=y&&a.sampleListBuilt},m=0,p;for(;!d()&&m<s;){let _=a.moov?i:Math.min(i,r),y=Math.min(m+_,s)-1,b,I=await o(m,y),M=L.fromArrayBuffer(I,m),T=a.appendBuffer(M);if(typeof T=="number"&&(b=T),d())break;b!==void 0&&b>m?m=b:m=y+1}return a.moov&&!a.sampleListBuilt&&(a.buildSampleLists(),a.sampleListBuilt=!0),p||(p=Zo(a)),a.flush(),f||(f=a.getInfo()),{info:f,mp4:a,header:p}}var xo={};Xn(xo,{CoLLBox:()=>Ur,ItemContentIDPropertyBox:()=>Yn,OpusSampleEntry:()=>Ni,SmDmBox:()=>Ks,a1lxBox:()=>ur,a1opBox:()=>cr,ac_3SampleEntry:()=>Pi,ac_4SampleEntry:()=>Li,aebrBox:()=>Rr,afbrBox:()=>Or,albcBox:()=>Hr,alstSampleGroupEntry:()=>Un,altrBox:()=>Vr,auxCBox:()=>mr,av01SampleEntry:()=>di,av1CBox:()=>ti,avc1SampleEntry:()=>oi,avc2SampleEntry:()=>ai,avc3SampleEntry:()=>fi,avc4SampleEntry:()=>li,avcCBox:()=>be,avllSampleGroupEntry:()=>wn,avs3SampleEntry:()=>Mi,avssSampleGroupEntry:()=>vn,brstBox:()=>Gr,btrtBox:()=>pr,bxmlBox:()=>Mt,ccstBox:()=>hr,cdefBox:()=>_r,clapBox:()=>br,clefBox:()=>Ts,clliBox:()=>xr,cmexBox:()=>gr,cminBox:()=>yr,cmpdBox:()=>Sr,co64Box:()=>Br,colrBox:()=>ni,coviBox:()=>wr,cprtBox:()=>vr,cschBox:()=>Ar,cslgBox:()=>Mr,cttsBox:()=>Ir,dOpsBox:()=>Pr,dac3Box:()=>zr,dataBox:()=>W,dav1SampleEntry:()=>ui,dec3Box:()=>Tr,dfLaBox:()=>kr,dimmBox:()=>Fr,dinfBox:()=>Be,dmax:()=>Er,dmedBox:()=>Dr,dobrBox:()=>jr,drefBox:()=>Ae,drepBox:()=>Lr,dtrtSampleGroupEntry:()=>An,dvh1SampleEntry:()=>gi,dvheSampleEntry:()=>yi,ec_3SampleEntry:()=>Ci,edtsBox:()=>zt,elngBox:()=>Me,elstBox:()=>Cr,emsgBox:()=>Nr,encaSampleEntry:()=>Ki,encmSampleEntry:()=>Xi,encsSampleEntry:()=>qi,enctSampleEntry:()=>Wi,encuSampleEntry:()=>$i,encvSampleEntry:()=>ji,enofBox:()=>ks,eqivBox:()=>Kr,esdsBox:()=>ii,etypBox:()=>$t,fLaCSampleEntry:()=>Gi,favcBox:()=>$r,fielBox:()=>is,fobrBox:()=>qr,freeBox:()=>Ut,frmaBox:()=>rs,ftypBox:()=>Ie,grplBox:()=>jt,hdlrBox:()=>ze,hev1SampleEntry:()=>pi,hev2SampleEntry:()=>hi,hinfBox:()=>Dt,hmhdBox:()=>xe,hntiBox:()=>Et,hvc1SampleEntry:()=>ci,hvc2SampleEntry:()=>mi,hvcCBox:()=>Te,hvt1SampleEntry:()=>_i,iaugBox:()=>Yr,idatBox:()=>Bt,iinfBox:()=>Wt,ilocBox:()=>Xt,ilstBox:()=>Fs,imirBox:()=>ss,infeBox:()=>Yt,iodsBox:()=>vt,ipcoBox:()=>Gt,ipmaBox:()=>ns,iproBox:()=>It,iprpBox:()=>Vt,irefBox:()=>io,irotBox:()=>os,ispeBox:()=>as,itaiBox:()=>fs,j2kHBox:()=>Kt,j2kiSampleEntry:()=>Ii,keysBox:()=>Es,kindBox:()=>ls,levaBox:()=>ds,lhe1SampleEntry:()=>bi,lhv1SampleEntry:()=>xi,lhvCBox:()=>us,lselBox:()=>cs,m4aeSampleEntry:()=>Di,maxrBox:()=>ms,mdatBox:()=>J,mdcvBox:()=>ps,mdhdBox:()=>ke,mdiaBox:()=>ye,mecoBox:()=>Ft,mehdBox:()=>Fe,metaBox:()=>Qt,mettSampleEntry:()=>Jt,metxSampleEntry:()=>ei,mfhdBox:()=>Ee,mfraBox:()=>kt,mfroBox:()=>hs,mha1SampleEntry:()=>Ri,mha2SampleEntry:()=>Oi,mhm1SampleEntry:()=>Hi,mhm2SampleEntry:()=>Vi,minfBox:()=>Se,mjp2SampleEntry:()=>zi,mjpgSampleEntry:()=>Ti,moofBox:()=>we,moovBox:()=>te,mp4aSampleEntry:()=>Ei,mp4sSampleEntry:()=>Yi,mp4vSampleEntry:()=>Fi,mskCBox:()=>_s,msrcTrackGroupTypeBox:()=>cn,mvexBox:()=>ae,mvhdBox:()=>De,mvifSampleGroupEntry:()=>Mn,nmhdBox:()=>ee,npckBox:()=>bs,numpBox:()=>xs,padbBox:()=>gs,panoBox:()=>Wr,paspBox:()=>ys,paylBox:()=>Ss,paytBox:()=>Bs,pdinBox:()=>Us,piffLsmBox:()=>Vn,piffPsshBox:()=>Gn,piffSencBox:()=>jn,piffTencBox:()=>Kn,piffTfrfBox:()=>$n,piffTfxdBox:()=>qn,pitmBox:()=>Zt,pixiBox:()=>ws,pmaxBox:()=>vs,povdBox:()=>qt,prdiBox:()=>As,prfrBox:()=>Ms,prftBox:()=>Is,prgrBox:()=>es,profBox:()=>Ds,prolSampleGroupEntry:()=>In,psshBox:()=>zs,pymdBox:()=>ts,rapSampleGroupEntry:()=>zn,rashSampleGroupEntry:()=>Tn,resvSampleEntry:()=>Zi,rinfBox:()=>Nt,rollSampleGroupEntry:()=>kn,rtp_Box:()=>Cs,saioBox:()=>Ns,saizBox:()=>Rs,sbgpBox:()=>sr,sbpmBox:()=>Hs,sbttSampleEntry:()=>er,schiBox:()=>Rt,schmBox:()=>Vs,scifSampleGroupEntry:()=>Fn,scnmSampleGroupEntry:()=>En,sdp_Box:()=>Gs,sdtpBox:()=>nr,seigSampleGroupEntry:()=>Dn,sencBox:()=>js,sgpdBox:()=>or,sidxBox:()=>ar,sinfBox:()=>Ct,skipBox:()=>wt,slidBox:()=>Xr,smhdBox:()=>Re,sratBox:()=>$s,ssixBox:()=>qs,stblBox:()=>Ue,stcoBox:()=>Oe,stdpBox:()=>Ys,sterBox:()=>Zr,sthdBox:()=>He,stppSampleEntry:()=>Ne,strdBox:()=>Lt,striBox:()=>Ws,strkBox:()=>Pt,stsaSampleGroupEntry:()=>Pn,stscBox:()=>Ve,stsdBox:()=>Ge,stsgBox:()=>Xs,stshBox:()=>Zs,stssBox:()=>Qs,stszBox:()=>je,sttsBox:()=>Ke,stviBox:()=>Js,stxtSampleEntry:()=>tr,stypBox:()=>en,stz2Box:()=>tn,subsBox:()=>rn,syncSampleGroupEntry:()=>Ln,taicBox:()=>sn,taptBox:()=>Ps,teleSampleGroupEntry:()=>Cn,tencBox:()=>nn,tfdtBox:()=>$e,tfhdBox:()=>qe,tfraBox:()=>on,tkhdBox:()=>Ye,tmaxBox:()=>an,tminBox:()=>fn,totlBox:()=>ln,tpayBox:()=>dn,tpylBox:()=>un,trafBox:()=>ve,trakBox:()=>ge,trefBox:()=>bo,trepBox:()=>mn,trexBox:()=>fe,trgrBox:()=>Ot,trpyBox:()=>pn,trunBox:()=>We,tsasSampleGroupEntry:()=>Nn,tsclSampleGroupEntry:()=>Rn,tselBox:()=>hn,tsynBox:()=>Qr,tx3gSampleEntry:()=>ir,txtcBox:()=>_n,tycoBox:()=>bn,udesBox:()=>xn,udtaBox:()=>Ht,uncCBox:()=>gn,uncvSampleEntry:()=>ki,urlBox:()=>Xe,urnBox:()=>yn,viprSampleGroupEntry:()=>On,vmhdBox:()=>Ze,vp08SampleEntry:()=>vi,vp09SampleEntry:()=>Ai,vpcCBox:()=>ri,vttCBox:()=>Sn,vttcBox:()=>Tt,vvc1SampleEntry:()=>Si,vvcCBox:()=>si,vvcNSampleEntry:()=>wi,vvi1SampleEntry:()=>Bi,vvnCBox:()=>Bn,vvs1SampleEntry:()=>Ui,waveBox:()=>Ls,wbbrBox:()=>Jr,wvttSampleEntry:()=>rr,xmlBox:()=>At});var ur=class extends c{constructor(){super(...arguments);this.box_name="AV1LayeredImageIndexingProperty"}parse(e){let r=((e.readUint8()&1&1)+1)*16;this.layer_size=[];for(let s=0;s<3;s++)r===16?this.layer_size[s]=e.readUint16():this.layer_size[s]=e.readUint32()}};ur.fourcc="a1lx";var cr=class extends c{constructor(){super(...arguments);this.box_name="OperatingPointSelectorProperty"}parse(e){this.op_index=e.readUint8()}};cr.fourcc="a1op";var mr=class extends l{constructor(){super(...arguments);this.box_name="AuxiliaryTypeProperty"}parse(e){this.parseFullHeader(e),this.aux_type=e.readCString();let i=this.size-this.hdr_size-(this.aux_type.length+1);this.aux_subtype=e.readUint8Array(i)}};mr.fourcc="auxC";var pr=class extends c{constructor(){super(...arguments);this.box_name="BitRateBox"}parse(e){this.bufferSizeDB=e.readUint32(),this.maxBitrate=e.readUint32(),this.avgBitrate=e.readUint32()}};pr.fourcc="btrt";var hr=class extends l{constructor(){super(...arguments);this.box_name="CodingConstraintsBox"}parse(e){this.parseFullHeader(e);let i=e.readUint8();this.all_ref_pics_intra=(i&128)===128,this.intra_pred_used=(i&64)===64,this.max_ref_per_pic=(i&63)>>2,e.readUint24()}};hr.fourcc="ccst";var _r=class extends c{constructor(){super(...arguments);this.box_name="ComponentDefinitionBox"}parse(e){this.channel_count=e.readUint16(),this.channel_indexes=[],this.channel_types=[],this.channel_associations=[];for(let i=0;i<this.channel_count;i++)this.channel_indexes.push(e.readUint16()),this.channel_types.push(e.readUint16()),this.channel_associations.push(e.readUint16())}};_r.fourcc="cdef";var br=class extends c{constructor(){super(...arguments);this.box_name="CleanApertureBox"}parse(e){this.cleanApertureWidthN=e.readUint32(),this.cleanApertureWidthD=e.readUint32(),this.cleanApertureHeightN=e.readUint32(),this.cleanApertureHeightD=e.readUint32(),this.horizOffN=e.readUint32(),this.horizOffD=e.readUint32(),this.vertOffN=e.readUint32(),this.vertOffD=e.readUint32()}};br.fourcc="clap";var xr=class extends c{constructor(){super(...arguments);this.box_name="ContentLightLevelBox"}parse(e){this.max_content_light_level=e.readUint16(),this.max_pic_average_light_level=e.readUint16()}};xr.fourcc="clli";var gr=class extends c{constructor(){super(...arguments);this.box_name="CameraExtrinsicMatrixProperty"}parse(e){this.flags&1&&(this.pos_x=e.readInt32()),this.flags&2&&(this.pos_y=e.readInt32()),this.flags&4&&(this.pos_z=e.readInt32()),this.flags&8&&(this.version===0?this.flags&16?(this.quat_x=e.readInt32(),this.quat_y=e.readInt32(),this.quat_z=e.readInt32()):(this.quat_x=e.readInt16(),this.quat_y=e.readInt16(),this.quat_z=e.readInt16()):this.version),this.flags&32&&(this.id=e.readUint32())}};gr.fourcc="cmex";var yr=class extends c{constructor(){super(...arguments);this.box_name="CameraIntrinsicMatrixProperty"}parse(e){this.focal_length_x=e.readInt32(),this.principal_point_x=e.readInt32(),this.principal_point_y=e.readInt32(),this.flags&1&&(this.focal_length_y=e.readInt32(),this.skew_factor=e.readInt32())}};yr.fourcc="cmin";var Sr=class extends c{constructor(){super(...arguments);this.box_name="ComponentDefinitionBox"}parse(e){this.component_count=e.readUint32(),this.component_types=[],this.component_type_urls=[];for(let i=0;i<this.component_count;i++){let r=e.readUint16();this.component_types.push(r),r>=32768&&this.component_type_urls.push(e.readCString())}}};Sr.fourcc="cmpd";var Br=class extends l{constructor(){super(...arguments);this.box_name="ChunkLargeOffsetBox"}parse(e){this.parseFullHeader(e);let i=e.readUint32();if(this.chunk_offsets=[],this.version===0)for(let r=0;r<i;r++)this.chunk_offsets.push(e.readUint64())}write(e){this.version=0,this.flags=0,this.size=4+8*this.chunk_offsets.length,this.writeHeader(e),e.writeUint32(this.chunk_offsets.length);for(let i=0;i<this.chunk_offsets.length;i++)e.writeUint64(this.chunk_offsets[i])}};Br.fourcc="co64";var Ur=class extends l{constructor(){super(...arguments);this.box_name="ContentLightLevelBox"}parse(e){this.parseFullHeader(e),this.maxCLL=e.readUint16(),this.maxFALL=e.readUint16()}};Ur.fourcc="CoLL";var po=class{toString(){let t="centre_azimuth: ";return t+=this.centre_azimuth,t+=" (",t+=this.centre_azimuth*2**-16,t+="\xB0), centre_elevation: ",t+=this.centre_elevation,t+=" (",t+=this.centre_elevation*2**-16,t+="\xB0), centre_tilt: ",t+=this.centre_tilt,t+=" (",t+=this.centre_tilt*2**-16,t+="\xB0)",this.range_included_flag&&(t+=", azimuth_range: ",t+=this.azimuth_range,t+=" (",t+=this.azimuth_range*2**-16,t+="\xB0), elevation_range: ",t+=this.elevation_range,t+=" (",t+=this.elevation_range*2**-16,t+="\xB0)"),this.interpolate_included_flag&&(t+=", interpolate: ",t+=this.interpolate),t}},ho=class{toString(){let t="";return this.view_idc&&(t+="view_idc: ",t+=this.view_idc,t+=", "),t+="sphere_region: {",t+=this.sphere_region,t+="}",t}},wr=class extends l{constructor(){super(...arguments);this.box_name="CoverageInformationBox"}parse(e){this.parseFullHeader(e),this.coverage_shape_type=e.readUint8();let i=e.readUint8(),r=e.readInt8(),s=r&128;s&&(this.default_view_idc=(r&96)>>5),this.coverage_regions=new Array;for(let o=0;o<i;o++){let a=new ho;s&&(a.view_idc=e.readUint8()>>6),a.sphere_region=this.parseSphereRegion(e,!0,!0),this.coverage_regions.push(a)}}parseSphereRegion(e,i,r){let s=new po;return s.centre_azimuth=e.readInt32(),s.centre_elevation=e.readInt32(),s.centre_tilt=e.readInt32(),s.range_included_flag=i,i&&(s.azimuth_range=e.readUint32(),s.elevation_range=e.readUint32()),s.interpolate_included_flag=r,r&&(s.interpolate=(e.readUint8()&128)===128),s}};wr.fourcc="covi";var vr=class extends l{constructor(){super(...arguments);this.box_name="CopyrightBox"}parse(e){this.parseFullHeader(e),this.parseLanguage(e),this.notice=e.readCString()}};vr.fourcc="cprt";var Ar=class extends l{constructor(){super(...arguments);this.box_name="CompatibleSchemeTypeBox"}parse(e){this.parseFullHeader(e),this.scheme_type=e.readString(4),this.scheme_version=e.readUint32(),this.flags&1&&(this.scheme_uri=e.readCString())}};Ar.fourcc="csch";var ct=2147483647,Mr=class extends l{constructor(){super(...arguments);this.box_name="CompositionToDecodeBox"}parse(e){this.parseFullHeader(e),this.version===0?(this.compositionToDTSShift=e.readInt32(),this.leastDecodeToDisplayDelta=e.readInt32(),this.greatestDecodeToDisplayDelta=e.readInt32(),this.compositionStartTime=e.readInt32(),this.compositionEndTime=e.readInt32()):this.version===1&&(this.compositionToDTSShift=e.readInt64(),this.leastDecodeToDisplayDelta=e.readInt64(),this.greatestDecodeToDisplayDelta=e.readInt64(),this.compositionStartTime=e.readInt64(),this.compositionEndTime=e.readInt64())}write(e){this.version=0,(this.compositionToDTSShift>ct||this.leastDecodeToDisplayDelta>ct||this.greatestDecodeToDisplayDelta>ct||this.compositionStartTime>ct||this.compositionEndTime>ct)&&(this.version=1),this.flags=0,this.version===0?(this.size=4*5,this.writeHeader(e),e.writeInt32(this.compositionToDTSShift),e.writeInt32(this.leastDecodeToDisplayDelta),e.writeInt32(this.greatestDecodeToDisplayDelta),e.writeInt32(this.compositionStartTime),e.writeInt32(this.compositionEndTime)):this.version===1&&(this.size=8*5,this.writeHeader(e),e.writeInt64(this.compositionToDTSShift),e.writeInt64(this.leastDecodeToDisplayDelta),e.writeInt64(this.greatestDecodeToDisplayDelta),e.writeInt64(this.compositionStartTime),e.writeInt64(this.compositionEndTime))}};Mr.fourcc="cslg";var Ir=class extends l{constructor(){super(...arguments);this.box_name="CompositionOffsetBox"}parse(e){this.parseFullHeader(e);let i=e.readUint32();if(this.sample_counts=[],this.sample_offsets=[],this.version===0)for(let r=0;r<i;r++){this.sample_counts.push(e.readUint32());let s=e.readInt32();s<0&&u.warn("BoxParser","ctts box uses negative values without using version 1"),this.sample_offsets.push(s)}else if(this.version===1)for(let r=0;r<i;r++)this.sample_counts.push(e.readUint32()),this.sample_offsets.push(e.readInt32())}write(e){this.version=this.sample_offsets.some(i=>i<0)?1:0,this.flags=0,this.size=4+8*this.sample_counts.length,this.writeHeader(e),e.writeUint32(this.sample_counts.length);for(let i=0;i<this.sample_counts.length;i++)e.writeUint32(this.sample_counts[i]),this.version===1?e.writeInt32(this.sample_offsets[i]):e.writeUint32(this.sample_offsets[i])}unpack(e){let i=0;for(let r=0;r<this.sample_counts.length;r++)for(let s=0;s<this.sample_counts[r];s++)e[i].pts=e[i].dts+this.sample_offsets[r],i++}};Ir.fourcc="ctts";var zr=class extends c{constructor(){super(...arguments);this.box_name="AC3SpecificBox"}parse(e){let i=e.readUint8(),r=e.readUint8(),s=e.readUint8();this.fscod=i>>6,this.bsid=i>>1&31,this.bsmod=(i&1)<<2|r>>6&3,this.acmod=r>>3&7,this.lfeon=r>>2&1,this.bit_rate_code=r&3|s>>5&7}};zr.fourcc="dac3";var Tr=class extends c{constructor(){super(...arguments);this.box_name="EC3SpecificBox"}parse(e){let i=e.readUint16();this.data_rate=i>>3,this.num_ind_sub=i&7,this.ind_subs=[];for(let r=0;r<this.num_ind_sub+1;r++){let s=e.readUint8(),o=e.readUint8(),a=e.readUint8(),f={fscod:s>>6,bsid:s>>1&31,bsmod:(s&1)<<4|o>>4&15,acmod:o>>1&7,lfeon:o&1,num_dep_sub:a>>1&15};this.ind_subs.push(f),f.num_dep_sub>0&&(f.chan_loc=(a&1)<<8|e.readUint8())}}};Tr.fourcc="dec3";var kr=class extends l{constructor(){super(...arguments);this.box_name="FLACSpecificBox"}parse(e){this.parseFullHeader(e);let i=127,r=128,s=[],o=["STREAMINFO","PADDING","APPLICATION","SEEKTABLE","VORBIS_COMMENT","CUESHEET","PICTURE","RESERVED"],a;do{a=e.readUint8();let f=Math.min(a&i,o.length-1);f?e.readUint8Array(e.readUint24()):(e.readUint8Array(13),this.samplerate=e.readUint32()>>12,e.readUint8Array(20)),s.push(o[f])}while(a&r);this.numMetadataBlocks=s.length+" ("+s.join(", ")+")"}};kr.fourcc="dfLa";var Fr=class extends c{constructor(){super(...arguments);this.box_name="hintimmediateBytesSent"}parse(e){this.bytessent=e.readUint64()}};Fr.fourcc="dimm";var Er=class extends c{constructor(){super(...arguments);this.box_name="hintlongestpacket"}parse(e){this.time=e.readUint32()}};Er.fourcc="dmax";var Dr=class extends c{constructor(){super(...arguments);this.box_name="hintmediaBytesSent"}parse(e){this.bytessent=e.readUint64()}};Dr.fourcc="dmed";var Pr=class extends c{constructor(){super(...arguments);this.box_name="OpusSpecificBox"}parse(e){if(this.Version=e.readUint8(),this.OutputChannelCount=e.readUint8(),this.PreSkip=e.readUint16(),this.InputSampleRate=e.readUint32(),this.OutputGain=e.readInt16(),this.ChannelMappingFamily=e.readUint8(),this.ChannelMappingFamily!==0){this.StreamCount=e.readUint8(),this.CoupledCount=e.readUint8(),this.ChannelMapping=[];for(let i=0;i<this.OutputChannelCount;i++)this.ChannelMapping[i]=e.readUint8()}}write(e){if(this.size=11,this.ChannelMappingFamily!==0&&(this.size+=2+this.OutputChannelCount),this.writeHeader(e),e.writeUint8(this.Version),e.writeUint8(this.OutputChannelCount),e.writeUint16(this.PreSkip),e.writeUint32(this.InputSampleRate),e.writeInt16(this.OutputGain),e.writeUint8(this.ChannelMappingFamily),this.ChannelMappingFamily!==0){e.writeUint8(this.StreamCount),e.writeUint8(this.CoupledCount);for(let i=0;i<this.OutputChannelCount;i++)e.writeUint8(this.ChannelMapping[i])}}};Pr.fourcc="dOps";var Lr=class extends c{constructor(){super(...arguments);this.box_name="hintrepeatedBytesSent"}parse(e){this.bytessent=e.readUint64()}};Lr.fourcc="drep";var Cr=class extends l{constructor(){super(...arguments);this.box_name="EditListBox"}parse(e){this.parseFullHeader(e),this.entries=[];let i=e.readUint32();for(let r=0;r<i;r++){let s={segment_duration:this.version===1?e.readUint64():e.readUint32(),media_time:this.version===1?e.readInt64():e.readInt32(),media_rate_integer:e.readInt16(),media_rate_fraction:e.readInt16()};this.entries.push(s)}}write(e){let i=this.entries.some(r=>r.segment_duration>w||r.media_time>w)||this.version===1;this.version=i?1:0,this.size=4+12*this.entries.length,this.size+=i?2*4*this.entries.length:0,this.writeHeader(e),e.writeUint32(this.entries.length);for(let r=0;r<this.entries.length;r++){let s=this.entries[r];i?(e.writeUint64(s.segment_duration),e.writeInt64(s.media_time)):(e.writeUint32(s.segment_duration),e.writeInt32(s.media_time)),e.writeInt16(s.media_rate_integer),e.writeInt16(s.media_rate_fraction)}}};Cr.fourcc="elst";var Nr=class extends l{constructor(){super(...arguments);this.box_name="EventMessageBox"}parse(e){this.parseFullHeader(e),this.version===1?(this.timescale=e.readUint32(),this.presentation_time=e.readUint64(),this.event_duration=e.readUint32(),this.id=e.readUint32(),this.scheme_id_uri=e.readCString(),this.value=e.readCString()):(this.scheme_id_uri=e.readCString(),this.value=e.readCString(),this.timescale=e.readUint32(),this.presentation_time_delta=e.readUint32(),this.event_duration=e.readUint32(),this.id=e.readUint32());let i=this.size-this.hdr_size-(4*4+(this.scheme_id_uri.length+1)+(this.value.length+1));this.version===1&&(i-=4),this.message_data=e.readUint8Array(i)}write(e){this.version=0,this.flags=0,this.size=4*4+this.message_data.length+(this.scheme_id_uri.length+1)+(this.value.length+1),this.writeHeader(e),e.writeCString(this.scheme_id_uri),e.writeCString(this.value),e.writeUint32(this.timescale),e.writeUint32(this.presentation_time_delta),e.writeUint32(this.event_duration),e.writeUint32(this.id),e.writeUint8Array(this.message_data)}};Nr.fourcc="emsg";var F=class extends l{parse(t){this.parseFullHeader(t),this.group_id=t.readUint32(),this.num_entities_in_group=t.readUint32(),this.entity_ids=[];for(let e=0;e<this.num_entities_in_group;e++){let i=t.readUint32();this.entity_ids.push(i)}}};var Rr=class extends F{constructor(){super(...arguments);this.box_name="Auto exposure bracketing"}};Rr.fourcc="aebr";var Or=class extends F{constructor(){super(...arguments);this.box_name="Flash exposure information"}};Or.fourcc="afbr";var Hr=class extends F{constructor(){super(...arguments);this.box_name="Album collection"}};Hr.fourcc="albc";var Vr=class extends F{constructor(){super(...arguments);this.box_name="Alternative entity"}};Vr.fourcc="altr";var Gr=class extends F{constructor(){super(...arguments);this.box_name="Burst image"}};Gr.fourcc="brst";var jr=class extends F{constructor(){super(...arguments);this.box_name="Depth of field bracketing"}};jr.fourcc="dobr";var Kr=class extends F{constructor(){super(...arguments);this.box_name="Equivalent entity"}};Kr.fourcc="eqiv";var $r=class extends F{constructor(){super(...arguments);this.box_name="Favorites collection"}};$r.fourcc="favc";var qr=class extends F{constructor(){super(...arguments);this.box_name="Focus bracketing"}};qr.fourcc="fobr";var Yr=class extends F{constructor(){super(...arguments);this.box_name="Image item with an audio track"}};Yr.fourcc="iaug";var Wr=class extends F{constructor(){super(...arguments);this.box_name="Panorama"}};Wr.fourcc="pano";var Xr=class extends F{constructor(){super(...arguments);this.box_name="Slideshow"}};Xr.fourcc="slid";var Zr=class extends F{constructor(){super(...arguments);this.box_name="Stereo"}};Zr.fourcc="ster";var Qr=class extends F{constructor(){super(...arguments);this.box_name="Time-synchronized capture"}};Qr.fourcc="tsyn";var Jr=class extends F{constructor(){super(...arguments);this.box_name="White balance bracketing"}};Jr.fourcc="wbbr";var es=class extends F{constructor(){super(...arguments);this.box_name="Progressive rendering"}};es.fourcc="prgr";var ts=class extends F{constructor(){super(...arguments);this.box_name="Image pyramid"}parse(e){this.parseFullHeader(e),this.group_id=e.readUint32(),this.num_entities_in_group=e.readUint32(),this.entity_ids=[];for(let i=0;i<this.num_entities_in_group;i++){let r=e.readUint32();this.entity_ids.push(r)}this.tile_size_x=e.readUint16(),this.tile_size_y=e.readUint16(),this.layer_binning=[],this.tiles_in_layer_column_minus1=[],this.tiles_in_layer_row_minus1=[];for(let i=0;i<this.num_entities_in_group;i++)this.layer_binning[i]=e.readUint16(),this.tiles_in_layer_row_minus1[i]=e.readUint16(),this.tiles_in_layer_column_minus1[i]=e.readUint16()}};ts.fourcc="pymd";var is=class extends c{constructor(){super(...arguments);this.box_name="FieldHandlingBox"}parse(e){this.fieldCount=e.readUint8(),this.fieldOrdering=e.readUint8()}};is.fourcc="fiel";var rs=class extends c{constructor(){super(...arguments);this.box_name="OriginalFormatBox"}parse(e){this.data_format=e.readString(4)}};rs.fourcc="frma";var ss=class extends c{constructor(){super(...arguments);this.box_name="ImageMirror"}parse(e){let i=e.readUint8();this.reserved=i>>7,this.axis=i&1}};ss.fourcc="imir";var ns=class extends l{constructor(){super(...arguments);this.box_name="ItemPropertyAssociationBox"}parse(e){this.parseFullHeader(e);let i=e.readUint32();this.associations=[];for(let r=0;r<i;r++){let s=this.version<1?e.readUint16():e.readUint32(),o=[],a=e.readUint8();for(let f=0;f<a;f++){let d=e.readUint8();o.push({essential:(d&128)>>7===1,property_index:this.flags&1?(d&127)<<8|e.readUint8():d&127})}this.associations.push({id:s,props:o})}}};ns.fourcc="ipma";var os=class extends c{constructor(){super(...arguments);this.box_name="ImageRotation"}parse(e){this.angle=e.readUint8()&3}};os.fourcc="irot";var as=class extends l{constructor(){super(...arguments);this.box_name="ImageSpatialExtentsProperty"}parse(e){this.parseFullHeader(e),this.image_width=e.readUint32(),this.image_height=e.readUint32()}};as.fourcc="ispe";var fs=class extends l{constructor(){super(...arguments);this.box_name="TAITimestampBox"}parse(e){this.TAI_timestamp=e.readUint64();let i=e.readUint8();this.sychronization_state=i>>7&1,this.timestamp_generation_failure=i>>6&1,this.timestamp_is_modified=i>>5&1}};fs.fourcc="itai";var ls=class extends l{constructor(){super(...arguments);this.box_name="KindBox"}parse(e){this.parseFullHeader(e),this.schemeURI=e.readCString(),this.isEndOfBox(e)||(this.value=e.readCString())}write(e){this.version=0,this.flags=0,this.size=this.schemeURI.length+1+(this.value?this.value.length+1:0),this.writeHeader(e),e.writeCString(this.schemeURI),this.value&&e.writeCString(this.value)}};ls.fourcc="kind";var ds=class extends l{constructor(){super(...arguments);this.box_name="LevelAssignmentBox"}parse(e){this.parseFullHeader(e);let i=e.readUint8();this.levels=[];for(let r=0;r<i;r++){let s={};this.levels[r]=s,s.track_ID=e.readUint32();let o=e.readUint8();switch(s.padding_flag=o>>7,s.assignment_type=o&127,s.assignment_type){case 0:s.grouping_type=e.readString(4);break;case 1:s.grouping_type=e.readString(4),s.grouping_type_parameter=e.readUint32();break;case 2:break;case 3:break;case 4:s.sub_track_id=e.readUint32();break;default:u.warn("BoxParser",`Unknown level assignment type: ${s.assignment_type}`)}}}};ds.fourcc="leva";var us=class extends c{constructor(){super(...arguments);this.box_name="LHEVCConfigurationBox"}parse(e){this.configurationVersion=e.readUint8(),this.min_spatial_segmentation_idc=e.readUint16()&4095,this.parallelismType=e.readUint8()&3;let i=e.readUint8();this.numTemporalLayers=(i&13)>>3,this.temporalIdNested=(i&4)>>2,this.lengthSizeMinusOne=i&3,this.nalu_arrays=[];let r=e.readUint8();for(let s=0;s<r;s++){let o=[];this.nalu_arrays.push(o),i=e.readUint8(),o.completeness=(i&128)>>7,o.nalu_type=i&63;let a=e.readUint16();for(let f=0;f<a;f++){let d=e.readUint16();o.push({data:e.readUint8Array(d)})}}}};us.fourcc="lhvC";var cs=class extends c{constructor(){super(...arguments);this.box_name="LayerSelectorProperty"}parse(e){this.layer_id=e.readUint16()}};cs.fourcc="lsel";var ms=class extends c{constructor(){super(...arguments);this.box_name="hintmaxrate"}parse(e){this.period=e.readUint32(),this.bytes=e.readUint32()}};ms.fourcc="maxr";var le=class{constructor(t,e){this.x=t;this.y=e}toString(){return"("+this.x+","+this.y+")"}};var ps=class extends c{constructor(){super(...arguments);this.box_name="MasteringDisplayColourVolumeBox"}parse(e){this.display_primaries=[],this.display_primaries[0]=new le(e.readUint16(),e.readUint16()),this.display_primaries[1]=new le(e.readUint16(),e.readUint16()),this.display_primaries[2]=new le(e.readUint16(),e.readUint16()),this.white_point=new le(e.readUint16(),e.readUint16()),this.max_display_mastering_luminance=e.readUint32(),this.min_display_mastering_luminance=e.readUint32()}};ps.fourcc="mdcv";var hs=class extends l{constructor(){super(...arguments);this.box_name="MovieFragmentRandomAccessOffsetBox"}parse(e){this.parseFullHeader(e),this._size=e.readUint32()}};hs.fourcc="mfro";var _s=class extends l{constructor(){super(...arguments);this.box_name="MaskConfigurationProperty"}parse(e){this.parseFullHeader(e),this.bits_per_pixel=e.readUint8()}};_s.fourcc="mskC";var bs=class extends c{constructor(){super(...arguments);this.box_name="hintPacketsSent"}parse(e){this.packetssent=e.readUint32()}};bs.fourcc="npck";var xs=class extends c{constructor(){super(...arguments);this.box_name="hintPacketsSent"}parse(e){this.packetssent=e.readUint64()}};xs.fourcc="nump";var _o=class{constructor(t,e){this.pad1=t;this.pad2=e}},gs=class extends l{constructor(){super(...arguments);this.box_name="PaddingBitsBox"}parse(e){this.parseFullHeader(e);let i=e.readUint32();this.padbits=[];for(let r=0;r<Math.floor((i+1)/2);r++){let s=e.readUint8(),o=(s&112)>>4,a=s&7;this.padbits.push(new _o(o,a))}}};gs.fourcc="padb";var ys=class extends c{constructor(){super(...arguments);this.box_name="PixelAspectRatioBox"}parse(e){this.hSpacing=e.readUint32(),this.vSpacing=e.readUint32()}};ys.fourcc="pasp";var Ss=class extends c{constructor(){super(...arguments);this.box_name="CuePayloadBox"}parse(e){this.text=e.readString(this.size-this.hdr_size)}};Ss.fourcc="payl";var Bs=class extends c{constructor(){super(...arguments);this.box_name="hintpayloadID"}parse(e){this.payloadID=e.readUint32();let i=e.readUint8();this.rtpmap_string=e.readString(i)}};Bs.fourcc="payt";var Us=class extends l{constructor(){super(...arguments);this.box_name="ProgressiveDownloadInfoBox";this.rate=[];this.initial_delay=[]}parse(e){this.parseFullHeader(e);let i=(this.size-this.hdr_size)/8;for(let r=0;r<i;r++)this.rate[r]=e.readUint32(),this.initial_delay[r]=e.readUint32()}};Us.fourcc="pdin";var ws=class extends l{constructor(){super(...arguments);this.box_name="PixelInformationProperty"}parse(e){this.parseFullHeader(e),this.num_channels=e.readUint8(),this.bits_per_channels=[];for(let i=0;i<this.num_channels;i++)this.bits_per_channels[i]=e.readUint8()}};ws.fourcc="pixi";var vs=class extends c{constructor(){super(...arguments);this.box_name="hintlargestpacket"}parse(e){this.bytes=e.readUint32()}};vs.fourcc="pmax";var As=class extends l{constructor(){super(...arguments);this.box_name="ProgressiveDerivedImageItemInformationProperty"}parse(e){if(this.parseFullHeader(e),this.step_count=e.readUint16(),this.item_count=[],this.flags&2)for(let i=0;i<this.step_count;i++)this.item_count[i]=e.readUint16()}};As.fourcc="prdi";var Ms=class extends l{constructor(){super(...arguments);this.box_name="ProjectionFormatBox"}parse(e){this.parseFullHeader(e),this.projection_type=e.readUint8()&31}};Ms.fourcc="prfr";var Is=class extends l{constructor(){super(...arguments);this.box_name="ProducerReferenceTimeBox"}parse(e){this.parseFullHeader(e),this.ref_track_id=e.readUint32(),this.ntp_timestamp=e.readUint64(),this.version===0?this.media_time=e.readUint32():this.media_time=e.readUint64()}};Is.fourcc="prft";var zs=class extends l{constructor(){super(...arguments);this.box_name="ProtectionSystemSpecificHeaderBox"}parse(e){if(this.parseFullHeader(e),this.system_id=G(e),this.kid=[],this.version>0){let r=e.readUint32();for(let s=0;s<r;s++)this.kid[s]=G(e)}let i=e.readUint32();i>0&&(this.protection_data=e.readUint8Array(i))}};zs.fourcc="pssh";var Ts=class extends l{constructor(){super(...arguments);this.box_name="TrackCleanApertureDimensionsBox"}parse(e){this.parseFullHeader(e),this.width=e.readUint32(),this.height=e.readUint32()}};Ts.fourcc="clef";function Jo(n,t){if(n===W.Types.UTF8)return new TextDecoder("utf-8").decode(t);let e=new DataView(t.buffer);if(n===W.Types.BE_UNSIGNED_INT){if(t.length===1)return e.getUint8(0);if(t.length===2)return e.getUint16(0,!1);if(t.length===4)return e.getUint32(0,!1);if(t.length===8)return e.getBigUint64(0,!1);throw new Error("Unsupported ITIF_TYPE_BE_UNSIGNED_INT length "+t.length)}else if(n===W.Types.BE_SIGNED_INT){if(t.length===1)return e.getInt8(0);if(t.length===2)return e.getInt16(0,!1);if(t.length===4)return e.getInt32(0,!1);if(t.length===8)return e.getBigInt64(0,!1);throw new Error("Unsupported ITIF_TYPE_BE_SIGNED_INT length "+t.length)}else if(n===W.Types.BE_FLOAT32)return e.getFloat32(0,!1);u.warn("DataBox","Unsupported or unimplemented itif data type: "+n)}var W=class extends c{constructor(){super(...arguments);this.box_name="DataBox"}parse(e){this.valueType=e.readUint32(),this.country=e.readUint16(),this.country>255&&(e.seek(e.getPosition()-2),this.countryString=e.readString(2)),this.language=e.readUint16(),this.language>255&&(e.seek(e.getPosition()-2),this.parseLanguage(e)),this.raw=e.readUint8Array(this.size-this.hdr_size-8),this.value=Jo(this.valueType,this.raw)}};W.fourcc="data",W.Types={RESERVED:0,UTF8:1,UTF16:2,SJIS:3,UTF8_SORT:4,UTF16_SORT:5,JPEG:13,PNG:14,BE_SIGNED_INT:21,BE_UNSIGNED_INT:22,BE_FLOAT32:23,BE_FLOAT64:24,BMP:27,QT_ATOM:28,BE_SIGNED_INT8:65,BE_SIGNED_INT16:66,BE_SIGNED_INT32:67,BE_FLOAT32_POINT:70,BE_FLOAT32_DIMENSIONS:71,BE_FLOAT32_RECT:72,BE_SIGNED_INT64:74,BE_UNSIGNED_INT8:75,BE_UNSIGNED_INT16:76,BE_UNSIGNED_INT32:77,BE_UNSIGNED_INT64:78,BE_FLOAT64_AFFINE_TRANSFORM:79};var ks=class extends l{constructor(){super(...arguments);this.box_name="TrackEncodedPixelsDimensionsBox"}parse(e){this.parseFullHeader(e),this.width=e.readUint32(),this.height=e.readUint32()}};ks.fourcc="enof";var Fs=class extends c{constructor(){super(...arguments);this.box_name="IlstBox"}parse(e){this.list={};let i=this.size-this.hdr_size;for(;i>0;){let r=e.readUint32(),s=e.readUint32(),o=z(e,!1,r-8);o.code===v&&(this.list[s]=o.box),i-=r}}};Fs.fourcc="ilst";var Es=class extends l{constructor(){super(...arguments);this.box_name="KeysBox"}parse(e){this.parseFullHeader(e),this.count=e.readUint32(),this.keys={};for(let i=0;i<this.count;i++){let r=e.readUint32();this.keys[i+1]=e.readString(r-4)}}};Es.fourcc="keys";var Ds=class extends l{constructor(){super(...arguments);this.box_name="TrackProductionApertureDimensionsBox"}parse(e){this.parseFullHeader(e),this.width=e.readUint32(),this.height=e.readUint32()}};Ds.fourcc="prof";var Ps=class extends g{constructor(){super(...arguments);this.box_name="TrackApertureModeDimensionsBox";this.clefs=[];this.profs=[];this.enofs=[];this.subBoxNames=["clef","prof","enof"]}};Ps.fourcc="tapt";var Ls=class extends g{constructor(){super(...arguments);this.box_name="siDecompressionParamBox"}};Ls.fourcc="wave";var Cs=class extends c{constructor(){super(...arguments);this.box_name="rtpmoviehintinformation"}parse(e){this.descriptionformat=e.readString(4),this.sdptext=e.readString(this.size-this.hdr_size-4)}};Cs.fourcc="rtp ";var Ns=class extends l{constructor(){super(...arguments);this.box_name="SampleAuxiliaryInformationOffsetsBox"}parse(e){this.parseFullHeader(e),this.flags&1&&(this.aux_info_type=e.readString(4),this.aux_info_type_parameter=e.readUint32());let i=e.readUint32();this.offset=[];for(let r=0;r<i;r++)this.version===0?this.offset[r]=e.readUint32():this.offset[r]=e.readUint64()}};Ns.fourcc="saio";var Rs=class extends l{constructor(){super(...arguments);this.box_name="SampleAuxiliaryInformationSizesBox"}parse(e){if(this.parseFullHeader(e),this.flags&1&&(this.aux_info_type=e.readString(4),this.aux_info_type_parameter=e.readUint32()),this.default_sample_info_size=e.readUint8(),this.sample_count=e.readUint32(),this.sample_info_size=[],this.default_sample_info_size===0)for(let i=0;i<this.sample_count;i++)this.sample_info_size[i]=e.readUint8()}};Rs.fourcc="saiz";var Os=class{constructor(t,e){this.bad_pixel_row=t;this.bad_pixel_column=e}toString(){return"[row: "+this.bad_pixel_row+", column: "+this.bad_pixel_column+"]"}};var Hs=class extends l{constructor(){super(...arguments);this.box_name="SensorBadPixelsMapBox"}parse(e){this.parseFullHeader(e),this.component_count=e.readUint16(),this.component_index=[];for(let r=0;r<this.component_count;r++)this.component_index.push(e.readUint16());let i=e.readUint8();this.correction_applied=(i&128)===128,this.num_bad_rows=e.readUint32(),this.num_bad_cols=e.readUint32(),this.num_bad_pixels=e.readUint32(),this.bad_rows=[],this.bad_columns=[],this.bad_pixels=[];for(let r=0;r<this.num_bad_rows;r++)this.bad_rows.push(e.readUint32());for(let r=0;r<this.num_bad_cols;r++)this.bad_columns.push(e.readUint32());for(let r=0;r<this.num_bad_pixels;r++){let s=e.readUint32(),o=e.readUint32();this.bad_pixels.push(new Os(s,o))}}};Hs.fourcc="sbpm";var Vs=class extends l{constructor(){super(...arguments);this.box_name="SchemeTypeBox"}parse(e){this.parseFullHeader(e),this.scheme_type=e.readString(4),this.scheme_version=e.readUint32(),this.flags&1&&(this.scheme_uri=e.readString(this.size-this.hdr_size-8))}};Vs.fourcc="schm";var Gs=class extends c{constructor(){super(...arguments);this.box_name="rtptracksdphintinformation"}parse(e){this.sdptext=e.readString(this.size-this.hdr_size)}};Gs.fourcc="sdp ";var js=class extends l{constructor(){super(...arguments);this.box_name="SampleEncryptionBox"}};js.fourcc="senc";var Ks=class extends l{constructor(){super(...arguments);this.box_name="SMPTE2086MasteringDisplayMetadataBox"}parse(e){this.parseFullHeader(e),this.primaryRChromaticity_x=e.readUint16(),this.primaryRChromaticity_y=e.readUint16(),this.primaryGChromaticity_x=e.readUint16(),this.primaryGChromaticity_y=e.readUint16(),this.primaryBChromaticity_x=e.readUint16(),this.primaryBChromaticity_y=e.readUint16(),this.whitePointChromaticity_x=e.readUint16(),this.whitePointChromaticity_y=e.readUint16(),this.luminanceMax=e.readUint32(),this.luminanceMin=e.readUint32()}};Ks.fourcc="SmDm";var $s=class extends l{constructor(){super(...arguments);this.box_name="SamplingRateBox"}parse(e){this.parseFullHeader(e),this.sampling_rate=e.readUint32()}};$s.fourcc="srat";var qs=class extends l{constructor(){super(...arguments);this.box_name="CompressedSubsegmentIndexBox"}parse(e){this.parseFullHeader(e),this.subsegments=[];let i=e.readUint32();for(let r=0;r<i;r++){let s={};this.subsegments.push(s),s.ranges=[];let o=e.readUint32();for(let a=0;a<o;a++){let f={};s.ranges.push(f),f.level=e.readUint8(),f.range_size=e.readUint24()}}}};qs.fourcc="ssix";var Ys=class extends l{constructor(){super(...arguments);this.box_name="DegradationPriorityBox"}parse(e){this.parseFullHeader(e);let i=(this.size-this.hdr_size)/2;this.priority=[];for(let r=0;r<i;r++)this.priority[r]=e.readUint16()}};Ys.fourcc="stpd";var Ws=class extends l{constructor(){super(...arguments);this.box_name="SubTrackInformationBox"}parse(e){this.parseFullHeader(e),this.switch_group=e.readUint16(),this.alternate_group=e.readUint16(),this.sub_track_id=e.readUint32();let i=(this.size-this.hdr_size-8)/4;this.attribute_list=[];for(let r=0;r<i;r++)this.attribute_list[r]=e.readUint32()}};Ws.fourcc="stri";var Xs=class extends l{constructor(){super(...arguments);this.box_name="SubTrackSampleGroupBox"}parse(e){this.parseFullHeader(e),this.grouping_type=e.readUint32();let i=e.readUint16();this.group_description_index=[];for(let r=0;r<i;r++)this.group_description_index[r]=e.readUint32()}};Xs.fourcc="stsg";var Zs=class extends l{constructor(){super(...arguments);this.box_name="ShadowSyncSampleBox"}parse(e){this.parseFullHeader(e);let i=e.readUint32();if(this.shadowed_sample_numbers=[],this.sync_sample_numbers=[],this.version===0)for(let r=0;r<i;r++)this.shadowed_sample_numbers.push(e.readUint32()),this.sync_sample_numbers.push(e.readUint32())}write(e){this.version=0,this.flags=0,this.size=4+8*this.shadowed_sample_numbers.length,this.writeHeader(e),e.writeUint32(this.shadowed_sample_numbers.length);for(let i=0;i<this.shadowed_sample_numbers.length;i++)e.writeUint32(this.shadowed_sample_numbers[i]),e.writeUint32(this.sync_sample_numbers[i])}};Zs.fourcc="stsh";var Qs=class extends l{constructor(){super(...arguments);this.box_name="SyncSampleBox"}parse(e){this.parseFullHeader(e);let i=e.readUint32();if(this.version===0){this.sample_numbers=[];for(let r=0;r<i;r++)this.sample_numbers.push(e.readUint32())}}write(e){this.version=0,this.flags=0,this.size=4+4*this.sample_numbers.length,this.writeHeader(e),e.writeUint32(this.sample_numbers.length),e.writeUint32Array(this.sample_numbers)}};Qs.fourcc="stss";var Js=class extends l{constructor(){super(...arguments);this.box_name="StereoVideoBox"}parse(e){this.parseFullHeader(e);let i=e.readUint32();this.single_view_allowed=i&3,this.stereo_scheme=e.readUint32();let r=e.readUint32();for(this.stereo_indication_type=e.readString(r),this.boxes=[];e.getPosition()<this.start+this.size;){let s=z(e,!1,this.size-(e.getPosition()-this.start));if(s.code===v){let o=s.box;this.boxes.push(o),this[o.type]=o}else return}}};Js.fourcc="stvi";var en=class extends c{constructor(){super(...arguments);this.box_name="SegmentTypeBox"}parse(e){let i=this.size-this.hdr_size;this.major_brand=e.readString(4),this.minor_version=e.readUint32(),i-=8,this.compatible_brands=[];let r=0;for(;i>=4;)this.compatible_brands[r]=e.readString(4),i-=4,r++}write(e){this.size=8+4*this.compatible_brands.length,this.writeHeader(e),e.writeString(this.major_brand,void 0,4),e.writeUint32(this.minor_version);for(let i=0;i<this.compatible_brands.length;i++)e.writeString(this.compatible_brands[i],void 0,4)}};en.fourcc="styp";var tn=class extends l{constructor(){super(...arguments);this.box_name="CompactSampleSizeBox"}parse(e){if(this.parseFullHeader(e),this.sample_sizes=[],this.version===0){this.reserved=e.readUint24(),this.field_size=e.readUint8();let i=e.readUint32();if(this.field_size===4)for(let r=0;r<i;r+=2){let s=e.readUint8();this.sample_sizes[r]=s>>4&15,this.sample_sizes[r+1]=s&15}else if(this.field_size===8)for(let r=0;r<i;r++)this.sample_sizes[r]=e.readUint8();else if(this.field_size===16)for(let r=0;r<i;r++)this.sample_sizes[r]=e.readUint16();else u.error("BoxParser","Error in length field in stz2 box",e.isofile)}}};tn.fourcc="stz2";var rn=class extends l{constructor(){super(...arguments);this.box_name="SubSampleInformationBox"}parse(e){this.parseFullHeader(e);let i=e.readUint32();this.entries=[];let r;for(let s=0;s<i;s++){let o={};if(this.entries[s]=o,o.sample_delta=e.readUint32(),o.subsamples=[],r=e.readUint16(),r>0)for(let a=0;a<r;a++){let f={};o.subsamples.push(f),this.version===1?f.size=e.readUint32():f.size=e.readUint16(),f.priority=e.readUint8(),f.discardable=e.readUint8(),f.codec_specific_parameters=e.readUint32()}}}};rn.fourcc="subs";var sn=class extends l{constructor(){super(...arguments);this.box_name="TAIClockInfoBox"}parse(e){this.time_uncertainty=e.readUint64(),this.clock_resolution=e.readUint32(),this.clock_drift_rate=e.readInt32();let i=e.readUint8();this.clock_type=(i&192)>>6}};sn.fourcc="taic";var nn=class extends l{constructor(){super(...arguments);this.box_name="TrackEncryptionBox"}parse(e){if(this.parseFullHeader(e),e.readUint8(),this.version===0)e.readUint8();else{let i=e.readUint8();this.default_crypt_byte_block=i>>4&15,this.default_skip_byte_block=i&15}this.default_isProtected=e.readUint8(),this.default_Per_Sample_IV_Size=e.readUint8(),this.default_KID=G(e),this.default_isProtected===1&&this.default_Per_Sample_IV_Size===0&&(this.default_constant_IV_size=e.readUint8(),this.default_constant_IV=e.readUint8Array(this.default_constant_IV_size))}};nn.fourcc="tenc";var on=class extends l{constructor(){super(...arguments);this.box_name="TrackFragmentRandomAccessBox"}parse(e){this.parseFullHeader(e),this.track_ID=e.readUint32(),e.readUint24();let i=e.readUint8();this.length_size_of_traf_num=i>>4&3,this.length_size_of_trun_num=i>>2&3,this.length_size_of_sample_num=i&3,this.entries=[];let r=e.readUint32();for(let s=0;s<r;s++)this.version===1?(this.time=e.readUint64(),this.moof_offset=e.readUint64()):(this.time=e.readUint32(),this.moof_offset=e.readUint32()),this.traf_number=e["readUint"+8*(this.length_size_of_traf_num+1)](),this.trun_number=e["readUint"+8*(this.length_size_of_trun_num+1)](),this.sample_number=e["readUint"+8*(this.length_size_of_sample_num+1)]()}};on.fourcc="tfra";var an=class extends c{constructor(){super(...arguments);this.box_name="hintmaxrelativetime"}parse(e){this.time=e.readUint32()}};an.fourcc="tmax";var fn=class extends c{constructor(){super(...arguments);this.box_name="hintminrelativetime"}parse(e){this.time=e.readUint32()}};fn.fourcc="tmin";var ln=class extends c{constructor(){super(...arguments);this.box_name="hintBytesSent"}parse(e){this.bytessent=e.readUint32()}};ln.fourcc="totl";var dn=class extends c{constructor(){super(...arguments);this.box_name="hintBytesSent"}parse(e){this.bytessent=e.readUint32()}};dn.fourcc="tpay";var un=class extends c{constructor(){super(...arguments);this.box_name="hintBytesSent"}parse(e){this.bytessent=e.readUint64()}};un.fourcc="tpyl";var cn=class extends tt{};cn.fourcc="msrc";var mt=class mt extends c{constructor(){super(...arguments);this.box_name="TrackReferenceBox";this.references=[]}parse(e){for(;e.getPosition()<this.start+this.size;){let i=z(e,!0,this.size-(e.getPosition()-this.start));if(i.code===v){mt.allowed_types.includes(i.type)||u.warn("BoxParser",`Unknown track reference type: '${i.type}'`);let r=new st(i.type,i.size,i.hdr_size,i.start);r.write===c.prototype.write&&r.type!=="mdat"&&(u.info("BoxParser","TrackReference "+r.type+" box writing not yet implemented, keeping unparsed data in memory for later write"),r.parseDataAndRewind(e)),r.parse(e),this.references.push(r)}else return}}};mt.fourcc="tref",mt.allowed_types=["hint","cdsc","font","hind","vdep","vplx","subt","thmb","auxl","cdtg","shsc","aest"];var bo=mt;var mn=class extends l{constructor(){super(...arguments);this.box_name="TrackExtensionPropertiesBox"}parse(e){for(this.parseFullHeader(e),this.track_ID=e.readUint32(),this.boxes=[];e.getPosition()<this.start+this.size;){let i=z(e,!1,this.size-(e.getPosition()-this.start));if(i.code===v){let r=i.box;this.boxes.push(r)}else return}}};mn.fourcc="trep";var pn=class extends c{constructor(){super(...arguments);this.box_name="hintBytesSent"}parse(e){this.bytessent=e.readUint64()}};pn.fourcc="trpy";var hn=class extends l{constructor(){super(...arguments);this.box_name="TrackSelectionBox"}parse(e){this.parseFullHeader(e),this.switch_group=e.readUint32();let i=(this.size-this.hdr_size-4)/4;this.attribute_list=[];for(let r=0;r<i;r++)this.attribute_list[r]=e.readUint32()}};hn.fourcc="tsel";var _n=class extends l{constructor(){super(...arguments);this.box_name="TextConfigBox"}parse(e){this.parseFullHeader(e),this.config=e.readCString()}};_n.fourcc="txtc";var bn=class extends c{constructor(){super(...arguments);this.box_name="TypeCombinationBox"}parse(e){let i=(this.size-this.hdr_size)/4;this.compatible_brands=[];for(let r=0;r<i;r++)this.compatible_brands[r]=e.readString(4)}};bn.fourcc="tyco";var xn=class extends l{constructor(){super(...arguments);this.box_name="UserDescriptionProperty"}parse(e){this.parseFullHeader(e),this.lang=e.readCString(),this.name=e.readCString(),this.description=e.readCString(),this.tags=e.readCString()}};xn.fourcc="udes";var gn=class extends l{constructor(){super(...arguments);this.box_name="UncompressedFrameConfigBox"}parse(e){if(this.parseFullHeader(e),this.profile=e.readString(4),this.version!==1){if(this.version===0){this.component_count=e.readUint32(),this.component_index=[],this.component_bit_depth_minus_one=[],this.component_format=[],this.component_align_size=[];for(let r=0;r<this.component_count;r++)this.component_index.push(e.readUint16()),this.component_bit_depth_minus_one.push(e.readUint8()),this.component_format.push(e.readUint8()),this.component_align_size.push(e.readUint8());this.sampling_type=e.readUint8(),this.interleave_type=e.readUint8(),this.block_size=e.readUint8();let i=e.readUint8();this.component_little_endian=i>>7&1,this.block_pad_lsb=i>>6&1,this.block_little_endian=i>>5&1,this.block_reversed=i>>4&1,this.pad_unknown=i>>3&1,this.pixel_size=e.readUint32(),this.row_align_size=e.readUint32(),this.tile_align_size=e.readUint32(),this.num_tile_cols_minus_one=e.readUint32(),this.num_tile_rows_minus_one=e.readUint32()}}}};gn.fourcc="uncC";var yn=class extends l{constructor(){super(...arguments);this.box_name="DataEntryUrnBox"}parse(e){this.parseFullHeader(e),this.name=e.readCString(),this.size-this.hdr_size-this.name.length-1>0&&(this.location=e.readCString())}write(e){this.version=0,this.flags=0,this.size=this.name.length+1+(this.location?this.location.length+1:0),this.writeHeader(e),e.writeCString(this.name),this.location&&e.writeCString(this.location)}};yn.fourcc="urn ";var Sn=class extends c{constructor(){super(...arguments);this.box_name="WebVTTConfigurationBox"}parse(e){this.text=e.readString(this.size-this.hdr_size)}};Sn.fourcc="vttC";var Bn=class extends l{constructor(){super(...arguments);this.box_name="VvcNALUConfigBox"}parse(e){this.parseFullHeader(e);let i=e.readUint8();this.lengthSizeMinusOne=i&3}};Bn.fourcc="vvnC";var Un=class extends x{parse(t){let e=t.readUint16();this.first_output_sample=t.readUint16(),this.sample_offset=[];for(let r=0;r<e;r++)this.sample_offset[r]=t.readUint32();let i=this.description_length-4-4*e;this.num_output_samples=[],this.num_total_samples=[];for(let r=0;r<i/4;r++)this.num_output_samples[r]=t.readUint16(),this.num_total_samples[r]=t.readUint16()}};Un.grouping_type="alst";var wn=class extends x{parse(t){this.layerNumber=t.readUint8(),this.accurateStatisticsFlag=t.readUint8(),this.avgBitRate=t.readUint16(),this.avgFrameRate=t.readUint16()}};wn.grouping_type="avll";var vn=class extends x{parse(t){this.subSequenceIdentifier=t.readUint16(),this.layerNumber=t.readUint8();let e=t.readUint8();this.durationFlag=e>>7,this.avgRateFlag=e>>6&1,this.durationFlag&&(this.duration=t.readUint32()),this.avgRateFlag&&(this.accurateStatisticsFlag=t.readUint8(),this.avgBitRate=t.readUint16(),this.avgFrameRate=t.readUint16()),this.dependency=[];let i=t.readUint8();for(let r=0;r<i;r++)this.dependency.push({subSeqDirectionFlag:t.readUint8(),layerNumber:t.readUint8(),subSequenceIdentifier:t.readUint16()})}};vn.grouping_type="avss";var An=class extends x{parse(t){u.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}};An.grouping_type="dtrt";var Mn=class extends x{parse(t){u.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}};Mn.grouping_type="mvif";var In=class extends x{parse(t){this.roll_distance=t.readInt16()}};In.grouping_type="prol";var zn=class extends x{parse(t){let e=t.readUint8();this.num_leading_samples_known=e>>7,this.num_leading_samples=e&127}};zn.grouping_type="rap ";var Tn=class extends x{parse(t){if(this.operation_point_count=t.readUint16(),this.description_length!==2+(this.operation_point_count===1?2:this.operation_point_count*6)+9)u.warn("BoxParser","Mismatch in "+this.grouping_type+" sample group length"),this.data=t.readUint8Array(this.description_length-2);else{if(this.operation_point_count===1)this.target_rate_share=t.readUint16();else{this.target_rate_share=[],this.available_bitrate=[];for(let e=0;e<this.operation_point_count;e++)this.available_bitrate[e]=t.readUint32(),this.target_rate_share[e]=t.readUint16()}this.maximum_bitrate=t.readUint32(),this.minimum_bitrate=t.readUint32(),this.discard_priority=t.readUint8()}}};Tn.grouping_type="rash";var kn=class extends x{parse(t){this.roll_distance=t.readInt16()}};kn.grouping_type="roll";var Fn=class extends x{parse(t){u.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}};Fn.grouping_type="scif";var En=class extends x{parse(t){u.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}};En.grouping_type="scnm";var Dn=class extends x{parse(t){this.reserved=t.readUint8();let e=t.readUint8();this.crypt_byte_block=e>>4,this.skip_byte_block=e&15,this.isProtected=t.readUint8(),this.Per_Sample_IV_Size=t.readUint8(),this.KID=G(t),this.constant_IV_size=0,this.constant_IV=0,this.isProtected===1&&this.Per_Sample_IV_Size===0&&(this.constant_IV_size=t.readUint8(),this.constant_IV=t.readUint8Array(this.constant_IV_size))}};Dn.grouping_type="seig";var Pn=class extends x{parse(t){u.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}};Pn.grouping_type="stsa";var Ln=class extends x{parse(t){let e=t.readUint8();this.NAL_unit_type=e&63}};Ln.grouping_type="sync";var Cn=class extends x{parse(t){let e=t.readUint8();this.level_independently_decodable=e>>7}};Cn.grouping_type="tele";var Nn=class extends x{parse(t){u.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}};Nn.grouping_type="tsas";var Rn=class extends x{parse(t){u.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}};Rn.grouping_type="tscl";var On=class extends x{parse(t){u.warn("BoxParser","Sample Group type: "+this.grouping_type+" not fully parsed")}};On.grouping_type="vipr";var Hn=class extends c{};Hn.fourcc="uuid";var X=class extends l{};X.fourcc="uuid";var Vn=class extends X{constructor(){super(...arguments);this.box_name="LiveServerManifestBox"}parse(e){this.parseFullHeader(e),this.LiveServerManifest=e.readString(this.size-this.hdr_size).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}};Vn.uuid="a5d40b30e81411ddba2f0800200c9a66";var Gn=class extends X{constructor(){super(...arguments);this.box_name="PiffProtectionSystemSpecificHeaderBox"}parse(e){this.parseFullHeader(e),this.system_id=G(e);let i=e.readUint32();i>0&&(this.data=e.readUint8Array(i))}};Gn.uuid="d08a4f1810f34a82b6c832d8aba183d3";var jn=class extends X{constructor(){super(...arguments);this.box_name="PiffSampleEncryptionBox"}};jn.uuid="a2394f525a9b4f14a2446c427c648df4";var Kn=class extends X{constructor(){super(...arguments);this.box_name="PiffTrackEncryptionBox"}parse(e){this.parseFullHeader(e),this.default_AlgorithmID=e.readUint24(),this.default_IV_size=e.readUint8(),this.default_KID=G(e)}};Kn.uuid="8974dbce7be74c5184f97148f9882554";var $n=class extends X{constructor(){super(...arguments);this.box_name="TfrfBox"}parse(e){this.parseFullHeader(e),this.fragment_count=e.readUint8(),this.entries=[];for(let i=0;i<this.fragment_count;i++){let r=0,s=0;this.version===1?(r=e.readUint64(),s=e.readUint64()):(r=e.readUint32(),s=e.readUint32()),this.entries.push({absolute_time:r,absolute_duration:s})}}};$n.uuid="d4807ef2ca3946958e5426cb9e46a79f";var qn=class extends X{constructor(){super(...arguments);this.box_name="TfxdBox"}parse(e){this.parseFullHeader(e),this.version===1?(this.absolute_time=e.readUint64(),this.duration=e.readUint64()):(this.absolute_time=e.readUint32(),this.duration=e.readUint32())}};qn.uuid="6d1d9b0542d544e680e2141daff757b2";var Yn=class extends Hn{constructor(){super(...arguments);this.box_name="ItemContentIDProperty"}parse(e){this.content_id=e.readCString()}};Yn.uuid="261ef3741d975bbaacbd9d2c8ea73522";var ea=Po(xo);Lo(fo);return Go(ta);})();
//# sourceMappingURL=mp4box.all.global.js.map